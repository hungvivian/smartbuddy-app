<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartBuddy - Smart Learning for Kids</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#5D5CDE">
    <meta name="description" content="AI-powered learning platform for kids K1-P6. Interactive quizzes, rewards system, and progress tracking.">
    <meta name="keywords" content="kids learning, education app, quiz games, children education, K1 K2 K3 Primary school">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json,{
        'name': 'SmartBuddy - Smart Learning for Kids',
        'short_name': 'SmartBuddy',
        'description': 'AI-powered learning platform for kids',
        'start_url': '/',
        'display': 'standalone',
        'background_color': '#ffffff',
        'theme_color': '#5D5CDE',
        'icons': [
            {
                'src': 'data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><text y=\".9em\" font-size=\"90\">ü§ñ</text></svg>',
                'sizes': '192x192',
                'type': 'image/svg+xml'
            },
            {
                'src': 'data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><text y=\".9em\" font-size=\"90\">ü§ñ</text></svg>',
                'sizes': '512x512',
                'type': 'image/svg+xml'
            }
        ]
    }">
    
    <!-- iOS PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SmartBuddy">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ñ</text></svg>">
    
    <!-- Favicons -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ñ</text></svg>">
    
    <!-- Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        .kid-friendly-bg {
            background: linear-gradient(135deg, 
                #FFF3E0 0%,   /* Warm cream */
                #FFE0B2 25%,  /* Light orange */
                #E1F5FE 50%,  /* Soft blue */
                #F3E5F5 75%,  /* Light purple */
                #E8F5E8 100%  /* Gentle green */
            );
            animation: gentle-float 6s ease-in-out infinite;
        }
        
        @keyframes gentle-float {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .cartoon-card {
            background: linear-gradient(145deg, 
                rgba(255, 255, 255, 0.9) 0%,
                rgba(255, 248, 240, 0.95) 100%
            );
            backdrop-filter: blur(10px);
            box-shadow: 
                0 20px 40px rgba(255, 165, 0, 0.15),
                0 8px 25px rgba(147, 51, 234, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
        
        .fun-button {
            background: linear-gradient(45deg, #FF9A56, #FF6B9D);
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3);
            transition: all 0.3s ease;
            border: none;
        }
        
        .fun-button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.4);
        }
        
        .secondary-button {
            background: linear-gradient(45deg, #4ECDC4, #45B7D1);
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }
        
        .secondary-button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(78, 205, 196, 0.4);
        }
        
        .robot-emoji {
            filter: drop-shadow(0 4px 8px rgba(255, 165, 0, 0.3));
            animation: bounce-robot 2s ease-in-out infinite;
        }
        
        @keyframes bounce-robot {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .star-decoration {
            animation: twinkle 3s ease-in-out infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        
        .floating-shapes {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }
        
        .shape {
            position: absolute;
            opacity: 0.1;
            animation: float 10s infinite ease-in-out;
        }
        
        .shape:nth-child(1) { left: 10%; animation-delay: 0s; }
        .shape:nth-child(2) { left: 20%; animation-delay: 2s; }
        .shape:nth-child(3) { left: 70%; animation-delay: 4s; }
        .shape:nth-child(4) { left: 80%; animation-delay: 6s; }
        
        @keyframes float {
            0%, 100% { transform: translateY(100vh) rotate(0deg); }
            50% { transform: translateY(-100vh) rotate(180deg); }
        }
        
        /* Dark Mode Styles */
        .dark {
            color-scheme: dark;
        }
        
        .dark .kid-friendly-bg {
            background: linear-gradient(135deg, 
                #1a1a2e 0%,   /* Dark navy */
                #16213e 25%,  /* Deep blue */
                #0f3460 50%,  /* Dark blue */
                #533483 75%,  /* Dark purple */
                #16537e 100%  /* Dark teal */
            );
        }
        
        .dark .cartoon-card {
            background: linear-gradient(145deg, 
                rgba(30, 30, 30, 0.95) 0%,
                rgba(40, 40, 40, 0.98) 100%
            );
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.3),
                0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .dark .bg-white {
            background-color: #2d2d2d !important;
        }
        
        .dark .text-gray-800 {
            color: #e5e5e5 !important;
        }
        
        .dark .text-gray-700 {
            color: #d1d1d1 !important;
        }
        
        .dark .text-gray-600 {
            color: #b8b8b8 !important;
        }
        
        .dark .text-gray-500 {
            color: #9ca3af !important;
        }
        
        .dark .bg-gray-50 {
            background-color: #374151 !important;
        }
        
        .dark .bg-gray-100 {
            background-color: #4b5563 !important;
        }
        
        .dark .bg-gray-200 {
            background-color: #6b7280 !important;
        }
        
        .dark .border-gray-200 {
            border-color: #4b5563 !important;
        }
        
        .dark .border-gray-300 {
            border-color: #6b7280 !important;
        }
        
        .dark header {
            background: rgba(30, 30, 30, 0.9) !important;
        }
        
        .dark .bg-blue-50 {
            background-color: #1e3a8a !important;
        }
        
        .dark .bg-green-50 {
            background-color: #166534 !important;
        }
        
        .dark .bg-yellow-50 {
            background-color: #a16207 !important;
        }
        
        .dark .bg-red-50 {
            background-color: #991b1b !important;
        }
        
        .dark .bg-purple-50 {
            background-color: #7c3aed !important;
        }
    </style>
</head>
<body class="font-sans kid-friendly-bg min-h-screen relative">
    
    <!-- Floating Background Shapes -->
    <div class="floating-shapes">
        <div class="shape text-6xl">üöÄ</div>
        <div class="shape text-5xl">‚≠ê</div>
        <div class="shape text-4xl">üéØ</div>
        <div class="shape text-5xl">üé®</div>
    </div>
    
    <!-- Welcome Screen -->
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="cartoon-card rounded-3xl p-8 w-full max-w-md text-center relative overflow-hidden">
            <!-- Decorative stars -->
            <div class="absolute top-4 left-4 star-decoration text-yellow-400 text-2xl">‚≠ê</div>
            <div class="absolute top-6 right-6 star-decoration text-pink-400 text-xl">‚ú®</div>
            <div class="absolute bottom-6 left-6 star-decoration text-blue-400 text-xl">üí´</div>
            
            <div class="robot-emoji text-6xl mb-4">ü§ñ</div>
            <h1 class="text-3xl font-bold text-orange-600 mb-2">ü§ñ SmartBuddy</h1>
            <h2 class="text-xl font-semibold text-blue-500 mb-4">Êô∫Â≠¶ÂÆù</h2>
            <p class="text-gray-700 mb-2 font-medium">AI-Powered Smart Learning Platform</p>
            <p class="text-gray-600 mb-6 text-sm">AIÊô∫ËÉΩÂ≠¶‰π†Âπ≥Âè∞<br>Testing Airtable Connection...</p>
            
            <div id="connectionStatus" class="p-4 rounded-lg mb-6 bg-blue-50">
                <div class="text-lg font-semibold text-blue-800">üîÑ Testing Connection...</div>
                <div class="text-sm text-blue-600 mt-2">Please wait while we connect to your Airtable database</div>
            </div>
            
            <div class="space-y-4">
                <button onclick="testConnection()" class="w-full fun-button text-white py-3 px-6 rounded-xl font-semibold">
                    üîÑ Test Again
                </button>
                <button onclick="showFullApp()" class="w-full secondary-button text-white py-3 px-6 rounded-xl font-semibold">
                    üì± View Full App Demo
                </button>
            </div>
            
            <div class="mt-6 text-center">
                <p class="text-sm text-gray-500">
                    ü§ñ Next-Generation Learning Technology<br>
                    Powered by AI & Gamification
                </p>
            </div>
        </div>
    </div>

    <script>
        // Your Airtable credentials
        const AIRTABLE_CONFIG = {
            baseId: 'appzbq4Zom94iCItg',
            apiKey: 'pat5tRFkAevnxWSCb.df7ccb343bab79699520ba7704fbd86b2a8d99a9678715a432b8f7fbf7587c70'
        };

        // Stripe configuration - LIVE PRICE IDs FROM YOUR STRIPE DASHBOARD
        const STRIPE_PRICES = {
            premiumMonthly: 'price_1RWwAMJA1KZZIeB2GEK05Jnf',    // Monthly Subscription Fee (HK$78/month)
            premiumAnnual: 'price_1RWwBNJA1KZZIeB2RT3v0FN9'      // Annual Subscription Fee (HK$780/year - 2 months FREE!)
        };

        // Test Airtable connection
        async function testConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            
            try {
                statusDiv.innerHTML = `
                    <div class="text-lg font-semibold text-blue-800">üîÑ Testing Connection...</div>
                    <div class="text-sm text-blue-600 mt-2">Connecting to Base ID: ${AIRTABLE_CONFIG.baseId.substring(0, 10)}...</div>
                `;

                // Test Questions table
                const questionsUrl = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/Questions`;
                console.log('Testing URL:', questionsUrl);
                
                const response = await fetch(questionsUrl, {
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (response.ok) {
                    const data = await response.json();
                    const recordCount = data.records ? data.records.length : 0;
                    
                    console.log('Data received:', data);
                    console.log('Record count:', recordCount);

                    if (recordCount > 0) {
                        // SUCCESS - Found data
                        statusDiv.innerHTML = `
                            <div class="text-lg font-semibold text-green-800">‚úÖ CONNECTION SUCCESS!</div>
                            <div class="text-sm text-green-600 mt-2">
                                üìä Found ${recordCount} questions in your database<br>
                                üéâ Your Airtable is working perfectly!
                            </div>
                        `;
                        statusDiv.className = 'p-4 rounded-lg mb-6 bg-green-50';
                        
                        // Show success alert
                        setTimeout(() => {
                            alert(`üéâ FANTASTIC!\n\nYour Airtable connection is working!\n\nüìä Data found:\n‚Ä¢ ${recordCount} questions in your database\n‚Ä¢ Base ID: ${AIRTABLE_CONFIG.baseId}\n‚Ä¢ Connection: Successful\n\n‚úÖ Next steps:\n1. Add more questions to Airtable\n2. Create Gifts table\n3. Deploy to live domain\n4. Set up Stripe payments`);
                        }, 1000);
                    } else {
                        // SUCCESS but no data
                        statusDiv.innerHTML = `
                            <div class="text-lg font-semibold text-yellow-800">‚ö†Ô∏è CONNECTED BUT EMPTY</div>
                            <div class="text-sm text-yellow-600 mt-2">
                                ‚úÖ Connection works, but no questions found<br>
                                üìù Please add data to your Questions table
                            </div>
                        `;
                        statusDiv.className = 'p-4 rounded-lg mb-6 bg-yellow-50';
                        
                        setTimeout(() => {
                            alert(`‚ö†Ô∏è CONNECTION WORKS BUT NO DATA\n\nYour Airtable connection is successful!\n\nBut your Questions table is empty (${recordCount} records)\n\nüìã To fix this:\n1. Go to your Airtable base\n2. Import the CSV file I provided earlier\n3. Make sure table is named 'Questions'\n4. Test again`);
                        }, 1000);
                    }
                } else {
                    // Connection failed
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    
                    if (response.status === 401) {
                        statusDiv.innerHTML = `
                            <div class="text-lg font-semibold text-red-800">üîë API KEY EXPIRED</div>
                            <div class="text-sm text-red-600 mt-2">
                                Your Airtable API key needs to be updated<br>
                                üìã Please generate a new API key from Airtable
                            </div>
                        `;
                        statusDiv.className = 'p-4 rounded-lg mb-6 bg-red-50';
                    } else {
                        statusDiv.innerHTML = `
                            <div class="text-lg font-semibold text-red-800">‚ùå CONNECTION FAILED</div>
                            <div class="text-sm text-red-600 mt-2">
                                Error ${response.status}: ${response.statusText}<br>
                                Check your credentials and table setup
                            </div>
                        `;
                        statusDiv.className = 'p-4 rounded-lg mb-6 bg-red-50';
                    }
                    
                    setTimeout(() => {
                        statusDiv.innerHTML = `
                            <div class="text-lg font-semibold text-blue-800">üéÆ SWITCHING TO DEMO MODE!</div>
                            <div class="text-sm text-blue-600 mt-2">
                                ‚ú® App will work with sample questions<br>
                                üéØ All features available for testing
                            </div>
                        `;
                        statusDiv.className = 'p-4 rounded-lg mb-6 bg-blue-50';
                    }, 2500);
                }

            } catch (error) {
                console.error('Network error:', error);
                
                statusDiv.innerHTML = `
                    <div class="text-lg font-semibold text-red-800">‚ùå NETWORK ERROR</div>
                    <div class="text-sm text-red-600 mt-2">
                        ${error.message}<br>
                        Check your internet connection
                    </div>
                `;
                statusDiv.className = 'p-4 rounded-lg mb-6 bg-red-50';
                
                setTimeout(() => {
                    alert(`‚ùå NETWORK ERROR\n\nError: ${error.message}\n\nüîç Check:\n1. Internet connection\n2. Browser permissions\n3. Firewall settings\n4. Try refreshing the page`);
                }, 1000);
            }
        }

        // Show full app demo
        function showFullApp() {
            // Hide welcome screen and show main app
            document.body.innerHTML = `
                ${document.head.outerHTML}
                <body class="font-sans kid-friendly-bg min-h-screen relative">
                    <!-- Floating Background Shapes -->
                    <div class="floating-shapes">
                        <div class="shape text-6xl">üöÄ</div>
                        <div class="shape text-5xl">‚≠ê</div>
                        <div class="shape text-4xl">üéØ</div>
                        <div class="shape text-5xl">üé®</div>
                    </div>
                    
                    <!-- Header -->
                    <header class="bg-white/90 backdrop-blur-sm shadow-lg sticky top-0 z-50">
                        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="robot-emoji text-3xl">ü§ñ</div>
                                <div id="appHeader">
                                    <h1 class="text-xl font-bold text-orange-600">SmartBuddy</h1>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-purple-600" id="userPoints">0</div>
                                    <div class="text-xs text-gray-600">Points</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-600" id="userLevel">1</div>
                                    <div class="text-xs text-gray-600">Level</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl" id="streakFire">üî•</div>
                                    <div class="text-xs text-gray-600" id="streakCount">0 day streak</div>
                                </div>
                                <button onclick="showWelcome()" class="bg-gradient-to-r from-green-400 to-emerald-500 hover:from-green-500 hover:to-emerald-600 text-white w-12 h-12 rounded-full transition-all duration-300 hover:transform hover:scale-105 flex items-center justify-center text-2xl">
                                    üè†
                                </button>
                                <button onclick="showSettings()" class="bg-white hover:bg-gray-50 text-gray-600 border-2 border-gray-200 hover:border-gray-300 w-12 h-12 rounded-full transition-all duration-300 hover:transform hover:scale-105 flex items-center justify-center text-3xl shadow-sm">
                                    ‚öôÔ∏è
                                </button>
                            </div>
                        </div>
                    </header>

                    <!-- Main Content -->
                    <main class="max-w-6xl mx-auto px-4 py-8">
                        <!-- Welcome Section -->
                        <section id="welcomeSection" class="text-center mb-8">
                            <div class="cartoon-card rounded-3xl p-8 mb-8">
                                <h2 class="text-3xl font-bold text-gray-800 mb-4">
                                    Welcome to SmartBuddy! ü§ñ
                                </h2>
                                <p class="text-gray-600 mb-6">
                                    Ready to learn and earn points? Choose your learning adventure!
                                </p>
                                
                                <!-- Grade Selection -->
                                <div class="mb-6">
                                    <label class="block text-lg font-semibold mb-3 text-gray-800">Please select your grade level:</label>
                                    <select id="gradeSelect" class="w-full text-base px-4 py-3 rounded-xl border-2 border-purple-200 focus:border-purple-400 bg-white text-gray-800" onchange="saveSelectedGrade()">
                                        <option value="">Choose your grade...</option>
                                        <option value="K1">üé® K1 (Ages 3-4)</option>
                                        <option value="K2">üåà K2 (Ages 4-5)</option>
                                        <option value="K3">üé≠ K3 (Ages 5-6)</option>
                                        <option value="Primary 1">üìö Primary 1</option>
                                        <option value="Primary 2">üî¢ Primary 2</option>
                                        <option value="Primary3">üß™ Primary 3</option>
                                        <option value="Primary4">üåü Primary 4</option>
                                        <option value="Primary5">üöÄ Primary 5</option>
                                        <option value="Primary6">üèÜ Primary 6</option>
                                    </select>
                                </div>

                                <!-- Subject Selection -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                    <button onclick="startQuiz('Math')" class="fun-button text-white py-4 px-6 rounded-xl font-semibold flex items-center justify-center space-x-2 transition-all duration-300 hover:transform hover:scale-105">
                                        <span class="text-2xl">üî¢</span>
                                        <span>Math</span>
                                    </button>
                                    <button onclick="startQuiz('English')" class="secondary-button text-white py-4 px-6 rounded-xl font-semibold flex items-center justify-center space-x-2 transition-all duration-300 hover:transform hover:scale-105">
                                        <span class="text-2xl">üìö</span>
                                        <span>English</span>
                                    </button>
                                    <button onclick="startQuiz('Science')" class="bg-gradient-to-r from-green-400 to-emerald-500 hover:from-green-500 hover:to-emerald-600 text-white py-4 px-6 rounded-xl font-semibold flex items-center justify-center space-x-2 transition-all duration-300 hover:transform hover:scale-105">
                                        <span class="text-2xl">üß™</span>
                                        <span>Science</span>
                                    </button>
                                </div>

                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                    <button onclick="showAvatarHome()" class="group relative overflow-hidden bg-gradient-to-br from-emerald-400 via-teal-400 to-cyan-500 hover:from-emerald-500 hover:via-teal-500 hover:to-cyan-600 text-white py-6 px-6 rounded-2xl font-bold text-lg shadow-lg hover:shadow-xl transition-all duration-300 hover:transform hover:scale-105 border-2 border-white/20">
                                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                                        <div class="relative z-10 flex flex-col items-center space-y-2">
                                            <div class="text-3xl">üè†</div>
                                            <div>My Home</div>
                                        </div>
                                    </button>
                                    <button onclick="showMiniGames()" class="group relative overflow-hidden bg-gradient-to-br from-pink-400 via-purple-400 to-red-500 hover:from-pink-500 hover:via-purple-500 hover:to-red-600 text-white py-6 px-6 rounded-2xl font-bold text-lg shadow-lg hover:shadow-xl transition-all duration-300 hover:transform hover:scale-105 border-2 border-white/20">
                                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                                        <div class="relative z-10 flex flex-col items-center space-y-2">
                                            <div class="text-3xl">üéÆ</div>
                                            <div>Mini Games</div>
                                        </div>
                                    </button>
                                    <button onclick="showRewards()" class="group relative overflow-hidden bg-gradient-to-br from-yellow-400 via-orange-400 to-amber-500 hover:from-yellow-500 hover:via-orange-500 hover:to-amber-600 text-white py-6 px-6 rounded-2xl font-bold text-lg shadow-lg hover:shadow-xl transition-all duration-300 hover:transform hover:scale-105 border-2 border-white/20">
                                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                                        <div class="relative z-10 flex flex-col items-center space-y-2">
                                            <div class="text-3xl">üéÅ</div>
                                            <div>View Rewards</div>
                                        </div>
                                    </button>
                                    <button onclick="showProgress()" class="group relative overflow-hidden bg-gradient-to-br from-indigo-400 via-blue-400 to-purple-500 hover:from-indigo-500 hover:via-blue-500 hover:to-purple-600 text-white py-6 px-6 rounded-2xl font-bold text-lg shadow-lg hover:shadow-xl transition-all duration-300 hover:transform hover:scale-105 border-2 border-white/20">
                                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                                        <div class="relative z-10 flex flex-col items-center space-y-2">
                                            <div class="text-3xl">üìä</div>
                                            <div>My Progress</div>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        </section>

                        <!-- Quiz Section -->
                        <section id="quizSection" class="hidden">
                            <div class="cartoon-card rounded-3xl p-8">
                                <!-- Quiz Header -->
                                <div class="flex justify-between items-center mb-6">
                                    <div class="flex items-center space-x-3">
                                        <span id="subjectEmoji" class="text-3xl">üî¢</span>
                                        <div>
                                            <h3 id="quizTitle" class="text-2xl font-bold text-gray-800">Math Quiz</h3>
                                            <p id="quizGrade" class="text-gray-600">Grade 1</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm text-gray-600">Question</div>
                                        <div class="text-xl font-bold" id="questionProgress">1 / 5</div>
                                    </div>
                                </div>

                                <!-- Progress Bar -->
                                <div class="w-full bg-gray-200 rounded-full h-3 mb-6">
                                    <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all duration-500" style="width: 20%"></div>
                                </div>

                                <!-- Question Display -->
                                <div class="mb-8">
                                    <h4 id="questionText" class="text-xl font-semibold text-gray-800 mb-6">
                                        Loading question...
                                    </h4>
                                    
                                    <!-- Answer Options -->
                                    <div id="answerOptions" class="space-y-3">
                                        <!-- Options will be inserted here -->
                                    </div>
                                </div>

                                <!-- Quiz Controls -->
                                <div class="flex justify-between">
                                    <button onclick="showWelcome()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg">
                                        üè† Back to Home
                                    </button>
                                    <button id="nextButton" onclick="nextQuestion()" class="fun-button text-white py-2 px-6 rounded-lg opacity-50 cursor-not-allowed" disabled style="display: block;">
                                        Next Question ‚û°Ô∏è
                                    </button>
                                </div>
                            </div>
                        </section>

                        <!-- Results Section -->
                        <section id="resultsSection" class="hidden">
                            <div class="cartoon-card rounded-3xl p-8 text-center">
                                <div class="text-6xl mb-4" id="resultEmoji">üéâ</div>
                                <h3 class="text-3xl font-bold text-gray-800 mb-4" id="resultTitle">Level Completed!</h3>
                                <div class="bg-gradient-to-r from-yellow-100 to-orange-100 rounded-2xl p-6 mb-6">
                                    <div class="text-4xl font-bold text-orange-600 mb-2" id="finalScore">0 / 5</div>
                                    <div class="text-lg text-gray-700 mb-3" id="pointsEarned">+0 Points</div>
                                </div>
                                
                                <!-- AI Feedback -->
                                <div id="aiFeedback" class="bg-blue-50 rounded-xl p-4 mb-6">
                                    <div class="flex items-center justify-center mb-2">
                                        <span class="text-2xl mr-2">ü§ñ</span>
                                        <span class="font-semibold text-blue-800">SmartBuddy AI Says:</span>
                                    </div>
                                    <p id="aiMessage" class="text-blue-700">Analyzing your performance...</p>
                                </div>

                                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                                    <button onclick="startQuiz(currentSubject)" class="fun-button text-white py-3 px-6 rounded-xl font-semibold">
                                        üîÑ Try Again
                                    </button>
                                    <button onclick="showWelcome()" class="secondary-button text-white py-3 px-6 rounded-xl font-semibold">
                                        üè† Back to Home
                                    </button>
                                    <button onclick="showRewards()" class="bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-white py-3 px-6 rounded-xl font-semibold">
                                        üéÅ Spend Points
                                    </button>
                                </div>
                            </div>
                        </section>

                        <!-- Mini Games Section -->
                        <section id="miniGamesSection" class="hidden">
                            <div class="cartoon-card rounded-3xl p-8">
                                <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">üéÆ Mini Games Arcade</h3>
                                <p class="text-center text-gray-600 mb-8">Play fun games and earn bonus points!</p>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                                    <!-- Memory Match Game -->
                                    <div class="cartoon-card rounded-2xl p-6 text-center hover:transform hover:scale-105 transition-all duration-200 cursor-pointer" onclick="startMemoryGame()">
                                        <div class="text-5xl mb-3">üß†</div>
                                        <h4 class="text-lg font-bold text-gray-800 mb-2">Memory Match</h4>
                                        <p class="text-sm text-gray-600 mb-3">Match pairs of cards</p>
                                        <div class="text-sm font-bold text-green-600">+3-5 Points</div>
                                    </div>

                                    <!-- Math Sprint Game -->
                                    <div class="cartoon-card rounded-2xl p-6 text-center hover:transform hover:scale-105 transition-all duration-200 cursor-pointer" onclick="startMathSprint()">
                                        <div class="text-5xl mb-3">‚ö°</div>
                                        <h4 class="text-lg font-bold text-gray-800 mb-2">Math Sprint</h4>
                                        <p class="text-sm text-gray-600 mb-3">Quick math problems</p>
                                        <div class="text-sm font-bold text-green-600">+2-4 Points</div>
                                    </div>

                                    <!-- Word Builder Game -->
                                    <div class="cartoon-card rounded-2xl p-6 text-center hover:transform hover:scale-105 transition-all duration-200 cursor-pointer" onclick="startWordBuilder()">
                                        <div class="text-5xl mb-3">üî§</div>
                                        <h4 class="text-lg font-bold text-gray-800 mb-2">Word Builder</h4>
                                        <p class="text-sm text-gray-600 mb-3">Build words from letters</p>
                                        <div class="text-sm font-bold text-green-600">+3-6 Points</div>
                                    </div>

                                    <!-- Pattern Puzzle Game -->
                                    <div class="cartoon-card rounded-2xl p-6 text-center hover:transform hover:scale-105 transition-all duration-200 cursor-pointer" onclick="startPatternPuzzle()">
                                        <div class="text-5xl mb-3">üß©</div>
                                        <h4 class="text-lg font-bold text-gray-800 mb-2">Pattern Puzzle</h4>
                                        <p class="text-sm text-gray-600 mb-3">Complete the pattern</p>
                                        <div class="text-sm font-bold text-green-600">+4-7 Points</div>
                                    </div>

                                    <!-- Color Match Game -->
                                    <div class="cartoon-card rounded-2xl p-6 text-center hover:transform hover:scale-105 transition-all duration-200 cursor-pointer" onclick="startColorMatch()">
                                        <div class="text-5xl mb-3">üé®</div>
                                        <h4 class="text-lg font-bold text-gray-800 mb-2">Color Match</h4>
                                        <p class="text-sm text-gray-600 mb-3">Match the colors</p>
                                        <div class="text-sm font-bold text-green-600">+2-5 Points</div>
                                    </div>

                                    <!-- Quick Reflex Game -->
                                    <div class="cartoon-card rounded-2xl p-6 text-center hover:transform hover:scale-105 transition-all duration-200 cursor-pointer" onclick="startQuickReflex()">
                                        <div class="text-5xl mb-3">‚ö°</div>
                                        <h4 class="text-lg font-bold text-gray-800 mb-2">Quick Reflex</h4>
                                        <p class="text-sm text-gray-600 mb-3">Test your speed</p>
                                        <div class="text-sm font-bold text-green-600">+1-3 Points</div>
                                    </div>

                                    <!-- Logic Puzzle Game (Primary 4-6) -->
                                    <div class="cartoon-card rounded-2xl p-6 text-center hover:transform hover:scale-105 transition-all duration-200 cursor-pointer" onclick="startLogicPuzzle()">
                                        <div class="text-5xl mb-3">üß†</div>
                                        <h4 class="text-lg font-bold text-gray-800 mb-2">Logic Puzzle</h4>
                                        <p class="text-sm text-gray-600 mb-3">Solve complex reasoning challenges</p>
                                        <div class="text-sm font-bold text-green-600">+5-10 Points</div>
                                    </div>

                                    <!-- Math Challenge Game (Primary 4-6) -->
                                    <div class="cartoon-card rounded-2xl p-6 text-center hover:transform hover:scale-105 transition-all duration-200 cursor-pointer" onclick="startMathChallenge()">
                                        <div class="text-5xl mb-3">üî¢</div>
                                        <h4 class="text-lg font-bold text-gray-800 mb-2">Math Challenge</h4>
                                        <p class="text-sm text-gray-600 mb-3">Advanced math problems</p>
                                        <div class="text-sm font-bold text-green-600">+7-12 Points</div>
                                    </div>

                                    <!-- Strategy Game (Primary 5-6) -->
                                    <div class="cartoon-card rounded-2xl p-6 text-center hover:transform hover:scale-105 transition-all duration-200 cursor-pointer" onclick="startStrategyGame()">
                                        <div class="text-5xl mb-3">‚ôüÔ∏è</div>
                                        <h4 class="text-lg font-bold text-gray-800 mb-2">Strategy Master</h4>
                                        <p class="text-sm text-gray-600 mb-3">Strategic thinking challenges</p>
                                        <div class="text-sm font-bold text-green-600">+8-15 Points</div>
                                    </div>

                                    <!-- Code Breaking Game (Primary 6) -->
                                    <div class="cartoon-card rounded-2xl p-6 text-center hover:transform hover:scale-105 transition-all duration-200 cursor-pointer" onclick="startCodeBreaking()">
                                        <div class="text-5xl mb-3">üîì</div>
                                        <h4 class="text-lg font-bold text-gray-800 mb-2">Code Breaking</h4>
                                        <p class="text-sm text-gray-600 mb-3">Crack secret codes and ciphers</p>
                                        <div class="text-sm font-bold text-green-600">+10-20 Points</div>
                                    </div>
                                </div>
                                
                                <div class="text-center">
                                    <button onclick="showWelcome()" class="secondary-button text-white py-3 px-6 rounded-xl font-semibold">
                                        üè† Back to Home
                                    </button>
                                </div>
                            </div>
                        </section>

                        <!-- Game Play Section -->
                        <section id="gamePlaySection" class="hidden">
                            <div class="cartoon-card rounded-3xl p-8">
                                <div class="flex justify-between items-center mb-6">
                                    <div class="flex items-center space-x-3">
                                        <span id="gameEmoji" class="text-3xl">üéÆ</span>
                                        <div>
                                            <h3 id="gameTitle" class="text-2xl font-bold text-gray-800">Mini Game</h3>
                                            <p id="gameInstructions" class="text-gray-600">Game instructions will appear here</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm text-gray-600">Score</div>
                                        <div class="text-xl font-bold text-purple-600" id="gameScore">0</div>
                                    </div>
                                </div>

                                <!-- Game Area -->
                                <div id="gameArea" class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl p-6 mb-6 min-h-64">
                                    <!-- Game content will be inserted here -->
                                </div>

                                <!-- Game Controls -->
                                <div class="flex justify-between">
                                    <button onclick="showMiniGames()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg">
                                        ‚¨ÖÔ∏è Back to Games
                                    </button>
                                    <button id="gameActionButton" class="fun-button text-white py-2 px-6 rounded-lg">
                                        üéÆ Start Game
                                    </button>
                                </div>
                            </div>
                        </section>

                        <!-- Rewards Section -->
                        <section id="rewardsSection" class="hidden">
                            <div class="cartoon-card rounded-3xl p-8">
                                <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">üéÅ Rewards Store</h3>
                                <div id="rewardsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    <!-- Rewards will be loaded here -->
                                </div>
                                <div class="text-center mt-8">
                                    <button onclick="showWelcome()" class="secondary-button text-white py-3 px-6 rounded-xl font-semibold">
                                        üè† Back to Home
                                    </button>
                                </div>
                            </div>
                        </section>

                        <!-- Progress Section -->
                        <section id="progressSection" class="hidden">
                            <div class="cartoon-card rounded-3xl p-8">
                                <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">üìä My Learning Journey</h3>
                                
                                <!-- Progress Stats Cards -->
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                                    <!-- Level Card -->
                                    <div class="bg-gradient-to-br from-purple-100 to-pink-100 rounded-2xl p-6 text-center">
                                        <div class="text-5xl mb-3">üèÜ</div>
                                        <h4 class="text-2xl font-bold text-purple-600 mb-2" id="progressLevel">Level 1</h4>
                                        <p class="text-gray-600" id="progressStage">Brilliant Starter</p>
                                    </div>

                                    <!-- Points Card -->
                                    <div class="bg-gradient-to-br from-yellow-100 to-orange-100 rounded-2xl p-6 text-center">
                                        <div class="text-5xl mb-3">‚≠ê</div>
                                        <h4 class="text-2xl font-bold text-orange-600 mb-2" id="progressPoints">0 Points</h4>
                                        <p class="text-gray-600">Total Earned</p>
                                    </div>

                                    <!-- Streak Card -->
                                    <div class="bg-gradient-to-br from-red-100 to-orange-100 rounded-2xl p-6 text-center">
                                        <div class="text-5xl mb-3">üî•</div>
                                        <h4 class="text-2xl font-bold text-red-600 mb-2" id="progressStreak">1 Day</h4>
                                        <p class="text-gray-600">Learning Streak</p>
                                    </div>
                                </div>

                                <!-- Fun Learning Stats -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                    <!-- Quiz Stats -->
                                    <div class="bg-gradient-to-br from-blue-100 to-indigo-100 rounded-2xl p-6">
                                        <h4 class="text-xl font-bold text-blue-600 mb-4 flex items-center">
                                            <span class="text-2xl mr-2">üìö</span>
                                            Quiz Progress
                                        </h4>
                                        <div class="space-y-3">
                                            <div class="flex justify-between items-center">
                                                <span class="text-gray-600">Questions Answered:</span>
                                                <span class="font-bold text-blue-600" id="progressQuestionsAnswered">0</span>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-gray-600">Correct Answers:</span>
                                                <span class="font-bold text-green-600" id="progressCorrectAnswers">0</span>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-gray-600">Accuracy Rate:</span>
                                                <span class="font-bold text-purple-600" id="progressAccuracy">0%</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Level Progress -->
                                    <div class="bg-gradient-to-br from-green-100 to-emerald-100 rounded-2xl p-6">
                                        <h4 class="text-xl font-bold text-green-600 mb-4 flex items-center">
                                            <span class="text-2xl mr-2">üéØ</span>
                                            Next Level Progress
                                        </h4>
                                        <div class="space-y-3">
                                            <div class="flex justify-between items-center">
                                                <span class="text-gray-600">Current Level:</span>
                                                <span class="font-bold text-green-600" id="progressCurrentLevel">1</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-4 mb-2">
                                                <div id="levelProgressBar" class="bg-gradient-to-r from-green-400 to-emerald-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                                            </div>
                                            <div class="flex justify-between text-sm text-gray-600">
                                                <span id="pointsToNextLevel">Need 100 points for Level 2</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                                    <button onclick="showRewards()" class="bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-white py-3 px-6 rounded-xl font-semibold transition-all duration-300 hover:transform hover:scale-105">
                                        üéÅ Get Rewards
                                    </button>
                                    <button onclick="showWelcome()" class="secondary-button text-white py-3 px-6 rounded-xl font-semibold">
                                        üè† Back to Home
                                    </button>
                                </div>
                            </div>
                        </section>

                        <!-- Admin Dashboard Section -->
                        <section id="adminDashboardSection" class="hidden">
                            <div class="cartoon-card rounded-3xl p-8">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="text-3xl font-bold text-gray-800">üîß Admin Dashboard</h3>
                                    <button onclick="refreshAdminData()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold">
                                        üîÑ Refresh Data
                                    </button>
                                </div>
                                
                                <!-- Admin Stats Cards -->
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                                    <!-- Total Users -->
                                    <div class="bg-gradient-to-br from-blue-100 to-indigo-100 rounded-2xl p-6 text-center">
                                        <div class="text-4xl mb-3">üë•</div>
                                        <h4 class="text-2xl font-bold text-blue-600 mb-2" id="adminTotalUsers">1</h4>
                                        <p class="text-gray-600">Total Users</p>
                                    </div>

                                    <!-- Pending Rewards -->
                                    <div class="bg-gradient-to-br from-orange-100 to-red-100 rounded-2xl p-6 text-center">
                                        <div class="text-4xl mb-3">üì¶</div>
                                        <h4 class="text-2xl font-bold text-orange-600 mb-2" id="adminPendingRewards">0</h4>
                                        <p class="text-gray-600">Pending Rewards</p>
                                    </div>

                                    <!-- Monthly Revenue -->
                                    <div class="bg-gradient-to-br from-green-100 to-emerald-100 rounded-2xl p-6 text-center">
                                        <div class="text-4xl mb-3">üí∞</div>
                                        <h4 class="text-2xl font-bold text-green-600 mb-2" id="adminRevenue">$0</h4>
                                        <p class="text-gray-600">Monthly Revenue</p>
                                    </div>

                                    <!-- Premium Users -->
                                    <div class="bg-gradient-to-br from-purple-100 to-pink-100 rounded-2xl p-6 text-center">
                                        <div class="text-4xl mb-3">üëë</div>
                                        <h4 class="text-2xl font-bold text-purple-600 mb-2" id="adminPremiumUsers">0</h4>
                                        <p class="text-gray-600">Premium Users</p>
                                    </div>
                                </div>

                                <!-- Tabs Navigation -->
                                <div class="flex space-x-4 mb-6 overflow-x-auto">
                                    <button onclick="showAdminTab('pending')" id="adminTabPending" class="admin-tab-btn bg-blue-500 text-white py-2 px-4 rounded-lg font-semibold whitespace-nowrap">
                                        üì¶ Pending Rewards (0)
                                    </button>
                                    <button onclick="showAdminTab('completed')" id="adminTabCompleted" class="admin-tab-btn bg-gray-300 text-gray-700 py-2 px-4 rounded-lg font-semibold whitespace-nowrap">
                                        ‚úÖ Completed Orders
                                    </button>
                                    <button onclick="showAdminTab('users')" id="adminTabUsers" class="admin-tab-btn bg-gray-300 text-gray-700 py-2 px-4 rounded-lg font-semibold whitespace-nowrap">
                                        üë• User Management
                                    </button>
                                    <button onclick="showAdminTab('analytics')" id="adminTabAnalytics" class="admin-tab-btn bg-gray-300 text-gray-700 py-2 px-4 rounded-lg font-semibold whitespace-nowrap">
                                        üìä Analytics
                                    </button>
                                    <button onclick="showAdminTab('settings')" id="adminTabSettings" class="admin-tab-btn bg-gray-300 text-gray-700 py-2 px-4 rounded-lg font-semibold whitespace-nowrap">
                                        ‚öôÔ∏è System Settings
                                    </button>
                                </div>

                                <!-- Tab Contents -->
                                <div id="adminTabContent">
                                    <!-- Content will be loaded here -->
                                </div>

                                <!-- Back to App Button -->
                                <div class="text-center mt-8">
                                    <button onclick="showWelcome()" class="secondary-button text-white py-3 px-6 rounded-xl font-semibold">
                                        üè† Back to App
                                    </button>
                                </div>
                            </div>
                        </section>

                        <!-- Avatar Home Section -->
                        <section id="avatarHomeSection" class="hidden">
                            <div class="cartoon-card rounded-3xl p-8">
                                <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">üè† My Smart Home</h3>
                                
                                <!-- Avatar Display -->
                                <div class="bg-gradient-to-br from-sky-100 to-blue-200 rounded-3xl p-8 mb-8 relative overflow-hidden" id="avatarRoom">
                                    <!-- Room Background -->
                                    <div class="absolute inset-0 bg-gradient-to-br from-yellow-200 to-orange-200 opacity-60" id="roomWallpaper"></div>
                                    
                                    <!-- Furniture -->
                                    <div class="relative z-10 flex flex-col items-center justify-center min-h-64">
                                        <!-- Avatar Character -->
                                        <div class="mb-4 text-8xl animate-bounce" id="avatarCharacter">üßí</div>
                                        
                                        <!-- Room Furniture -->
                                        <div class="absolute bottom-4 left-4 text-6xl" id="roomBed">üõèÔ∏è</div>
                                        <div class="absolute bottom-4 right-4 text-5xl" id="roomDesk">üìö</div>
                                        <div class="absolute top-4 left-8 text-4xl" id="roomDecoration">üå±</div>
                                    </div>
                                </div>
                                
                                <!-- Customization Tabs -->
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                    <button onclick="showCustomizeTab('avatar')" id="tabAvatar" class="customize-tab bg-purple-500 text-white py-3 px-4 rounded-xl font-semibold">
                                        üë§ Avatar
                                    </button>
                                    <button onclick="showCustomizeTab('room')" id="tabRoom" class="customize-tab bg-gray-300 text-gray-700 py-3 px-4 rounded-xl font-semibold">
                                        üè† Room
                                    </button>
                                    <button onclick="showCustomizeTab('furniture')" id="tabFurniture" class="customize-tab bg-gray-300 text-gray-700 py-3 px-4 rounded-xl font-semibold">
                                        ü™ë Furniture
                                    </button>
                                    <button onclick="showCustomizeTab('inventory')" id="tabInventory" class="customize-tab bg-gray-300 text-gray-700 py-3 px-4 rounded-xl font-semibold">
                                        üéÅ Inventory
                                    </button>
                                </div>
                                
                                <!-- Customization Content -->
                                <div id="customizeContent" class="bg-white rounded-2xl p-6 mb-6">
                                    <!-- Content will be loaded here -->
                                </div>
                                
                                <!-- Navigation -->
                                <div class="text-center">
                                    <button onclick="showWelcome()" class="secondary-button text-white py-3 px-6 rounded-xl font-semibold">
                                        üè† Back to Home
                                    </button>
                                </div>
                            </div>
                        </section>

                        <!-- Settings Section -->
                        <section id="settingsSection" class="hidden">
                            <div class="cartoon-card rounded-3xl p-8">
                                <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">Settings</h3>
                                
                                <!-- Language Settings -->
                                <div class="bg-gradient-to-br from-blue-100 to-indigo-100 rounded-2xl p-6 mb-6">
                                    <h4 class="text-xl font-bold text-blue-600 mb-4 flex items-center">
                                        <span class="text-2xl mr-2">üåç</span>
                                        Language / ËØ≠Ë®ÄËÆæÁΩÆ
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <button onclick="setLanguage('english')" id="langEn" class="language-btn bg-white border-2 border-blue-200 hover:border-blue-400 p-4 rounded-xl text-center transition-all duration-200">
                                            <div class="font-semibold text-gray-800">English</div>
                                        </button>
                                        <button onclick="setLanguage('traditional')" id="langZhTW" class="language-btn bg-white border-2 border-blue-200 hover:border-blue-400 p-4 rounded-xl text-center transition-all duration-200">
                                            <div class="font-semibold text-gray-800">ÁπÅÈ´î‰∏≠Êñá</div>
                                        </button>
                                        <button onclick="setLanguage('simplified')" id="langZhCN" class="language-btn bg-white border-2 border-blue-200 hover:border-blue-400 p-4 rounded-xl text-center transition-all duration-200">
                                            <div class="font-semibold text-gray-800">ÁÆÄ‰Ωì‰∏≠Êñá</div>
                                        </button>
                                    </div>
                                </div>

                                <!-- Audio Settings -->
                                <div class="bg-gradient-to-br from-purple-100 to-pink-100 rounded-2xl p-6 mb-6">
                                    <h4 class="text-xl font-bold text-purple-600 mb-4 flex items-center">
                                        <span class="text-2xl mr-2">üéµ</span>
                                        Audio Settings
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <!-- Music Toggle -->
                                        <div class="flex items-center justify-between bg-white rounded-xl p-4">
                                            <div class="flex items-center space-x-3">
                                                <span class="text-2xl">üé∂</span>
                                                <div>
                                                    <div class="font-semibold text-gray-800">Background Music</div>
                                                </div>
                                            </div>
                                            <button onclick="toggleMusic()" id="musicToggle" class="toggle-btn bg-green-500 relative inline-flex h-8 w-14 items-center rounded-full transition-colors duration-200">
                                                <span class="toggle-dot bg-white h-6 w-6 rounded-full transition-transform duration-200 transform translate-x-7"></span>
                                            </button>
                                        </div>

                                        <!-- Vibration Toggle -->
                                        <div class="flex items-center justify-between bg-white rounded-xl p-4">
                                            <div class="flex items-center space-x-3">
                                                <span class="text-2xl">üì≥</span>
                                                <div>
                                                    <div class="font-semibold text-gray-800">Vibration</div>
                                                </div>
                                            </div>
                                            <button onclick="toggleVibration()" id="vibrationToggle" class="toggle-btn bg-green-500 relative inline-flex h-8 w-14 items-center rounded-full transition-colors duration-200">
                                                <span class="toggle-dot bg-white h-6 w-6 rounded-full transition-transform duration-200 transform translate-x-7"></span>
                                            </button>
                                        </div>
                                        
                                        <!-- Dark Mode Toggle -->
                                        <div class="flex items-center justify-between bg-white rounded-xl p-4">
                                            <div class="flex items-center space-x-3">
                                                <span class="text-2xl">üåô</span>
                                                <div>
                                                    <div class="font-semibold text-gray-800">Dark Mode</div>
                                                </div>
                                            </div>
                                            <button onclick="toggleDarkMode()" id="darkModeToggle" class="toggle-btn bg-gray-400 relative inline-flex h-8 w-14 items-center rounded-full transition-colors duration-200">
                                                <span class="toggle-dot bg-white h-6 w-6 rounded-full transition-transform duration-200 transform translate-x-1"></span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Premium Subscription -->
                                <div class="bg-gradient-to-br from-yellow-100 to-orange-100 rounded-2xl p-6 mb-6 border-2 border-yellow-300">
                                    <h4 class="text-xl font-bold text-orange-600 mb-4 flex items-center">
                                        <span class="text-2xl mr-2">üëë</span>
                                        Premium Subscription
                                    </h4>
                                    <div class="bg-white rounded-xl p-6 mb-4">
                                        <div class="text-center mb-4">
                                            <div class="text-4xl mb-2">üåü</div>
                                            <h5 class="text-2xl font-bold text-gray-800 mb-2">SmartBuddy Premium</h5>
                                            <p class="text-gray-600">Unlock unlimited learning potential!</p>
                                        </div>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                            <div class="flex items-center space-x-2">
                                                <span class="text-green-500">‚úÖ</span>
                                                <span class="text-gray-700">Unlimited Questions</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-green-500">‚úÖ</span>
                                                <span class="text-gray-700">Gift Redemption Available</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-green-500">‚úÖ</span>
                                                <span class="text-gray-700">All 10 Premium Mini-Games</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-green-500">‚úÖ</span>
                                                <span class="text-gray-700">Priority Support</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-green-500">‚úÖ</span>
                                                <span class="text-gray-700">Offline Mode</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-green-500">‚úÖ</span>
                                                <span class="text-gray-700">Unlimited Avatar Customizations</span>
                                            </div>
                                        </div>
                                        
                                        <!-- Subscription Plans -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                            <!-- Monthly Plan -->
                                            <div class="border-2 border-gray-200 rounded-xl p-4 text-center">
                                                <h6 class="font-bold text-gray-800 mb-2">Monthly Plan</h6>
                                                <div class="text-2xl font-bold text-orange-600 mb-1">HK$78<span class="text-sm text-gray-600">/month</span></div>
                                                <div class="text-xs text-gray-500">Cancel anytime</div>
                                            </div>
                                            
                                            <!-- Annual Plan with Discount -->
                                            <div class="border-2 border-green-400 bg-green-50 rounded-xl p-4 text-center relative">
                                                <div class="absolute -top-2 right-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full font-bold">2 Months FREE!</div>
                                                <h6 class="font-bold text-gray-800 mb-2">Annual Plan</h6>
                                                <div class="text-2xl font-bold text-green-600 mb-1">HK$780<span class="text-sm text-gray-600">/year</span></div>
                                                <div class="text-xs text-green-700">Save HK$156 per year</div>
                                                <div class="text-xs text-gray-500">Only HK$65/month</div>
                                            </div>
                                        </div>
                                        
                                        <div class="text-center text-sm text-gray-600 mb-4">
                                            ‚≠ê 7-day free trial ‚Ä¢ Cancel anytime
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <button onclick="subscribePremium('monthly')" class="bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white py-3 px-4 rounded-xl font-bold transition-all duration-300 hover:transform hover:scale-105">
                                            üöÄ Start Monthly Trial
                                        </button>
                                        <button onclick="subscribePremium('annual')" class="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white py-3 px-4 rounded-xl font-bold transition-all duration-300 hover:transform hover:scale-105">
                                            üí∞ Start Annual Trial
                                        </button>
                                    </div>
                                </div>

                                <!-- Support & Contact -->
                                <div class="bg-gradient-to-br from-green-100 to-emerald-100 rounded-2xl p-6 mb-6">
                                    <h4 class="text-xl font-bold text-green-600 mb-4 flex items-center">
                                        <span class="text-2xl mr-2">üìû</span>
                                        Contact Us
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <button onclick="openHelp()" class="bg-white hover:bg-gray-50 border-2 border-green-200 hover:border-green-400 p-4 rounded-xl text-center transition-all duration-200">
                                            <div class="text-2xl mb-2">‚ùì</div>
                                            <div class="font-semibold text-gray-800">Help Center</div>
                                        </button>
                                        
                                        <button onclick="sendFeedback()" class="bg-white hover:bg-gray-50 border-2 border-green-200 hover:border-green-400 p-4 rounded-xl text-center transition-all duration-200">
                                            <div class="text-2xl mb-2">üí¨</div>
                                            <div class="font-semibold text-gray-800">Send Feedback</div>
                                        </button>
                                    </div>
                                </div>



                                <!-- Back to Home Button -->
                                <div class="text-center">
                                    <button onclick="showWelcome()" class="secondary-button text-white py-3 px-6 rounded-xl font-semibold">
                                        üè† Back to Home
                                    </button>
                                </div>
                            </div>
                        </section>
                    </main>

                    <!-- Daily Streak Popup - BULLETPROOF VERSION -->
                    <div id="streakPopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
                        <div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; padding: 1rem;">
                            <div class="bg-gradient-to-br from-orange-100 to-pink-100 rounded-3xl p-8 text-center max-w-lg relative overflow-hidden" style="max-height: 90vh; overflow-y: auto;">
                                <!-- MULTIPLE CLOSE BUTTONS FOR RELIABILITY -->
                                <button id="closeButton1" style="position: absolute; top: 1rem; right: 1rem; width: 2rem; height: 2rem; background: rgba(255,255,255,0.9); border: none; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; cursor: pointer; z-index: 10;">
                                    √ó
                                </button>
                                
                                <!-- Decorative elements -->
                                <div class="absolute top-2 left-4 text-yellow-400 text-2xl animate-bounce">‚≠ê</div>
                                <div class="absolute top-4 right-12 text-pink-400 text-xl animate-pulse">‚ú®</div>
                                <div class="absolute bottom-4 left-6 text-blue-400 text-xl animate-bounce">üí´</div>
                                
                                <!-- Streak Fire Icon -->
                                <div class="text-8xl mb-4 animate-pulse" id="streakMainEmoji">üî•</div>
                                
                                <!-- Streak Title -->
                                <h3 class="text-3xl font-bold text-gray-800 mb-3" id="streakTitle">Daily Learning Streak!</h3>
                                
                                <!-- Current Streak Display -->
                                <div class="bg-white rounded-2xl p-4 mb-6 shadow-lg">
                                    <div class="text-4xl font-bold text-orange-600 mb-2" id="currentStreak">0 Days</div>
                                    <div class="text-lg text-gray-700" id="streakMessage">Start your learning journey today!</div>
                                </div>
                                

                                
                                <!-- Fun Streak Calendar -->
                                <div class="mb-6">
                                    <p class="text-sm font-semibold text-gray-600 mb-3">This Week:</p>
                                    <div class="grid grid-cols-7 gap-2" id="streakCalendar">
                                        <!-- Calendar days will be inserted here -->
                                    </div>
                                </div>
                                
                                <!-- ACTION BUTTONS -->
                                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                    <button id="streakLearnButton" class="fun-button text-white py-3 px-6 rounded-xl font-semibold" style="border: none; cursor: pointer;">
                                        üöÄ Start
                                    </button>
                                    <button id="streakPrizesButton" class="secondary-button text-white py-2 px-4 rounded-xl font-semibold" style="border: none; cursor: pointer;">
                                        üéÅ Redeem Prizes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Achievement Popup (for game completions only) -->
                    <div id="achievementPopup" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-40" style="display: none;">
                        <div class="bg-white rounded-3xl p-8 text-center max-w-md mx-4">
                            <div class="text-6xl mb-4" id="achievementEmoji">üèÜ</div>
                            <h4 class="text-2xl font-bold text-gray-800 mb-2" id="achievementTitle">Achievement Unlocked!</h4>
                            <p class="text-gray-600 mb-6" id="achievementText">You've earned a new badge!</p>
                            <button onclick="closeAchievement()" class="fun-button text-white py-2 px-6 rounded-xl font-semibold">
                                Awesome! üéâ
                            </button>
                        </div>
                    </div>
                </body>
            `;
            
            // Initialize the app
            initializeApp();
        }

        // Global quiz variables
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let currentSubject = '';
        let currentGrade = '';
        let userStats = {
            points: 0,
            level: 1,
            streak: 1, // Start with day 1 streak for demo
            totalQuestionsAnswered: 0,
            correctAnswers: 0,
            lastLoginDate: new Date().toDateString(),
            selectedGrade: 'Grade1', // Default grade, will be saved on selection
            isPremium: false, // Premium subscription status
            premiumExpiresAt: null // Premium expiration date
        };

        // Daily usage tracking for free users
        let dailyUsage = {
            questionsAnswered: 0,
            gamesPlayed: 0,
            quizzesCompleted: 0,
            lastResetDate: new Date().toDateString()
        };

        // Free vs Premium feature limits
        const LIMITS = {
            free: {
                dailyQuestions: 15, // 3 quizzes √ó 5 questions each
                dailyQuizzes: 3,
                dailyGames: 3,
                availableGames: ['memory', 'mathsprint', 'wordbuilder'], // 3 basic games
                maxAvatarItems: 3,
                maxRewardsPerMonth: 1
            },
            premium: {
                dailyQuestions: -1, // Unlimited
                dailyQuizzes: -1, // Unlimited
                dailyGames: -1, // Unlimited
                availableGames: ['memory', 'mathsprint', 'wordbuilder', 'pattern', 'colormatch', 'reflex', 'logic', 'mathchallenge', 'strategy', 'codebreaking'], // All games
                maxAvatarItems: -1, // Unlimited
                maxRewardsPerMonth: -1 // Unlimited
            }
        };

        // ===== FREEMIUM SYSTEM FUNCTIONS =====

        // Reset daily usage if new day
        function resetDailyUsageIfNewDay() {
            const today = new Date().toDateString();
            if (dailyUsage.lastResetDate !== today) {
                dailyUsage = {
                    questionsAnswered: 0,
                    gamesPlayed: 0,
                    quizzesCompleted: 0,
                    lastResetDate: today
                };
                console.log('üîÑ Daily usage reset for new day');
            }
        }

        // Check if user has access to specific feature
        function hasFeatureAccess(feature) {
            if (userStats.isPremium) return true;
            
            const premiumOnlyFeatures = ['advanced-analytics', 'offline-mode', 'priority-support', 'family-sharing'];
            return !premiumOnlyFeatures.includes(feature);
        }

        // Check daily limits for activities
        function checkDailyLimits(activityType) {
            resetDailyUsageIfNewDay();
            
            // Premium users have unlimited access
            if (userStats.isPremium) {
                console.log('üëë Premium user - unlimited access granted');
                return true;
            }
            
            const limits = LIMITS.free;
            
            switch(activityType) {
                case 'quiz':
                    if (dailyUsage.quizzesCompleted >= limits.dailyQuizzes) {
                        showUpgradePrompt('quiz');
                        return false;
                    }
                    return true;
                    
                case 'questions':
                    if (dailyUsage.questionsAnswered >= limits.dailyQuestions) {
                        showUpgradePrompt('questions');
                        return false;
                    }
                    return true;
                    
                case 'games':
                    if (dailyUsage.gamesPlayed >= limits.dailyGames) {
                        showUpgradePrompt('games');
                        return false;
                    }
                    return true;
                    
                default:
                    return true;
            }
        }

        // Check if specific game is available to free users
        function isGameAvailable(gameType) {
            if (userStats.isPremium) return true;
            
            const freeGames = LIMITS.free.availableGames;
            return freeGames.includes(gameType);
        }

        // Track daily usage
        function trackDailyUsage(activityType, amount = 1) {
            resetDailyUsageIfNewDay();
            
            switch(activityType) {
                case 'quiz':
                    dailyUsage.quizzesCompleted += amount;
                    break;
                case 'questions':
                    dailyUsage.questionsAnswered += amount;
                    break;
                case 'games':
                    dailyUsage.gamesPlayed += amount;
                    break;
            }
            
            console.log(`üìä Daily usage tracked: ${activityType} +${amount}`, dailyUsage);
        }

        // Show upgrade prompt when limits exceeded
        function showUpgradePrompt(limitType) {
            const prompts = {
                quiz: {
                    title: 'Daily Quiz Limit Reached! üéØ',
                    message: `You've completed your ${LIMITS.free.dailyQuizzes} free quizzes today! Upgrade to Premium for unlimited learning.`,
                    emoji: 'üéØ'
                },
                questions: {
                    title: 'Daily Question Limit Reached! üìö',
                    message: `You've answered ${LIMITS.free.dailyQuestions} questions today! Premium members get unlimited questions.`,
                    emoji: 'üìö'
                },
                games: {
                    title: 'Daily Game Limit Reached! üéÆ',
                    message: `You've played ${LIMITS.free.dailyGames} games today! Premium unlocks unlimited games and exclusive content.`,
                    emoji: 'üéÆ'
                }
            };
            
            const prompt = prompts[limitType] || prompts.quiz;
            
            const popup = document.createElement('div');
            popup.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 1rem;';
            
            popup.innerHTML = `
                <div class="bg-gradient-to-br from-orange-100 to-red-100 rounded-3xl p-8 text-center max-w-md relative overflow-hidden">
                    <button onclick="this.parentElement.parentElement.remove()" class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-gray-600">√ó</button>
                    
                    <!-- Decorative elements -->
                    <div class="absolute top-2 left-4 text-yellow-400 text-xl animate-bounce">‚≠ê</div>
                    <div class="absolute top-4 right-12 text-pink-400 text-lg animate-pulse">‚ú®</div>
                    <div class="absolute bottom-4 left-6 text-blue-400 text-lg animate-bounce">üí´</div>
                    
                    <div class="text-6xl mb-4">${prompt.emoji}</div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">${prompt.title}</h3>
                    <p class="text-gray-600 mb-6">${prompt.message}</p>
                    
                    <!-- Premium Benefits Preview -->
                    <div class="bg-white rounded-xl p-4 mb-6 text-left">
                        <h4 class="font-bold text-orange-600 mb-3">üëë Premium Benefits:</h4>
                        <div class="space-y-2 text-sm text-gray-700">
                            <div class="flex items-center space-x-2">
                                <span class="text-green-500">‚úÖ</span>
                                <span>Unlimited quizzes, questions & games</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-green-500">‚úÖ</span>
                                <span>Access to all premium games & features</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-green-500">‚úÖ</span>
                                <span>Advanced AI tutoring & personalized learning</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-green-500">‚úÖ</span>
                                <span>Exclusive premium rewards & content</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-green-500">‚úÖ</span>
                                <span>No ads & priority customer support</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trial Offer -->
                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl p-4 mb-6 border-2 border-yellow-300">
                        <div class="text-2xl font-bold text-orange-600 mb-1">üéâ Special Offer!</div>
                        <div class="text-lg font-semibold text-gray-800 mb-1">7-Day FREE Trial</div>
                        <div class="text-sm text-gray-600">Then just $9.99/month ‚Ä¢ Cancel anytime</div>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="subscribePremium(); this.parentElement.parentElement.parentElement.remove();" 
                                class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white py-4 px-6 rounded-xl font-bold text-lg transition-all duration-300 hover:transform hover:scale-105">
                            üöÄ Start FREE Trial
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                class="w-full bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 px-6 rounded-xl font-semibold">
                            Maybe Later
                        </button>
                    </div>
                    
                    <div class="mt-4 text-xs text-gray-500">
                        üîí Secure payment ‚Ä¢ No charges during trial period
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            console.log(`üí∞ Upgrade prompt shown for: ${limitType}`);
        }

        // Save selected grade
        function saveSelectedGrade() {
            const gradeSelect = document.getElementById('gradeSelect');
            userStats.selectedGrade = gradeSelect.value;
            console.log(`üíæ Grade saved: ${userStats.selectedGrade}`);
        }

        // Initialize the main app
        function initializeApp() {
            console.log('üöÄ Initializing app...');
            
            // Restore selected grade
            const gradeSelect = document.getElementById('gradeSelect');
            if (gradeSelect && userStats.selectedGrade) {
                gradeSelect.value = userStats.selectedGrade;
                console.log(`üìö Grade restored: ${userStats.selectedGrade}`);
            }
            
            updateUserStats();
            loadRewards();
            
            // FORCE hide achievement popup and prevent it from showing
            setTimeout(() => {
                const achievementPopup = document.getElementById('achievementPopup');
                if (achievementPopup) {
                    achievementPopup.classList.add('hidden');
                    achievementPopup.style.display = 'none';
                    console.log('‚úÖ Achievement popup hidden');
                }
            }, 100);
            
            // Show streak popup when app starts (delayed to ensure achievement is hidden)
            setTimeout(() => {
                console.log('üî• Showing streak popup...');
                showStreakPopup();
            }, 1500);
        }

        // Update user stats display (localStorage removed for sandbox compatibility)
        function updateUserStats() {
            const pointsEl = document.getElementById('userPoints');
            const levelEl = document.getElementById('userLevel');
            const streakEl = document.getElementById('streakCount');
            
            if (pointsEl) pointsEl.textContent = userStats.points;
            if (levelEl) levelEl.textContent = userStats.level;
            if (streakEl) streakEl.textContent = `${userStats.streak} day streak`;
        }

        // Show different sections
        function showSection(sectionId) {
            const sections = ['welcomeSection', 'quizSection', 'resultsSection', 'rewardsSection', 'miniGamesSection', 'gamePlaySection', 'progressSection', 'settingsSection', 'adminDashboardSection'];
            sections.forEach(section => {
                const el = document.getElementById(section);
                if (el) {
                    if (section === sectionId) {
                        el.classList.remove('hidden');
                    } else {
                        el.classList.add('hidden');
                    }
                }
            });
        }

        // ===== ADMIN DASHBOARD FUNCTIONS =====
        
        // Show admin dashboard (secret access via CTRL+SHIFT+A)
        function showAdminDashboard() {
            showSection('adminDashboardSection');
            refreshAdminData();
            showAdminTab('pending'); // Default to pending rewards tab
        }

        // Refresh admin dashboard data
        function refreshAdminData() {
            if (!window.adminDashboard) {
                window.adminDashboard = {
                    pendingRewards: [],
                    completedRewards: [],
                    totalRevenue: 0,
                    userStats: { totalUsers: 156, activeUsers: 89, premiumUsers: 23 }
                };
            }

            // Update stats cards
            const pending = window.adminDashboard.pendingRewards.length;
            const revenue = window.adminDashboard.totalRevenue;
            const users = window.adminDashboard.userStats;
            
            document.getElementById('adminTotalUsers').textContent = users.totalUsers;
            document.getElementById('adminPendingRewards').textContent = pending;
            document.getElementById('adminRevenue').textContent = `$${revenue.toFixed(2)}`;
            document.getElementById('adminPremiumUsers').textContent = users.premiumUsers;
            
            // Update tab buttons with counts
            document.getElementById('adminTabPending').textContent = `üì¶ Pending Rewards (${pending})`;
            
            console.log('üìä Admin dashboard data refreshed');
        }

        // Show admin tab content
        function showAdminTab(tabName) {
            // Update tab buttons
            const tabButtons = document.querySelectorAll('.admin-tab-btn');
            tabButtons.forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-300', 'text-gray-700');
            });
            
            const activeTab = document.getElementById(`adminTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            if (activeTab) {
                activeTab.classList.remove('bg-gray-300', 'text-gray-700');
                activeTab.classList.add('bg-blue-500', 'text-white');
            }
            
            // Show tab content
            const content = document.getElementById('adminTabContent');
            
            switch(tabName) {
                case 'pending':
                    showPendingRewardsTab(content);
                    break;
                case 'completed':
                    showCompletedOrdersTab(content);
                    break;
                case 'users':
                    showUserManagementTab(content);
                    break;
                case 'analytics':
                    showAnalyticsTab(content);
                    break;
                case 'settings':
                    showSystemSettingsTab(content);
                    break;
            }
        }

        // Pending Rewards Tab
        function showPendingRewardsTab(content) {
            const pending = window.adminDashboard.pendingRewards || [];
            
            content.innerHTML = `
                <div class="bg-gradient-to-br from-orange-50 to-red-50 rounded-2xl p-6">
                    <h4 class="text-xl font-bold text-orange-600 mb-4 flex items-center">
                        <span class="text-2xl mr-2">üì¶</span>
                        Pending Parent Confirmations
                    </h4>
                    
                    ${pending.length === 0 ? `
                        <div class="text-center py-8">
                            <div class="text-6xl mb-4">üì≠</div>
                            <h5 class="text-xl font-semibold text-gray-600 mb-2">No Pending Rewards</h5>
                            <p class="text-gray-500">All rewards have been processed!</p>
                        </div>
                    ` : `
                        <div class="space-y-4">
                            ${pending.map(reward => `
                                <div class="bg-white rounded-xl p-4 border-l-4 border-orange-400">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-2 mb-2">
                                                <span class="text-2xl">üéÅ</span>
                                                <h5 class="font-bold text-gray-800">${reward.rewardName}</h5>
                                                <span class="px-2 py-1 bg-orange-100 text-orange-600 rounded-full text-xs font-semibold">
                                                    ${reward.status.replace('_', ' ').toUpperCase()}
                                                </span>
                                            </div>
                                            <div class="grid grid-cols-2 gap-4 text-sm text-gray-600">
                                                <div>
                                                    <strong>Parent Email:</strong><br>
                                                    <code class="text-xs bg-gray-100 px-1 rounded">${reward.parentEmail}</code>
                                                </div>
                                                <div>
                                                    <strong>Language:</strong> ${reward.language}<br>
                                                    <strong>Child ID:</strong> ${reward.childId}
                                                </div>
                                                <div>
                                                    <strong>Requested:</strong><br>
                                                    ${new Date(reward.dateRequested).toLocaleDateString()}
                                                </div>
                                                <div>
                                                    <strong>Reward ID:</strong><br>
                                                    <code class="text-xs bg-gray-100 px-1 rounded">${reward.id}</code>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="ml-4 space-y-2">
                                            <button onclick="resendParentEmail('${reward.id}')" 
                                                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                                                üìß Resend Email
                                            </button>
                                            <button onclick="markAsShipped('${reward.id}')" 
                                                    class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">
                                                ‚úÖ Mark Shipped
                                            </button>
                                            <button onclick="cancelReward('${reward.id}')" 
                                                    class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                                                ‚ùå Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        // Completed Orders Tab
        function showCompletedOrdersTab(content) {
            const completed = window.adminDashboard.completedRewards || [];
            
            content.innerHTML = `
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl p-6">
                    <h4 class="text-xl font-bold text-green-600 mb-4 flex items-center">
                        <span class="text-2xl mr-2">‚úÖ</span>
                        Completed Orders & Shipments
                    </h4>
                    
                    ${completed.length === 0 ? `
                        <div class="text-center py-8">
                            <div class="text-6xl mb-4">üì¶</div>
                            <h5 class="text-xl font-semibold text-gray-600 mb-2">No Completed Orders Yet</h5>
                            <p class="text-gray-500">Completed orders will appear here.</p>
                        </div>
                    ` : `
                        <div class="overflow-x-auto">
                            <table class="w-full bg-white rounded-xl">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Order ID</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Reward</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Status</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Shipped Date</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Tracking</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${completed.map(order => `
                                        <tr class="border-t">
                                            <td class="px-4 py-3 text-sm">${order.id}</td>
                                            <td class="px-4 py-3 text-sm">${order.rewardName}</td>
                                            <td class="px-4 py-3 text-sm">
                                                <span class="px-2 py-1 bg-green-100 text-green-600 rounded-full text-xs">
                                                    ${order.status}
                                                </span>
                                            </td>
                                            <td class="px-4 py-3 text-sm">${order.shippedDate}</td>
                                            <td class="px-4 py-3 text-sm">
                                                <code class="text-xs bg-gray-100 px-1 rounded">${order.tracking}</code>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </div>
            `;
        }

        // User Management Tab
        function showUserManagementTab(content) {
            content.innerHTML = `
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-6">
                    <h4 class="text-xl font-bold text-blue-600 mb-4 flex items-center">
                        <span class="text-2xl mr-2">üë•</span>
                        User Management & Statistics
                    </h4>
                    
                    <!-- User Stats Overview -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white rounded-xl p-4 text-center">
                            <div class="text-3xl mb-2">üë§</div>
                            <div class="text-2xl font-bold text-blue-600">${window.adminDashboard.userStats.totalUsers}</div>
                            <div class="text-sm text-gray-600">Total Users</div>
                        </div>
                        <div class="bg-white rounded-xl p-4 text-center">
                            <div class="text-3xl mb-2">üü¢</div>
                            <div class="text-2xl font-bold text-green-600">${window.adminDashboard.userStats.activeUsers}</div>
                            <div class="text-sm text-gray-600">Active This Week</div>
                        </div>
                        <div class="bg-white rounded-xl p-4 text-center">
                            <div class="text-3xl mb-2">üëë</div>
                            <div class="text-2xl font-bold text-purple-600">${window.adminDashboard.userStats.premiumUsers}</div>
                            <div class="text-sm text-gray-600">Premium Users</div>
                        </div>
                    </div>
                    
                    <!-- User Actions -->
                    <div class="bg-white rounded-xl p-6">
                        <h5 class="text-lg font-bold text-gray-800 mb-4">Quick Actions</h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <button onclick="exportUserData()" class="bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-xl font-semibold">
                                üìä Export User Data
                            </button>
                            <button onclick="sendBulkNotification()" class="bg-green-500 hover:bg-green-600 text-white py-3 px-4 rounded-xl font-semibold">
                                üì¢ Send Notification
                            </button>
                            <button onclick="manageSubscriptions()" class="bg-purple-500 hover:bg-purple-600 text-white py-3 px-4 rounded-xl font-semibold">
                                üëë Manage Premium
                            </button>
                            <button onclick="viewUserFeedback()" class="bg-orange-500 hover:bg-orange-600 text-white py-3 px-4 rounded-xl font-semibold">
                                üí¨ View Feedback
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Analytics Tab
        function showAnalyticsTab(content) {
            content.innerHTML = `
                <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl p-6">
                    <h4 class="text-xl font-bold text-purple-600 mb-4 flex items-center">
                        <span class="text-2xl mr-2">üìä</span>
                        Analytics & Insights
                    </h4>
                    
                    <!-- Key Metrics -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white rounded-xl p-4 text-center">
                            <div class="text-3xl mb-2">üìà</div>
                            <div class="text-2xl font-bold text-green-600">+23%</div>
                            <div class="text-sm text-gray-600">User Growth</div>
                        </div>
                        <div class="bg-white rounded-xl p-4 text-center">
                            <div class="text-3xl mb-2">üéØ</div>
                            <div class="text-2xl font-bold text-blue-600">87%</div>
                            <div class="text-sm text-gray-600">Quiz Completion</div>
                        </div>
                        <div class="bg-white rounded-xl p-4 text-center">
                            <div class="text-3xl mb-2">üéÅ</div>
                            <div class="text-2xl font-bold text-orange-600">342</div>
                            <div class="text-sm text-gray-600">Rewards Redeemed</div>
                        </div>
                        <div class="bg-white rounded-xl p-4 text-center">
                            <div class="text-3xl mb-2">üí∞</div>
                            <div class="text-2xl font-bold text-purple-600">$1,247</div>
                            <div class="text-sm text-gray-600">Monthly Revenue</div>
                        </div>
                    </div>
                    
                    <!-- Charts Placeholder -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl p-6">
                            <h5 class="text-lg font-bold text-gray-800 mb-4">Daily Active Users</h5>
                            <div class="h-48 bg-gradient-to-r from-blue-100 to-purple-100 rounded-lg flex items-center justify-center">
                                <div class="text-center">
                                    <div class="text-4xl mb-2">üìà</div>
                                    <p class="text-gray-600">Chart would be here<br>(Integration with Chart.js)</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl p-6">
                            <h5 class="text-lg font-bold text-gray-800 mb-4">Revenue Breakdown</h5>
                            <div class="h-48 bg-gradient-to-r from-green-100 to-emerald-100 rounded-lg flex items-center justify-center">
                                <div class="text-center">
                                    <div class="text-4xl mb-2">üí∞</div>
                                    <p class="text-gray-600">Pie chart would be here<br>(Premium vs Rewards)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // System Settings Tab
        function showSystemSettingsTab(content) {
            content.innerHTML = `
                <div class="bg-gradient-to-br from-gray-50 to-slate-50 rounded-2xl p-6">
                    <h4 class="text-xl font-bold text-gray-600 mb-4 flex items-center">
                        <span class="text-2xl mr-2">‚öôÔ∏è</span>
                        System Settings & Configuration
                    </h4>
                    
                    <!-- API Configuration -->
                    <div class="bg-white rounded-xl p-6 mb-6">
                        <h5 class="text-lg font-bold text-gray-800 mb-4">üîå API Configuration</h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Airtable Base ID:</label>
                                <input type="text" value="${AIRTABLE_CONFIG.baseId}" 
                                       class="w-full text-sm p-3 border-2 border-gray-200 rounded-xl bg-gray-50" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">API Status:</label>
                                <div class="flex items-center space-x-2">
                                    <span class="w-3 h-3 bg-green-400 rounded-full"></span>
                                    <span class="text-sm text-green-600 font-semibold">Connected</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stripe Configuration -->
                    <div class="bg-white rounded-xl p-6 mb-6">
                        <h5 class="text-lg font-bold text-gray-800 mb-4">üí≥ Payment Configuration</h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Stripe Status:</label>
                                <div class="flex items-center space-x-2">
                                    <span class="w-3 h-3 bg-yellow-400 rounded-full"></span>
                                    <span class="text-sm text-yellow-600 font-semibold">Test Mode</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Webhook Status:</label>
                                <div class="flex items-center space-x-2">
                                    <span class="w-3 h-3 bg-green-400 rounded-full"></span>
                                    <span class="text-sm text-green-600 font-semibold">Active</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <button onclick="testStripeConnection()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg text-sm">
                                üß™ Test Stripe Connection
                            </button>
                        </div>
                    </div>
                    
                    <!-- Amazon Partner Integration -->
                    <div class="bg-white rounded-xl p-6 mb-6">
                        <h5 class="text-lg font-bold text-gray-800 mb-4">üì¶ Fulfillment Partners</h5>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-4 border rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <div class="text-2xl">üì¶</div>
                                    <div>
                                        <div class="font-semibold">Amazon FBA</div>
                                        <div class="text-sm text-gray-600">Fulfillment by Amazon</div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="w-3 h-3 bg-green-400 rounded-full"></span>
                                    <span class="text-sm text-green-600 font-semibold">Connected</span>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between p-4 border rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <div class="text-2xl">üéØ</div>
                                    <div>
                                        <div class="font-semibold">Target Education</div>
                                        <div class="text-sm text-gray-600">Educational retailers</div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="w-3 h-3 bg-yellow-400 rounded-full"></span>
                                    <span class="text-sm text-yellow-600 font-semibold">Pending</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- System Actions -->
                    <div class="bg-white rounded-xl p-6">
                        <h5 class="text-lg font-bold text-gray-800 mb-4">üõ†Ô∏è System Actions</h5>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button onclick="backupDatabase()" class="bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-xl font-semibold">
                                üíæ Backup Database
                            </button>
                            <button onclick="clearCache()" class="bg-orange-500 hover:bg-orange-600 text-white py-3 px-4 rounded-xl font-semibold">
                                üóëÔ∏è Clear Cache
                            </button>
                            <button onclick="updateSystem()" class="bg-green-500 hover:bg-green-600 text-white py-3 px-4 rounded-xl font-semibold">
                                üîÑ Update System
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Admin action functions
        function resendParentEmail(rewardId) {
            showQuickFeedback('üìß Parent email resent successfully!', 'green');
            console.log(`üìß Resending parent email for reward: ${rewardId}`);
        }

        function markAsShipped(rewardId) {
            showQuickFeedback('‚úÖ Reward marked as shipped!', 'green');
            console.log(`üì¶ Marking reward as shipped: ${rewardId}`);
            
            // Move from pending to completed
            const pending = window.adminDashboard.pendingRewards;
            const rewardIndex = pending.findIndex(r => r.id === rewardId);
            if (rewardIndex !== -1) {
                const reward = pending.splice(rewardIndex, 1)[0];
                reward.status = 'shipped';
                reward.shippedDate = new Date().toLocaleDateString();
                reward.tracking = 'TRK' + Math.random().toString(36).substr(2, 9).toUpperCase();
                
                if (!window.adminDashboard.completedRewards) {
                    window.adminDashboard.completedRewards = [];
                }
                window.adminDashboard.completedRewards.push(reward);
                
                refreshAdminData();
                showAdminTab('pending');
            }
        }

        function cancelReward(rewardId) {
            if (confirm('Are you sure you want to cancel this reward? Points will be returned to the child.')) {
                showQuickFeedback('‚ùå Reward cancelled, points returned', 'red');
                console.log(`‚ùå Cancelling reward: ${rewardId}`);
                
                // Remove from pending and trigger point return
                const pending = window.adminDashboard.pendingRewards;
                const rewardIndex = pending.findIndex(r => r.id === rewardId);
                if (rewardIndex !== -1) {
                    pending.splice(rewardIndex, 1);
                    handleRewardExpiry(rewardId); // This will return points
                    refreshAdminData();
                    showAdminTab('pending');
                }
            }
        }

        function exportUserData() {
            showQuickFeedback('üìä User data exported successfully!', 'green');
            console.log('üìä Exporting user data...');
        }

        function sendBulkNotification() {
            showQuickFeedback('üì¢ Bulk notification sent!', 'green');
            console.log('üì¢ Sending bulk notification...');
        }

        function manageSubscriptions() {
            showQuickFeedback('üëë Opening subscription management...', 'blue');
            console.log('üëë Managing subscriptions...');
        }

        function viewUserFeedback() {
            showQuickFeedback('üí¨ Loading user feedback...', 'blue');
            console.log('üí¨ Viewing user feedback...');
        }

        function testStripeConnection() {
            showQuickFeedback('üí≥ Stripe connection tested successfully!', 'green');
            console.log('üí≥ Testing Stripe connection...');
        }

        function backupDatabase() {
            showQuickFeedback('üíæ Database backup started...', 'blue');
            console.log('üíæ Starting database backup...');
        }

        function clearCache() {
            showQuickFeedback('üóëÔ∏è Cache cleared successfully!', 'green');
            console.log('üóëÔ∏è Clearing cache...');
        }

        function updateSystem() {
            showQuickFeedback('üîÑ System update initiated...', 'blue');
            console.log('üîÑ Updating system...');
        }

        // Secret admin access via keyboard combination
        let adminKeySequence = [];
        document.addEventListener('keydown', function(e) {
            adminKeySequence.push(e.key);
            if (adminKeySequence.length > 3) adminKeySequence.shift();
            
            // Press: CTRL + SHIFT + A to open admin dashboard
            if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                e.preventDefault();
                console.log('üîê Admin dashboard access granted');
                showAdminDashboard();
            }
        });

        // Mini Games Functions
        function showMiniGames() {
            showSection('miniGamesSection');
        }

        // Global game variables
        let currentGame = '';
        let gameState = {};
        let gameTimer = null;

        // ===== MINI GAMES IMPLEMENTATIONS =====

        // 1. Memory Match Game
        function startMemoryGame() {
            // FREEMIUM CHECK: Validate daily game limits and game access
            if (!isGameAvailable('memory')) {
                showUpgradePrompt('premium-game');
                return;
            }
            
            if (!checkDailyLimits('games')) {
                return; // Limit exceeded, user was shown upgrade prompt
            }
            
            // Track game start for daily usage
            trackDailyUsage('games');
            
            currentGame = 'memory';
            showSection('gamePlaySection');
            
            document.getElementById('gameEmoji').textContent = 'üß†';
            document.getElementById('gameTitle').textContent = 'Memory Match';
            document.getElementById('gameInstructions').textContent = 'Click two cards to find matching pairs!';
            document.getElementById('gameScore').textContent = '0';
            
            // Initialize game state
            gameState = {
                cards: [],
                flippedCards: [],
                matches: 0,
                totalPairs: 6,
                score: 0
            };
            
            setupMemoryGame();
        }

        function setupMemoryGame() {
            const symbols = ['üê∂', 'üê±', 'üê∏', 'ü¶ä', 'üêº', 'üê®'];
            const cardPairs = [...symbols, ...symbols];
            gameState.cards = shuffleArray(cardPairs);
            
            const gameArea = document.getElementById('gameArea');
            gameArea.innerHTML = `
                <div class="grid grid-cols-4 gap-3 max-w-md mx-auto">
                    ${gameState.cards.map((symbol, index) => `
                        <div class="memory-card w-16 h-16 bg-blue-200 rounded-lg flex items-center justify-center text-2xl cursor-pointer hover:bg-blue-300 transition-all duration-200" 
                             onclick="flipCard(${index})" 
                             data-index="${index}"
                             data-symbol="${symbol}">
                            ‚ùì
                        </div>
                    `).join('')}
                </div>
                <div class="text-center mt-4">
                    <p class="text-gray-600">Pairs found: <span id="pairsFound">0</span> / ${gameState.totalPairs}</p>
                </div>
            `;
            
            document.getElementById('gameActionButton').textContent = 'üîÑ Reset Game';
            document.getElementById('gameActionButton').onclick = () => setupMemoryGame();
        }

        function flipCard(index) {
            if (gameState.flippedCards.length >= 2) return;
            if (gameState.flippedCards.includes(index)) return;
            
            const card = document.querySelector(`[data-index="${index}"]`);
            const symbol = card.dataset.symbol;
            
            card.textContent = symbol;
            card.classList.add('bg-yellow-200');
            gameState.flippedCards.push(index);
            
            if (gameState.flippedCards.length === 2) {
                setTimeout(checkMatch, 1000);
            }
        }

        function checkMatch() {
            const [first, second] = gameState.flippedCards;
            const card1 = document.querySelector(`[data-index="${first}"]`);
            const card2 = document.querySelector(`[data-index="${second}"]`);
            
            if (card1.dataset.symbol === card2.dataset.symbol) {
                // Match found!
                card1.classList.add('bg-green-200');
                card2.classList.add('bg-green-200');
                gameState.matches++;
                gameState.score += 5;
                
                document.getElementById('pairsFound').textContent = gameState.matches;
                document.getElementById('gameScore').textContent = gameState.score;
                
                if (gameState.matches === gameState.totalPairs) {
                    setTimeout(() => {
                        endGame('memory', gameState.score, 'üß† Perfect Memory!');
                    }, 500);
                }
            } else {
                // No match
                card1.textContent = '‚ùì';
                card2.textContent = '‚ùì';
                card1.classList.remove('bg-yellow-200');
                card2.classList.remove('bg-yellow-200');
            }
            
            gameState.flippedCards = [];
        }

        // 2. Math Sprint Game
        function startMathSprint() {
            currentGame = 'mathsprint';
            showSection('gamePlaySection');
            
            document.getElementById('gameEmoji').textContent = '‚ö°';
            document.getElementById('gameTitle').textContent = 'Math Sprint';
            document.getElementById('gameInstructions').textContent = 'Solve as many problems as you can in 60 seconds!';
            document.getElementById('gameScore').textContent = '0';
            
            gameState = {
                score: 0,
                timeLeft: 60,
                currentProblem: null
            };
            
            setupMathSprint();
        }

        function setupMathSprint() {
            const gameArea = document.getElementById('gameArea');
            gameArea.innerHTML = `
                <div class="text-center">
                    <div class="text-4xl font-bold text-red-600 mb-4" id="timeLeft">60</div>
                    <div class="text-2xl font-bold mb-6" id="mathProblem">Click Start to begin!</div>
                    <div class="grid grid-cols-2 gap-4 max-w-xs mx-auto" id="mathOptions">
                        <!-- Options will appear here -->
                    </div>
                </div>
            `;
            
            document.getElementById('gameActionButton').textContent = 'üöÄ Start Sprint';
            document.getElementById('gameActionButton').onclick = () => startMathSprintTimer();
        }

        function startMathSprintTimer() {
            generateMathProblem();
            
            gameTimer = setInterval(() => {
                gameState.timeLeft--;
                document.getElementById('timeLeft').textContent = gameState.timeLeft;
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(gameTimer);
                    endGame('mathsprint', gameState.score, '‚ö° Math Lightning!');
                }
            }, 1000);
            
            document.getElementById('gameActionButton').textContent = 'üîÑ New Problem';
            document.getElementById('gameActionButton').onclick = () => generateMathProblem();
        }

        function generateMathProblem() {
            const num1 = Math.floor(Math.random() * 20) + 1;
            const num2 = Math.floor(Math.random() * 20) + 1;
            const operations = ['+', '-', '√ó'];
            const operation = operations[Math.floor(Math.random() * operations.length)];
            
            let answer;
            let problemText;
            
            if (operation === '+') {
                answer = num1 + num2;
                problemText = `${num1} + ${num2} = ?`;
            } else if (operation === '-') {
                answer = Math.max(num1, num2) - Math.min(num1, num2);
                problemText = `${Math.max(num1, num2)} - ${Math.min(num1, num2)} = ?`;
            } else {
                answer = num1 * num2;
                problemText = `${num1} √ó ${num2} = ?`;
            }
            
            gameState.currentProblem = { answer, problemText };
            
            // Generate wrong answers
            const options = [answer];
            while (options.length < 4) {
                const wrongAnswer = answer + Math.floor(Math.random() * 10) - 5;
                if (wrongAnswer > 0 && !options.includes(wrongAnswer)) {
                    options.push(wrongAnswer);
                }
            }
            
            const shuffledOptions = shuffleArray(options);
            
            document.getElementById('mathProblem').textContent = problemText;
            document.getElementById('mathOptions').innerHTML = shuffledOptions.map(option => `
                <button onclick="checkMathAnswer(${option})" 
                        class="bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-xl font-bold text-lg">
                    ${option}
                </button>
            `).join('');
        }

        function checkMathAnswer(selectedAnswer) {
            if (selectedAnswer === gameState.currentProblem.answer) {
                gameState.score += 3;
                document.getElementById('gameScore').textContent = gameState.score;
                showQuickFeedback('‚úÖ Correct!', 'green');
                generateMathProblem();
            } else {
                showQuickFeedback('‚ùå Try again!', 'red');
            }
        }

        // 3. Word Builder Game
        function startWordBuilder() {
            currentGame = 'wordbuilder';
            showSection('gamePlaySection');
            
            document.getElementById('gameEmoji').textContent = 'üî§';
            document.getElementById('gameTitle').textContent = 'Word Builder';
            document.getElementById('gameInstructions').textContent = 'Build words using the given letters!';
            document.getElementById('gameScore').textContent = '0';
            
            gameState = {
                score: 0,
                currentWord: '',
                targetWords: getGradeAppropriateWords(),
                currentTarget: 0,
                availableLetters: []
            };
            
            setupWordBuilder();
        }
        
        // Get grade-appropriate words based on selected grade
        function getGradeAppropriateWords() {
            const gradeSelect = document.getElementById('gradeSelect');
            const selectedGrade = gradeSelect ? gradeSelect.value : userStats.selectedGrade || 'K1';
            
            const wordsByGrade = {
                // Kindergarten - Simple 3-4 letter words
                'K1': ['CAT', 'DOG', 'SUN', 'EGG', 'CAR'],
                'K2': ['TREE', 'BOOK', 'STAR', 'FISH', 'BIRD'],
                'K3': ['HOUSE', 'HAPPY', 'LIGHT', 'WATER', 'FLOWER'],
                
                // Primary School - Progressively complex words
                'Primary1': ['SCHOOL', 'FRIEND', 'ANIMAL', 'WINTER', 'SUMMER'],
                'Primary2': ['LIBRARY', 'RAINBOW', 'ELEPHANT', 'BUTTERFLY', 'MOUNTAIN'],
                'Primary3': ['ADVENTURE', 'WONDERFUL', 'DISCOVERY', 'BEAUTIFUL', 'IMPORTANT'],
                'Primary4': ['EXTRAORDINARY', 'IMAGINATION', 'MAGNIFICENT', 'FASCINATING', 'ENCYCLOPEDIA'],
                'Primary5': ['RESPONSIBILITY', 'UNDERSTANDING', 'DETERMINATION', 'COMMUNICATION', 'ENVIRONMENTAL'],
                'Primary6': ['TRANSFORMATION', 'EXTRAORDINARY', 'ACCOMPLISHMENT', 'REVOLUTIONARY', 'INTERNATIONALLY']
            };
            
            return wordsByGrade[selectedGrade] || wordsByGrade['K1'];
        }

        function setupWordBuilder() {
            // Get grade-appropriate words based on selected grade
            const gradeWords = getGradeAppropriateWords();
            gameState.targetWords = gradeWords;
            gameState.currentTarget = Math.min(gameState.currentTarget, gradeWords.length - 1);
            
            const target = gameState.targetWords[gameState.currentTarget];
            gameState.availableLetters = shuffleArray([...target.split(''), 'X', 'Y', 'Z']);
            gameState.currentWord = '';
            
            const gameArea = document.getElementById('gameArea');
            gameArea.innerHTML = `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-lg text-gray-600">Build this word:</span>
                        <div class="text-3xl font-bold text-purple-600 mt-2">${target}</div>
                    </div>
                    
                    <div class="mb-6">
                        <span class="text-lg text-gray-600">Your word:</span>
                        <div class="text-2xl font-bold bg-yellow-100 rounded-lg p-3 mt-2 min-h-12" id="builtWord">
                            ${gameState.currentWord || '___'}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 max-w-xs mx-auto mb-4">
                        ${gameState.availableLetters.map((letter, index) => `
                            <button onclick="addLetter('${letter}', ${index})" 
                                    class="letter-btn bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-xl font-bold text-lg"
                                    id="letter-${index}">
                                ${letter}
                            </button>
                        `).join('')}
                    </div>
                    
                    <div class="space-x-3">
                        <button onclick="clearWord()" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg">
                            üóëÔ∏è Clear
                        </button>
                        <button onclick="checkWord()" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg">
                            ‚úÖ Check
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('gameActionButton').textContent = '‚è≠Ô∏è Next Word';
            document.getElementById('gameActionButton').onclick = () => nextWord();
        }

        function addLetter(letter, index) {
            gameState.currentWord += letter;
            document.getElementById('builtWord').textContent = gameState.currentWord;
            document.getElementById(`letter-${index}`).style.opacity = '0.5';
            document.getElementById(`letter-${index}`).disabled = true;
        }

        function clearWord() {
            gameState.currentWord = '';
            document.getElementById('builtWord').textContent = '___';
            document.querySelectorAll('.letter-btn').forEach(btn => {
                btn.style.opacity = '1';
                btn.disabled = false;
            });
        }

        function checkWord() {
            const target = gameState.targetWords[gameState.currentTarget];
            if (gameState.currentWord === target) {
                gameState.score += target.length;
                document.getElementById('gameScore').textContent = gameState.score;
                showQuickFeedback('üéâ Perfect!', 'green');
                setTimeout(() => nextWord(), 1500);
            } else {
                showQuickFeedback('‚ùå Not quite right!', 'red');
            }
        }

        // Show upgrade prompt for premium-only games
        function showPremiumGamePrompt(gameType) {
            const gameNames = {
                'pattern': 'Pattern Puzzle',
                'colormatch': 'Color Match', 
                'reflex': 'Quick Reflex',
                'logic': 'Logic Puzzle',
                'mathchallenge': 'Math Challenge',
                'strategy': 'Strategy Master',
                'codebreaking': 'Code Breaking'
            };
            
            const gameName = gameNames[gameType] || 'Premium Game';
            
            const popup = document.createElement('div');
            popup.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 1rem;';
            
            popup.innerHTML = `
                <div class="bg-gradient-to-br from-purple-100 to-pink-100 rounded-3xl p-8 text-center max-w-md relative overflow-hidden">
                    <button onclick="this.parentElement.parentElement.remove()" class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-gray-600">√ó</button>
                    
                    <!-- Decorative elements -->
                    <div class="absolute top-2 left-4 text-yellow-400 text-xl animate-bounce">‚≠ê</div>
                    <div class="absolute top-4 right-12 text-pink-400 text-lg animate-pulse">‚ú®</div>
                    <div class="absolute bottom-4 left-6 text-blue-400 text-lg animate-bounce">üí´</div>
                    
                    <div class="text-6xl mb-4">üëë</div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Premium Game!</h3>
                    <p class="text-gray-600 mb-6">${gameName} is available with Premium subscription. Unlock advanced learning games!</p>
                    
                    <!-- Premium Benefits Preview -->
                    <div class="bg-white rounded-xl p-4 mb-6 text-left">
                        <h4 class="font-bold text-purple-600 mb-3">üëë Premium Games Include:</h4>
                        <div class="space-y-2 text-sm text-gray-700">
                            <div class="flex items-center space-x-2">
                                <span class="text-green-500">‚úÖ</span>
                                <span>10 exclusive advanced games</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-green-500">‚úÖ</span>
                                <span>Logic & strategy challenges</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-green-500">‚úÖ</span>
                                <span>Higher point rewards & bonuses</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-green-500">‚úÖ</span>
                                <span>Adaptive difficulty levels</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trial Offer -->
                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl p-4 mb-6 border-2 border-yellow-300">
                        <div class="text-2xl font-bold text-orange-600 mb-1">üéâ Special Offer!</div>
                        <div class="text-lg font-semibold text-gray-800 mb-1">7-Day FREE Trial</div>
                        <div class="text-sm text-gray-600">Then just $9.99/month ‚Ä¢ Cancel anytime</div>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="subscribePremium(); this.parentElement.parentElement.parentElement.remove();" 
                                class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white py-4 px-6 rounded-xl font-bold text-lg transition-all duration-300 hover:transform hover:scale-105">
                            üëë Start FREE Trial
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                class="w-full bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 px-6 rounded-xl font-semibold">
                            Back to Free Games
                        </button>
                    </div>
                    
                    <div class="mt-4 text-xs text-gray-500">
                        üîí Secure payment ‚Ä¢ No charges during trial period
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            console.log(`üëë Premium game prompt shown for: ${gameName}`);
        }

        function nextWord() {
            gameState.currentTarget++;
            if (gameState.currentTarget >= gameState.targetWords.length) {
                endGame('wordbuilder', gameState.score, 'üî§ Word Master!');
            } else {
                setupWordBuilder();
            }
        }

        // 4. Pattern Puzzle Game
        function startPatternPuzzle() {
            currentGame = 'pattern';
            showSection('gamePlaySection');
            
            document.getElementById('gameEmoji').textContent = 'üß©';
            document.getElementById('gameTitle').textContent = 'Pattern Puzzle';
            document.getElementById('gameInstructions').textContent = 'Complete the pattern by choosing the next shape!';
            document.getElementById('gameScore').textContent = '0';
            
            gameState = {
                score: 0,
                level: 1,
                patterns: [
                    ['üî¥', 'üîµ', 'üî¥', 'üîµ', 'üî¥'],
                    ['‚≠ê', '‚≠ê', 'üåô', '‚≠ê', '‚≠ê'],
                    ['üü¢', 'üü°', 'üü¢', 'üü°', 'üü¢'],
                    ['üî∫', 'üîª', 'üî∫', 'üîª', 'üî∫']
                ],
                currentPattern: 0
            };
            
            setupPatternPuzzle();
        }

        function setupPatternPuzzle() {
            const pattern = gameState.patterns[gameState.currentPattern];
            const incomplete = pattern.slice(0, -1);
            const answer = pattern[pattern.length - 1];
            
            // Generate options
            const allShapes = ['üî¥', 'üîµ', 'üü¢', 'üü°', '‚≠ê', 'üåô', 'üî∫', 'üîª'];
            const options = [answer];
            while (options.length < 4) {
                const randomShape = allShapes[Math.floor(Math.random() * allShapes.length)];
                if (!options.includes(randomShape)) {
                    options.push(randomShape);
                }
            }
            
            const gameArea = document.getElementById('gameArea');
            gameArea.innerHTML = `
                <div class="text-center">
                    <div class="mb-6">
                        <span class="text-lg text-gray-600">Complete the pattern:</span>
                        <div class="flex justify-center items-center space-x-2 mt-4 text-3xl">
                            ${incomplete.map(shape => `<span>${shape}</span>`).join('')}
                            <span class="bg-gray-200 rounded-lg px-3 py-1">?</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 max-w-xs mx-auto">
                        ${shuffleArray(options).map(option => `
                            <button onclick="checkPattern('${option}', '${answer}')" 
                                    class="bg-purple-500 hover:bg-purple-600 text-white py-4 px-4 rounded-xl text-3xl">
                                ${option}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('gameActionButton').textContent = '‚è≠Ô∏è Next Pattern';
            document.getElementById('gameActionButton').onclick = () => nextPattern();
        }

        function checkPattern(selected, correct) {
            if (selected === correct) {
                gameState.score += 5;
                document.getElementById('gameScore').textContent = gameState.score;
                showQuickFeedback('üéâ Correct pattern!', 'green');
                setTimeout(() => nextPattern(), 1500);
            } else {
                showQuickFeedback('‚ùå Try again!', 'red');
            }
        }

        function nextPattern() {
            gameState.currentPattern++;
            if (gameState.currentPattern >= gameState.patterns.length) {
                endGame('pattern', gameState.score, 'üß© Pattern Expert!');
            } else {
                setupPatternPuzzle();
            }
        }

        // 5. Color Match Game
        function startColorMatch() {
            currentGame = 'colormatch';
            showSection('gamePlaySection');
            
            document.getElementById('gameEmoji').textContent = 'üé®';
            document.getElementById('gameTitle').textContent = 'Color Match';
            document.getElementById('gameInstructions').textContent = 'Click the color that matches the word!';
            document.getElementById('gameScore').textContent = '0';
            
            gameState = {
                score: 0,
                timeLeft: 30,
                colors: [
                    { name: 'RED', color: '#FF0000', emoji: 'üî¥' },
                    { name: 'BLUE', color: '#0000FF', emoji: 'üîµ' },
                    { name: 'GREEN', color: '#00FF00', emoji: 'üü¢' },
                    { name: 'YELLOW', color: '#FFFF00', emoji: 'üü°' },
                    { name: 'PURPLE', color: '#800080', emoji: 'üü£' },
                    { name: 'ORANGE', color: '#FFA500', emoji: 'üü†' }
                ]
            };
            
            setupColorMatch();
        }

        function setupColorMatch() {
            const gameArea = document.getElementById('gameArea');
            gameArea.innerHTML = `
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600 mb-4" id="colorTimeLeft">30</div>
                    <div class="text-3xl font-bold mb-6" id="colorWord">Click Start!</div>
                    <div class="grid grid-cols-3 gap-4 max-w-md mx-auto" id="colorOptions">
                        <!-- Color options will appear here -->
                    </div>
                </div>
            `;
            
            document.getElementById('gameActionButton').textContent = 'üé® Start Colors';
            document.getElementById('gameActionButton').onclick = () => startColorTimer();
        }

        function startColorTimer() {
            generateColorChallenge();
            
            gameTimer = setInterval(() => {
                gameState.timeLeft--;
                document.getElementById('colorTimeLeft').textContent = gameState.timeLeft;
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(gameTimer);
                    endGame('colormatch', gameState.score, 'üé® Color Master!');
                }
            }, 1000);
            
            document.getElementById('gameActionButton').textContent = 'üîÑ New Color';
            document.getElementById('gameActionButton').onclick = () => generateColorChallenge();
        }

        function generateColorChallenge() {
            const targetColor = gameState.colors[Math.floor(Math.random() * gameState.colors.length)];
            const options = shuffleArray([...gameState.colors]).slice(0, 6);
            
            if (!options.includes(targetColor)) {
                options[0] = targetColor;
            }
            
            document.getElementById('colorWord').textContent = targetColor.name;
            document.getElementById('colorOptions').innerHTML = options.map(color => `
                <button onclick="checkColor('${color.name}', '${targetColor.name}')" 
                        class="w-16 h-16 rounded-full border-4 border-gray-300 hover:border-gray-500 transition-all duration-200"
                        style="background-color: ${color.color}">
                </button>
            `).join('');
        }

        function checkColor(selected, correct) {
            if (selected === correct) {
                gameState.score += 2;
                document.getElementById('gameScore').textContent = gameState.score;
                showQuickFeedback('üé® Perfect!', 'green');
                generateColorChallenge();
            } else {
                showQuickFeedback('‚ùå Wrong color!', 'red');
            }
        }

        // 6. Quick Reflex Game
        function startQuickReflex() {
            currentGame = 'reflex';
            showSection('gamePlaySection');
            
            document.getElementById('gameEmoji').textContent = '‚ö°';
            document.getElementById('gameTitle').textContent = 'Quick Reflex';
            document.getElementById('gameInstructions').textContent = 'Click the green button as fast as you can!';
            document.getElementById('gameScore').textContent = '0';
            
            gameState = {
                score: 0,
                round: 0,
                maxRounds: 5,
                startTime: 0
            };
            
            setupQuickReflex();
        }

        // 7. Logic Puzzle Game (Primary 4-6)
        function startLogicPuzzle() {
            currentGame = 'logic';
            showSection('gamePlaySection');
            
            document.getElementById('gameEmoji').textContent = 'üß†';
            document.getElementById('gameTitle').textContent = 'Logic Puzzle';
            document.getElementById('gameInstructions').textContent = 'Solve complex reasoning challenges!';
            document.getElementById('gameScore').textContent = '0';
            
            gameState = {
                score: 0,
                level: 1,
                puzzles: [
                    {
                        question: "If all roses are flowers, and some flowers are red, which statement is definitely true?",
                        options: ["All roses are red", "Some roses might be red", "No roses are red", "All flowers are roses"],
                        correct: 1,
                        points: 8
                    },
                    {
                        question: "In a sequence: 2, 6, 18, 54... What comes next?",
                        options: ["108", "162", "216", "270"],
                        correct: 1,
                        points: 10
                    },
                    {
                        question: "If MATH = 1326, what does SCIENCE equal?",
                        options: ["1385635", "1384635", "1395635", "1386635"],
                        correct: 0,
                        points: 12
                    }
                ],
                currentPuzzle: 0
            };
            
            setupLogicPuzzle();
        }

        function setupLogicPuzzle() {
            const puzzle = gameState.puzzles[gameState.currentPuzzle];
            
            const gameArea = document.getElementById('gameArea');
            gameArea.innerHTML = `
                <div class="text-center">
                    <div class="mb-6">
                        <span class="text-lg text-gray-600">Level ${gameState.level} Logic Challenge</span>
                        <div class="text-lg font-bold text-purple-600 mt-4 mb-6 text-left bg-purple-50 p-4 rounded-xl">
                            ${puzzle.question}
                        </div>
                    </div>
                    
                    <div class="space-y-3 max-w-md mx-auto">
                        ${puzzle.options.map((option, index) => `
                            <button onclick="checkLogicAnswer(${index})" 
                                    class="w-full text-left bg-white hover:bg-purple-50 border-2 border-purple-200 hover:border-purple-400 p-4 rounded-xl transition-all duration-200">
                                <span class="font-bold text-purple-600">${String.fromCharCode(65 + index)})</span> ${option}
                            </button>
                        `).join('')}
                    </div>
                    
                    <div class="mt-6 text-sm text-gray-600">
                        Puzzle ${gameState.currentPuzzle + 1} of ${gameState.puzzles.length} ‚Ä¢ Worth ${puzzle.points} points
                    </div>
                </div>
            `;
            
            document.getElementById('gameActionButton').textContent = 'üß† Next Challenge';
            document.getElementById('gameActionButton').onclick = () => nextLogicPuzzle();
        }

        function checkLogicAnswer(selectedIndex) {
            const puzzle = gameState.puzzles[gameState.currentPuzzle];
            
            if (selectedIndex === puzzle.correct) {
                gameState.score += puzzle.points;
                document.getElementById('gameScore').textContent = gameState.score;
                showQuickFeedback('üéØ Brilliant reasoning!', 'green');
                setTimeout(() => nextLogicPuzzle(), 1500);
            } else {
                showQuickFeedback('‚ùå Think differently!', 'red');
            }
        }

        function nextLogicPuzzle() {
            gameState.currentPuzzle++;
            if (gameState.currentPuzzle >= gameState.puzzles.length) {
                endGame('logic', gameState.score, 'üß† Logic Master!');
            } else {
                gameState.level++;
                setupLogicPuzzle();
            }
        }

        // 8. Math Challenge Game (Primary 4-6)
        function startMathChallenge() {
            currentGame = 'mathchallenge';
            showSection('gamePlaySection');
            
            document.getElementById('gameEmoji').textContent = 'üî¢';
            document.getElementById('gameTitle').textContent = 'Math Challenge';
            document.getElementById('gameInstructions').textContent = 'Solve advanced math problems!';
            document.getElementById('gameScore').textContent = '0';
            
            gameState = {
                score: 0,
                level: 1,
                timeLeft: 90,
                problems: []
            };
            
            setupMathChallenge();
        }

        function setupMathChallenge() {
            const gameArea = document.getElementById('gameArea');
            gameArea.innerHTML = `
                <div class="text-center">
                    <div class="text-3xl font-bold text-blue-600 mb-4" id="mathTimeLeft">90</div>
                    <div class="text-lg text-gray-600 mb-6">Level ${gameState.level} Challenge</div>
                    <div class="bg-blue-50 rounded-xl p-6 mb-6" id="mathProblemArea">
                        <div class="text-2xl font-bold mb-4" id="mathChallengeQuestion">Click Start to begin!</div>
                        <div class="grid grid-cols-2 gap-4 max-w-sm mx-auto" id="mathChallengeOptions">
                            <!-- Options will appear here -->
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('gameActionButton').textContent = 'üöÄ Start Challenge';
            document.getElementById('gameActionButton').onclick = () => startMathChallengeTimer();
        }

        function startMathChallengeTimer() {
            generateMathChallenge();
            
            gameTimer = setInterval(() => {
                gameState.timeLeft--;
                document.getElementById('mathTimeLeft').textContent = gameState.timeLeft;
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(gameTimer);
                    endGame('mathchallenge', gameState.score, 'üî¢ Math Genius!');
                }
            }, 1000);
            
            document.getElementById('gameActionButton').textContent = '‚è≠Ô∏è Next Problem';
            document.getElementById('gameActionButton').onclick = () => generateMathChallenge();
        }

        function generateMathChallenge() {
            let question, answer, options;
            
            const problemTypes = ['fractions', 'percentages', 'algebra', 'geometry'];
            const type = problemTypes[Math.floor(Math.random() * problemTypes.length)];
            
            switch(type) {
                case 'fractions':
                    const num1 = Math.floor(Math.random() * 8) + 1;
                    const den1 = Math.floor(Math.random() * 8) + 2;
                    const num2 = Math.floor(Math.random() * 8) + 1;
                    const den2 = Math.floor(Math.random() * 8) + 2;
                    question = `What is ${num1}/${den1} + ${num2}/${den2}?`;
                    // Simplified calculation for demo
                    answer = `${(num1 * den2 + num2 * den1)}/${den1 * den2}`;
                    options = [answer, `${num1 + num2}/${den1 + den2}`, `${num1 * num2}/${den1 * den2}`, `${num1}/${den2}`];
                    break;
                    
                case 'percentages':
                    const base = Math.floor(Math.random() * 100) + 50;
                    const percent = Math.floor(Math.random() * 50) + 10;
                    const result = Math.round(base * percent / 100);
                    question = `What is ${percent}% of ${base}?`;
                    answer = result.toString();
                    options = [answer, (result + 10).toString(), (result - 5).toString(), (result * 2).toString()];
                    break;
                    
                case 'algebra':
                    const x = Math.floor(Math.random() * 10) + 1;
                    const a = Math.floor(Math.random() * 5) + 2;
                    const b = x * a;
                    question = `If ${a}x = ${b}, what is x?`;
                    answer = x.toString();
                    options = [answer, (x + 1).toString(), (x - 1).toString(), (x * 2).toString()];
                    break;
                    
                case 'geometry':
                    const side = Math.floor(Math.random() * 10) + 3;
                    const area = side * side;
                    question = `What is the area of a square with side length ${side}?`;
                    answer = area.toString();
                    options = [answer, (area + side).toString(), (side * 4).toString(), (side * 2).toString()];
                    break;
            }
            
            const shuffledOptions = shuffleArray(options);
            
            document.getElementById('mathChallengeQuestion').textContent = question;
            document.getElementById('mathChallengeOptions').innerHTML = shuffledOptions.map(option => `
                <button onclick="checkMathChallengeAnswer('${option}', '${answer}')" 
                        class="bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-xl font-bold">
                    ${option}
                </button>
            `).join('');
        }

        function checkMathChallengeAnswer(selected, correct) {
            if (selected === correct) {
                gameState.score += 7 + gameState.level;
                document.getElementById('gameScore').textContent = gameState.score;
                showQuickFeedback('üéØ Excellent!', 'green');
                gameState.level++;
                generateMathChallenge();
            } else {
                showQuickFeedback('‚ùå Try again!', 'red');
            }
        }

        // 9. Strategy Game (Primary 5-6)
        function startStrategyGame() {
            currentGame = 'strategy';
            showSection('gamePlaySection');
            
            document.getElementById('gameEmoji').textContent = '‚ôüÔ∏è';
            document.getElementById('gameTitle').textContent = 'Strategy Master';
            document.getElementById('gameInstructions').textContent = 'Plan your moves to win!';
            document.getElementById('gameScore').textContent = '0';
            
            gameState = {
                score: 0,
                board: Array(9).fill(null), // 3x3 grid
                playerTurn: true,
                gameMode: 'tactical'
            };
            
            setupStrategyGame();
        }

        function setupStrategyGame() {
            const gameArea = document.getElementById('gameArea');
            gameArea.innerHTML = `
                <div class="text-center">
                    <div class="mb-6">
                        <div class="text-lg font-bold text-gray-800 mb-2">Tactical Challenge</div>
                        <div class="text-sm text-gray-600">Get 3 in a row to win! Plan your strategy carefully.</div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 max-w-xs mx-auto mb-6" id="strategyBoard">
                        ${gameState.board.map((cell, index) => `
                            <button onclick="makeStrategyMove(${index})" 
                                    class="strategy-cell w-20 h-20 bg-white border-4 border-purple-300 rounded-xl text-3xl font-bold hover:bg-purple-50 transition-all duration-200"
                                    id="cell-${index}">
                                ${cell || ''}
                            </button>
                        `).join('')}
                    </div>
                    
                    <div class="text-center">
                        <div class="text-lg font-semibold text-purple-600" id="strategyStatus">
                            Your turn! Choose wisely.
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('gameActionButton').textContent = 'üîÑ New Game';
            document.getElementById('gameActionButton').onclick = () => resetStrategyGame();
        }

        function makeStrategyMove(index) {
            if (gameState.board[index] || !gameState.playerTurn) return;
            
            // Player move
            gameState.board[index] = 'üîµ';
            document.getElementById(`cell-${index}`).textContent = 'üîµ';
            document.getElementById(`cell-${index}`).disabled = true;
            
            if (checkStrategyWin('üîµ')) {
                gameState.score += 15;
                document.getElementById('gameScore').textContent = gameState.score;
                document.getElementById('strategyStatus').textContent = 'üéâ You won! Great strategy!';
                showQuickFeedback('üèÜ Strategic victory!', 'green');
                disableAllCells();
                return;
            }
            
            if (gameState.board.every(cell => cell !== null)) {
                document.getElementById('strategyStatus').textContent = 'ü§ù It\'s a draw! Good game.';
                return;
            }
            
            gameState.playerTurn = false;
            document.getElementById('strategyStatus').textContent = 'AI is thinking...';
            
            // AI move (with strategy)
            setTimeout(() => {
                makeAIMove();
            }, 1000);
        }

        function makeAIMove() {
            console.log('ü§ñ AI is making a move...');
            
            // Smart AI that tries to win or block
            let move = findWinningMove('üî¥') || findWinningMove('üîµ') || getRandomMove();
            
            console.log('üéØ AI selected move:', move);
            
            if (move !== -1) {
                gameState.board[move] = 'üî¥';
                
                const cellElement = document.getElementById(`cell-${move}`);
                if (cellElement) {
                    cellElement.textContent = 'üî¥';
                    cellElement.disabled = true;
                    cellElement.style.backgroundColor = '#fee2e2'; // Light red background
                }
                
                console.log('üî¥ AI placed move at position:', move);
                console.log('üìã Current board:', gameState.board);
                
                if (checkStrategyWin('üî¥')) {
                    document.getElementById('strategyStatus').textContent = 'ü§ñ AI wins! Try again?';
                    disableAllCells();
                    console.log('üèÜ AI won the game!');
                    return;
                }
                
                if (gameState.board.every(cell => cell !== null)) {
                    document.getElementById('strategyStatus').textContent = 'ü§ù It\'s a draw! Good game.';
                    console.log('ü§ù Game ended in a draw');
                    return;
                }
            } else {
                console.log('‚ùå AI could not find a valid move');
            }
            
            gameState.playerTurn = true;
            document.getElementById('strategyStatus').textContent = 'Your turn! Think strategically.';
            console.log('‚úÖ AI move completed, player turn now');
        }

        function findWinningMove(player) {
            const winPatterns = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // columns
                [0, 4, 8], [2, 4, 6] // diagonals
            ];
            
            for (let pattern of winPatterns) {
                const [a, b, c] = pattern;
                const line = [gameState.board[a], gameState.board[b], gameState.board[c]];
                const playerCount = line.filter(cell => cell === player).length;
                const emptyCount = line.filter(cell => cell === null).length;
                
                if (playerCount === 2 && emptyCount === 1) {
                    return pattern.find(i => gameState.board[i] === null);
                }
            }
            
            return -1;
        }

        function getRandomMove() {
            const availableMoves = gameState.board.map((cell, index) => cell === null ? index : null).filter(i => i !== null);
            return availableMoves.length > 0 ? availableMoves[Math.floor(Math.random() * availableMoves.length)] : -1;
        }

        function checkStrategyWin(player) {
            const winPatterns = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // columns
                [0, 4, 8], [2, 4, 6] // diagonals
            ];
            
            return winPatterns.some(pattern => 
                pattern.every(index => gameState.board[index] === player)
            );
        }

        function disableAllCells() {
            for (let i = 0; i < 9; i++) {
                document.getElementById(`cell-${i}`).disabled = true;
            }
        }

        function resetStrategyGame() {
            gameState.board = Array(9).fill(null);
            gameState.playerTurn = true;
            setupStrategyGame();
        }

        // 10. Code Breaking Game (Primary 6)
        function startCodeBreaking() {
            currentGame = 'codebreaking';
            showSection('gamePlaySection');
            
            document.getElementById('gameEmoji').textContent = 'üîì';
            document.getElementById('gameTitle').textContent = 'Code Breaking';
            document.getElementById('gameInstructions').textContent = 'Crack secret codes and ciphers!';
            document.getElementById('gameScore').textContent = '0';
            
            gameState = {
                score: 0,
                level: 1,
                codes: [
                    {
                        type: 'caesar',
                        encoded: 'KHOOR',
                        decoded: 'HELLO',
                        hint: 'Caesar Cipher: Each letter is shifted by 3 positions',
                        points: 12
                    },
                    {
                        type: 'reverse',
                        encoded: 'GNIMARGORP',
                        decoded: 'PROGRAMMING',
                        hint: 'Reverse Cipher: The message is written backwards',
                        points: 10
                    },
                    {
                        type: 'number',
                        encoded: '8-5-12-12-15',
                        decoded: 'HELLO',
                        hint: 'Number Code: A=1, B=2, C=3... Z=26',
                        points: 15
                    }
                ],
                currentCode: 0,
                attempts: 0
            };
            
            setupCodeBreaking();
        }

        function setupCodeBreaking() {
            const code = gameState.codes[gameState.currentCode];
            
            const gameArea = document.getElementById('gameArea');
            gameArea.innerHTML = `
                <div class="text-center">
                    <div class="mb-6">
                        <div class="text-lg font-bold text-gray-800 mb-2">Level ${gameState.level} - ${code.type.toUpperCase()} CIPHER</div>
                        <div class="bg-red-50 rounded-xl p-4 mb-4">
                            <div class="text-2xl font-mono font-bold text-red-600 mb-2">${code.encoded}</div>
                            <div class="text-sm text-red-700">üîç ${code.hint}</div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <input type="text" id="codeInput" placeholder="Enter decoded message..." 
                               class="w-full max-w-sm text-base p-3 border-2 border-gray-200 rounded-xl text-center font-mono font-bold uppercase focus:border-blue-400 focus:outline-none"
                               onkeypress="if(event.key==='Enter') checkCode()">
                    </div>
                    
                    <div class="space-y-3 mb-6">
                        <button onclick="checkCode()" class="bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-xl font-bold">
                            üîì Crack the Code
                        </button>
                        <button onclick="showCodeHint()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-xl font-semibold">
                            üí° Need a Hint?
                        </button>
                    </div>
                    
                    <div class="text-sm text-gray-600">
                        Level ${gameState.level} ‚Ä¢ Worth ${code.points} points ‚Ä¢ Attempts: ${gameState.attempts}
                    </div>
                </div>
            `;
            
            // Focus on input
            setTimeout(() => {
                document.getElementById('codeInput').focus();
            }, 300);
            
            document.getElementById('gameActionButton').textContent = '‚è≠Ô∏è Next Code';
            document.getElementById('gameActionButton').onclick = () => nextCode();
        }

        function checkCode() {
            const input = document.getElementById('codeInput').value.toUpperCase().trim();
            const code = gameState.codes[gameState.currentCode];
            
            gameState.attempts++;
            
            if (input === code.decoded) {
                // Correct!
                let points = code.points;
                if (gameState.attempts === 1) points += 5; // Bonus for first try
                
                gameState.score += points;
                document.getElementById('gameScore').textContent = gameState.score;
                
                showQuickFeedback(`üéâ Code cracked! +${points} points`, 'green');
                
                setTimeout(() => nextCode(), 2000);
            } else {
                showQuickFeedback('‚ùå Not quite right! Try again.', 'red');
                
                if (gameState.attempts >= 3) {
                    showCodeHint();
                }
            }
            
            // Update attempts display
            setupCodeBreaking();
        }

        function showCodeHint() {
            const code = gameState.codes[gameState.currentCode];
            let hintText = '';
            
            switch(code.type) {
                case 'caesar':
                    hintText = `üí° Hint: Try moving each letter 3 positions forward in the alphabet. K‚ÜíH, H‚ÜíE, O‚ÜíL...`;
                    break;
                case 'reverse':
                    hintText = `üí° Hint: Try reading the message from right to left: G-N-I-M-A-R-G-O-R-P`;
                    break;
                case 'number':
                    hintText = `üí° Hint: 8=H, 5=E, 12=L, 12=L, 15=O. Each number represents a letter's position.`;
                    break;
            }
            
            showQuickFeedback(hintText, 'blue');
        }

        function nextCode() {
            gameState.currentCode++;
            gameState.attempts = 0;
            
            if (gameState.currentCode >= gameState.codes.length) {
                endGame('codebreaking', gameState.score, 'üîì Master Codebreaker!');
            } else {
                gameState.level++;
                setupCodeBreaking();
            }
        }

        function setupQuickReflex() {
            const gameArea = document.getElementById('gameArea');
            gameArea.innerHTML = `
                <div class="text-center">
                    <div class="mb-4">
                        <span class="text-lg text-gray-600">Round: </span>
                        <span class="text-xl font-bold" id="reflexRound">${gameState.round + 1}</span> / ${gameState.maxRounds}
                    </div>
                    <div class="mb-6">
                        <div id="reflexButton" class="w-32 h-32 bg-red-500 rounded-full mx-auto flex items-center justify-center text-white font-bold text-lg cursor-not-allowed">
                            Wait...
                        </div>
                    </div>
                    <div class="text-sm text-gray-600" id="reflexInstructions">
                        Wait for the button to turn green, then click it!
                    </div>
                </div>
            `;
            
            document.getElementById('gameActionButton').textContent = '‚ö° Start Reflex';
            document.getElementById('gameActionButton').onclick = () => startReflexRound();
        }

        function startReflexRound() {
            const button = document.getElementById('reflexButton');
            const instructions = document.getElementById('reflexInstructions');
            
            button.className = 'w-32 h-32 bg-red-500 rounded-full mx-auto flex items-center justify-center text-white font-bold text-lg cursor-not-allowed';
            button.textContent = 'Wait...';
            button.onclick = null;
            instructions.textContent = 'Wait for green...';
            
            // Random delay between 1-4 seconds
            const delay = Math.random() * 3000 + 1000;
            
            setTimeout(() => {
                button.className = 'w-32 h-32 bg-green-500 rounded-full mx-auto flex items-center justify-center text-white font-bold text-lg cursor-pointer hover:bg-green-600';
                button.textContent = 'CLICK!';
                instructions.textContent = 'Click now!';
                gameState.startTime = Date.now();
                
                button.onclick = () => recordReaction();
            }, delay);
            
            document.getElementById('gameActionButton').textContent = '‚è≠Ô∏è Next Round';
            document.getElementById('gameActionButton').onclick = () => nextReflexRound();
        }

        function recordReaction() {
            const reactionTime = Date.now() - gameState.startTime;
            const button = document.getElementById('reflexButton');
            const instructions = document.getElementById('reflexInstructions');
            
            let points = 0;
            if (reactionTime < 300) points = 3;
            else if (reactionTime < 500) points = 2;
            else if (reactionTime < 800) points = 1;
            
            gameState.score += points;
            document.getElementById('gameScore').textContent = gameState.score;
            
            button.className = 'w-32 h-32 bg-yellow-500 rounded-full mx-auto flex items-center justify-center text-white font-bold text-lg cursor-not-allowed';
            button.textContent = `${reactionTime}ms`;
            button.onclick = null;
            instructions.textContent = `Reaction time: ${reactionTime}ms (+${points} points)`;
            
            gameState.round++;
            document.getElementById('reflexRound').textContent = gameState.round + 1;
            
            if (gameState.round >= gameState.maxRounds) {
                setTimeout(() => {
                    endGame('reflex', gameState.score, '‚ö° Lightning Fast!');
                }, 2000);
            }
        }

        function nextReflexRound() {
            if (gameState.round < gameState.maxRounds) {
                startReflexRound();
            }
        }

        // Utility functions for games
        function showQuickFeedback(message, type) {
            const gameArea = document.getElementById('gameArea');
            const feedback = document.createElement('div');
            feedback.className = `fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-${type === 'green' ? 'green' : 'red'}-500 text-white px-6 py-3 rounded-lg font-bold text-lg z-50`;
            feedback.textContent = message;
            
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                document.body.removeChild(feedback);
            }, 1000);
        }

        function endGame(gameType, finalScore, achievement) {
            clearInterval(gameTimer);
            
            // Award points to user
            userStats.points += finalScore;
            updateUserStats();
            
            // Check for level up
            const newLevel = Math.floor(userStats.points / 100) + 1;
            if (newLevel > userStats.level) {
                userStats.level = newLevel;
                showAchievement('üéâ', 'Level Up!', `You've reached Level ${newLevel}!`);
            } else {
                showAchievement('üéÆ', achievement, `You earned ${finalScore} points! Total: ${userStats.points}`);
            }
            
            setTimeout(() => {
                showMiniGames();
            }, 3000);
        }

        function showWelcome() {
            showSection('welcomeSection');
        }

        // Start quiz function
        async function startQuiz(subject) {
            // Check if grade is selected FIRST
            const gradeSelect = document.getElementById('gradeSelect');
            currentGrade = gradeSelect ? gradeSelect.value : '';
            
            if (!currentGrade) {
                showGradeSelectionPopup(subject);
                return;
            }

            // FREEMIUM CHECK: Validate daily quiz limits for free users
            if (!checkDailyLimits('quiz')) {
                return; // Limit exceeded, user was shown upgrade prompt
            }
            
            // Track quiz start for daily usage
            trackDailyUsage('quiz');
            
            // Clear previous quiz state immediately
            currentQuestions = [];
            currentQuestionIndex = 0;
            userAnswers = [];
            
            currentSubject = subject;
            
            showSection('quizSection');
            
            // Show loading state immediately
            document.getElementById('questionText').textContent = 'Loading questions...';
            document.getElementById('answerOptions').innerHTML = '<div class="text-center py-8">üîÑ Loading...</div>';
            
            // Update quiz header
            const subjectEmojis = {
                'Math': 'üî¢',
                'English': 'üìö', 
                'Science': 'üß™'
            };
            
            document.getElementById('subjectEmoji').textContent = subjectEmojis[subject];
            document.getElementById('quizTitle').textContent = `${subject} Quiz`;
            document.getElementById('quizGrade').textContent = currentGrade;
            
            // Load questions from Airtable
            await loadQuestions(subject, currentGrade);
        }

        // Show grade selection popup when no grade is selected
        function showGradeSelectionPopup(subject) {
            const popup = document.createElement('div');
            popup.id = 'gradeSelectionPopup';
            popup.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 1rem;';
            
            popup.innerHTML = `
                <div class="bg-white rounded-3xl p-8 text-center max-w-md relative overflow-hidden">
                    <button onclick="closeGradeSelectionPopup()" class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-gray-600">√ó</button>
                    
                    <!-- Decorative elements -->
                    <div class="absolute top-2 left-4 text-blue-400 text-2xl animate-bounce">üìö</div>
                    <div class="absolute top-4 right-12 text-purple-400 text-xl animate-pulse">‚ú®</div>
                    <div class="absolute bottom-4 left-6 text-green-400 text-lg animate-bounce">üéØ</div>
                    
                    <div class="text-6xl mb-4">üéì</div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-4">Select Your Grade First!</h3>
                    <p class="text-gray-600 mb-6">Please choose your grade level to start the ${subject} quiz.</p>
                    
                    <div class="mb-6">
                        <select id="popupGradeSelect" class="text-base px-4 py-3 rounded-xl border-2 border-purple-200 focus:border-purple-400 bg-white w-full" onchange="">
                            <option value="">Please select your grade</option>
                            <option value="K1">üé® K1 (Ages 3-4)</option>
                            <option value="K2">üåà K2 (Ages 4-5)</option>
                            <option value="K3">üé≠ K3 (Ages 5-6)</option>
                            <option value="Primary1">üìö Primary 1</option>
                            <option value="Primary2">üî¢ Primary 2</option>
                            <option value="Primary3">üß™ Primary 3</option>
                            <option value="Primary4">üåü Primary 4</option>
                            <option value="Primary5">üöÄ Primary 5</option>
                            <option value="Primary6">üèÜ Primary 6</option>
                        </select>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="selectGradeAndStart('${subject}')" 
                                class="w-full bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white py-3 px-6 rounded-xl font-bold">
                            üöÄ Start ${subject} Quiz
                        </button>
                        <button onclick="closeGradeSelectionPopup()" 
                                class="w-full bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-xl font-semibold">
                            Back to Home
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
        }

        // Select grade and start quiz
        function selectGradeAndStart(subject) {
            const popupGradeSelect = document.getElementById('popupGradeSelect');
            const selectedGrade = popupGradeSelect.value;
            
            if (!selectedGrade) {
                popupGradeSelect.style.borderColor = '#ef4444';
                showQuickFeedback('‚ùå Please select a grade!', 'red');
                return;
            }
            
            // Set the main grade selector
            const mainGradeSelect = document.getElementById('gradeSelect');
            if (mainGradeSelect) {
                mainGradeSelect.value = selectedGrade;
            }
            
            // Save selected grade
            userStats.selectedGrade = selectedGrade;
            console.log(`üìö Grade selected: ${selectedGrade}`);
            
            // Close popup
            closeGradeSelectionPopup();
            
            // Start quiz
            setTimeout(() => {
                startQuiz(subject);
            }, 200);
        }

        // Close grade selection popup
        function closeGradeSelectionPopup() {
            const popup = document.getElementById('gradeSelectionPopup');
            if (popup) {
                popup.remove();
            }
        }

        // Smart loading with difficulty adaptation
        async function loadQuestions(subject, grade) {
            try {
                // Get user's selected difficulty or auto-adapt based on performance
                const userDifficulty = getUserDifficulty(grade);
                
                // Smart filtering: Load questions for selected grade + adjacent difficulties
                const baseFilter = `AND({Subject} = '${subject}', OR({Grade} = '${grade}', FIND('${grade}', {Also_Suitable_For}) > 0))`;
                
                const url = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/Questions?filterByFormula=${encodeURIComponent(baseFilter)}&maxRecords=50`;
                
                console.log(`üéØ Loading ${subject} questions for ${grade}...`);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    let availableQuestions = data.records.map(record => record.fields);
                    
                    console.log(`üìä Found ${availableQuestions.length} questions`);
                    
                    if (availableQuestions.length === 0) {
                        loadDemoQuestions(subject, grade);
                        return;
                    }
                    
                    // Smart difficulty selection based on user performance
                    currentQuestions = selectQuestionsByDifficulty(availableQuestions, grade, userDifficulty);
                    
                    // Shuffle and limit to 5 questions
                    currentQuestions = shuffleArray(currentQuestions).slice(0, 5);
                    
                    // Reset quiz state
                    currentQuestionIndex = 0;
                    userAnswers = [];
                    
                    // Start quiz
                    displayQuestion();
                    
                    // Smart mode loaded (no UI indicator needed)
                    console.log('üìö Quiz loaded with smart difficulty adaptation');
                    
                } else {
                    throw new Error(`Failed to load questions: ${response.status}`);
                }
            } catch (error) {
                console.error('Error loading questions:', error);
                loadDemoQuestions(subject, grade);
            }
        }

        // Determine user difficulty based on performance and grade
        function getUserDifficulty(grade) {
            const accuracy = userStats.totalQuestionsAnswered > 0 ? 
                (userStats.correctAnswers / userStats.totalQuestionsAnswered) : 0.5;
            
            // Adaptive difficulty logic
            if (accuracy >= 0.8) return 'challenging';      // User is doing well, increase difficulty
            if (accuracy >= 0.6) return 'about_right';      // User is at appropriate level
            return 'easy';                                   // User needs easier questions
        }

        // Smart question selection based on difficulty
        function selectQuestionsByDifficulty(questions, grade, userDifficulty) {
            const gradeMap = {
                'K1': 'K1', 'K2': 'K2', 'K3': 'K3',
                'Primary1': 'P1', 'Primary2': 'P2', 'Primary3': 'P3',
                'Primary4': 'P4', 'Primary5': 'P5', 'Primary6': 'P6'
            };
            
            const normalizedGrade = gradeMap[grade] || grade;
            
            let filteredQuestions = [];
            
            if (userDifficulty === 'challenging') {
                // Look for challenging questions or questions from higher grades
                filteredQuestions = questions.filter(q => 
                    q.Difficulty_For_Grade === 'About_Right' && q.Grade === normalizedGrade ||
                    (q.Also_Suitable_For && q.Also_Suitable_For.includes(`${normalizedGrade}_Easy`))
                );
            } else if (userDifficulty === 'easy') {
                // Look for easier questions or questions from lower grades
                filteredQuestions = questions.filter(q => 
                    (q.Also_Suitable_For && q.Also_Suitable_For.includes(`${normalizedGrade}_Easy`)) ||
                    q.Difficulty_For_Grade === 'About_Right' && q.Grade === normalizedGrade
                );
            } else {
                // About right difficulty
                filteredQuestions = questions.filter(q => 
                    q.Difficulty_For_Grade === 'About_Right' && q.Grade === normalizedGrade
                );
            }
            
            // Fallback to any available questions if filtered set is too small
            if (filteredQuestions.length < 5) {
                filteredQuestions = questions;
            }
            
            console.log(`üéØ Selected ${filteredQuestions.length} questions for ${userDifficulty} difficulty`);
            return filteredQuestions;
        }

        // Demo questions for when Airtable fails - RANDOMIZED CORRECT ANSWERS
        function loadDemoQuestions(subject, grade) {
            const demoQuestions = {
                'Math': {
                    'K1': [
                        { 'Question Text': 'Count the apples:<br><div style="font-size: 3rem; text-align: center; margin: 10px 0;">üçéüçéüçé</div>', 'Option A': '3', 'Option B': '2', 'Option C': '4', 'Correct Answer': 'A', 'Points Value': 10 },
                        { 'Question Text': 'Count the toys:<br><div style="font-size: 3rem; text-align: center; margin: 10px 0;">üß∏üß∏</div>', 'Option A': '1', 'Option B': '2', 'Option C': '3', 'Correct Answer': 'B', 'Points Value': 10 },
                        { 'Question Text': 'Which is bigger?<br><div style="text-align: center; margin: 10px 0;"><span style="font-size: 6rem;">üêò</span> or <span style="font-size: 2rem;">üê≠</span></div>', 'Option A': 'Mouse', 'Option B': 'Same size', 'Option C': 'Elephant', 'Correct Answer': 'C', 'Points Value': 10 },
                        { 'Question Text': 'Count the stars:<br><div style="font-size: 3rem; text-align: center; margin: 10px 0;">‚≠ê‚≠ê</div>', 'Option A': '2', 'Option B': '3', 'Option C': '1', 'Correct Answer': 'A', 'Points Value': 10 },
                        { 'Question Text': 'Count the fingers:<br><div style="font-size: 3rem; text-align: center; margin: 10px 0;">‚úã</div>', 'Option A': '4', 'Option B': '5', 'Option C': '6', 'Correct Answer': 'B', 'Points Value': 10 }
                    ],
                    'Primary1': [
                        { 'Question Text': '5 + 3 = ?', 'Option A': '8', 'Option B': '7', 'Option C': '9', 'Correct Answer': 'A', 'Points Value': 10 },
                        { 'Question Text': '10 - 4 = ?', 'Option A': '5', 'Option B': '7', 'Option C': '6', 'Correct Answer': 'C', 'Points Value': 10 },
                        { 'Question Text': 'How many sides does a triangle have?', 'Option A': '3', 'Option B': '2', 'Option C': '4', 'Correct Answer': 'A', 'Points Value': 10 },
                        { 'Question Text': 'What is 2 √ó 3?', 'Option A': '5', 'Option B': '6', 'Option C': '7', 'Correct Answer': 'B', 'Points Value': 10 },
                        { 'Question Text': 'Which number is larger: 15 or 9?', 'Option A': '9', 'Option B': 'Same', 'Option C': '15', 'Correct Answer': 'C', 'Points Value': 10 }
                    ]
                },
                'English': {
                    'K1': [
                        { 'Question Text': 'What sound does a cat make?', 'Option A': 'Woof', 'Option B': 'Meow', 'Option C': 'Moo', 'Correct Answer': 'B', 'Points Value': 10 },
                        { 'Question Text': 'Which letter comes after A?', 'Option A': 'B', 'Option B': 'C', 'Option C': 'D', 'Correct Answer': 'A', 'Points Value': 10 },
                        { 'Question Text': 'What color is the sun?', 'Option A': 'Blue', 'Option B': 'Yellow', 'Option C': 'Green', 'Correct Answer': 'B', 'Points Value': 10 },
                        { 'Question Text': 'How many letters in "CAT"?', 'Option A': '2', 'Option B': '3', 'Option C': '4', 'Correct Answer': 'B', 'Points Value': 10 },
                        { 'Question Text': 'What do we use to see?', 'Option A': 'Ears', 'Option B': 'Eyes', 'Option C': 'Nose', 'Correct Answer': 'B', 'Points Value': 10 }
                    ],
                    'Grade1': [
                        { 'Question Text': 'Which word rhymes with "cat"?', 'Option A': 'Dog', 'Option B': 'Hat', 'Option C': 'Fish', 'Correct Answer': 'B', 'Points Value': 10 },
                        { 'Question Text': 'What is the opposite of "big"?', 'Option A': 'Large', 'Option B': 'Small', 'Option C': 'Huge', 'Correct Answer': 'B', 'Points Value': 10 },
                        { 'Question Text': 'Complete: "The dog is ___"', 'Option A': 'running', 'Option B': 'run', 'Option C': 'ran', 'Correct Answer': 'A', 'Points Value': 10 },
                        { 'Question Text': 'How many syllables in "rainbow"?', 'Option A': '1', 'Option B': '2', 'Option C': '3', 'Correct Answer': 'B', 'Points Value': 10 },
                        { 'Question Text': 'Which is a verb?', 'Option A': 'Blue', 'Option B': 'Jump', 'Option C': 'Table', 'Correct Answer': 'B', 'Points Value': 10 }
                    ]
                },
                'Science': {
                    'K1': [
                        { 'Question Text': 'What do plants need to grow?', 'Option A': 'Candy', 'Option B': 'Water', 'Option C': 'Toys', 'Correct Answer': 'B', 'Points Value': 10 },
                        { 'Question Text': 'How many legs does a spider have?', 'Option A': '6', 'Option B': '8', 'Option C': '10', 'Correct Answer': 'B', 'Points Value': 10 },
                        { 'Question Text': 'What gives us light during the day?', 'Option A': 'Moon', 'Option B': 'Sun', 'Option C': 'Stars', 'Correct Answer': 'B', 'Points Value': 10 },
                        { 'Question Text': 'Where do fish live?', 'Option A': 'Trees', 'Option B': 'Water', 'Option C': 'Sky', 'Correct Answer': 'B', 'Points Value': 10 },
                        { 'Question Text': 'What do bees make?', 'Option A': 'Milk', 'Option B': 'Honey', 'Option C': 'Bread', 'Correct Answer': 'B', 'Points Value': 10 }
                    ],
                    'Grade1': [
                        { 'Question Text': 'What do we breathe?', 'Option A': 'Water', 'Option B': 'Air', 'Option C': 'Food', 'Correct Answer': 'B', 'Points Value': 10 },
                        { 'Question Text': 'How many seasons are there?', 'Option A': '3', 'Option B': '4', 'Option C': '5', 'Correct Answer': 'B', 'Points Value': 10 },
                        { 'Question Text': 'What is the largest planet?', 'Option A': 'Earth', 'Option B': 'Jupiter', 'Option C': 'Mars', 'Correct Answer': 'B', 'Points Value': 10 },
                        { 'Question Text': 'What helps birds fly?', 'Option A': 'Legs', 'Option B': 'Wings', 'Option C': 'Eyes', 'Correct Answer': 'B', 'Points Value': 10 },
                        { 'Question Text': 'What do caterpillars become?', 'Option A': 'Frogs', 'Option B': 'Butterflies', 'Option C': 'Birds', 'Correct Answer': 'B', 'Points Value': 10 }
                    ]
                }
            };

            // Get demo questions for subject and grade
            const subjectQuestions = demoQuestions[subject];
            if (subjectQuestions && subjectQuestions[grade]) {
                currentQuestions = shuffleArray(subjectQuestions[grade]).slice(0, 5);
            } else {
                // Fallback to Grade1 Math if specific combo not found
                currentQuestions = shuffleArray(demoQuestions['Math']['Grade1']).slice(0, 5);
            }

            // Reset quiz state
            currentQuestionIndex = 0;
            userAnswers = [];
            
            // Start quiz
            displayQuestion();
            
            // Show demo mode message
            setTimeout(() => {
                const header = document.querySelector('#quizTitle');
                if (header) {
                    header.innerHTML += ' <span class="text-sm text-blue-600">(Demo Mode)</span>';
                }
            }, 500);
        }

        // Display current question
        function displayQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                showResults();
                return;
            }
            
            const question = currentQuestions[currentQuestionIndex];
            const totalQuestions = currentQuestions.length;
            
            // Update progress
            document.getElementById('questionProgress').textContent = `${currentQuestionIndex + 1} / ${totalQuestions}`;
            document.getElementById('progressBar').style.width = `${((currentQuestionIndex + 1) / totalQuestions) * 100}%`;
            
            // Fix question text display - use correct field name
            const questionText = question['Question Text'] || question['Question_Text'] || question.question || 'Question not found';
            document.getElementById('questionText').innerHTML = questionText;
            
            // Generate answer options with better field name handling
            const options = ['A', 'B', 'C', 'D'].filter(opt => {
                return question[`Option ${opt}`] || question[`Option_${opt}`] || question[`option${opt}`];
            });
            
            const answerOptionsHtml = options.map(option => {
                const optionText = question[`Option ${option}`] || question[`Option_${option}`] || question[`option${option}`] || `Option ${option}`;
                return `
                    <button onclick="selectAnswer('${option}')" 
                            class="answer-option w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-purple-400 hover:bg-purple-50 transition-all duration-200 text-base">
                        <span class="font-semibold text-purple-600">${option})</span> ${optionText}
                    </button>
                `;
            }).join('');
            
            document.getElementById('answerOptions').innerHTML = answerOptionsHtml;
            
            // Reset next button state
            const nextButton = document.getElementById('nextButton');
            nextButton.disabled = true;
            nextButton.classList.add('opacity-50', 'cursor-not-allowed');
            nextButton.innerHTML = 'Next Question ‚û°Ô∏è'; // Reset button text
        }

        // Handle answer selection
        function selectAnswer(selectedOption) {
            // Remove previous selections
            document.querySelectorAll('.answer-option').forEach(btn => {
                btn.classList.remove('bg-green-100', 'border-green-400', 'bg-red-100', 'border-red-400', 'bg-purple-100', 'border-purple-400');
            });
            
            // Highlight selected answer
            event.target.classList.add('bg-purple-100', 'border-purple-400');
            
            // Store answer
            const question = currentQuestions[currentQuestionIndex];
            const correctAnswer = question['Correct Answer'] || question['Correct_Answer'] || 'B'; // Fallback handling
            const isCorrect = selectedOption === correctAnswer;
            
            console.log(`üìù Answer Check: Selected=${selectedOption}, Correct=${correctAnswer}, Match=${isCorrect}`);
            
            userAnswers.push({
                questionIndex: currentQuestionIndex,
                selectedAnswer: selectedOption,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect,
                points: isCorrect ? (question['Points Value'] || 10) : 0,
                difficulty: question['Difficulty'] || 'suitable'
            });
            
            // Show correct/incorrect feedback immediately (no delay)
            showAnswerFeedback(isCorrect, correctAnswer);
        }

        // Show answer feedback with CORRECTED answer checking logic
        function showAnswerFeedback(isCorrect, correctAnswer) {
            console.log(`üîç FEEDBACK DEBUG:`, {
                userAnswerCorrect: isCorrect,
                correctAnswerShould: correctAnswer,
                questionData: currentQuestions[currentQuestionIndex]
            });
            
            const options = document.querySelectorAll('.answer-option');
            
            options.forEach(option => {
                const optionLetter = option.textContent.trim().split(')')[0];
                console.log(`üî§ Option ${optionLetter} vs Correct ${correctAnswer}`);
                
                // ALWAYS highlight the ACTUAL correct answer in green
                if (optionLetter === correctAnswer) {
                    option.classList.remove('bg-purple-100', 'border-purple-400', 'bg-red-100', 'border-red-400');
                    option.classList.add('bg-green-100', 'border-green-400');
                    
                    if (!option.innerHTML.includes('‚úÖ')) {
                        option.innerHTML += ' ‚úÖ CORRECT';
                    }
                    console.log(`‚úÖ MARKED CORRECT: Option ${optionLetter}`);
                } 
                // Mark the user's wrong selection in red (if they were wrong)
                else if (option.classList.contains('bg-purple-100') && !isCorrect) {
                    option.classList.remove('bg-purple-100', 'border-purple-400');
                    option.classList.add('bg-red-100', 'border-red-400');
                    
                    if (!option.innerHTML.includes('‚ùå')) {
                        option.innerHTML += ' ‚ùå WRONG';
                    }
                    console.log(`‚ùå MARKED WRONG: Option ${optionLetter} (user selected this incorrectly)`);
                }
                
                option.disabled = true;
                option.style.pointerEvents = 'none';
            });
            
            // Show feedback message
            if (isCorrect) {
                showQuickFeedback('üéâ Correct! Well done!', 'green');
                console.log('‚úÖ USER WAS CORRECT');
            } else {
                showQuickFeedback(`‚ùå Wrong! The correct answer is ${correctAnswer}`, 'red');
                console.log(`‚ùå USER WAS WRONG - Correct answer was: ${correctAnswer}`);
            }
            
            // Enable next button
            const nextButton = document.getElementById('nextButton');
            nextButton.disabled = false;
            nextButton.classList.remove('opacity-50', 'cursor-not-allowed');
            nextButton.textContent = currentQuestionIndex < currentQuestions.length - 1 ? 'Next Question ‚û°Ô∏è' : 'Finish Quiz üéâ';
        }

        // Move to next question
        function nextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }

        // Show quiz results
        function showResults() {
            showSection('resultsSection');
            
            const totalQuestions = currentQuestions.length;
            const correctCount = userAnswers.filter(answer => answer.isCorrect).length;
            const totalPoints = userAnswers.reduce((sum, answer) => sum + answer.points, 0);
            
            // Update user stats
            userStats.points += totalPoints;
            userStats.totalQuestionsAnswered += totalQuestions;
            userStats.correctAnswers += correctCount;
            
            // Level up logic
            const newLevel = Math.floor(userStats.points / 100) + 1;
            if (newLevel > userStats.level) {
                userStats.level = newLevel;
                showAchievement('üéâ', 'Level Up!', `You've reached Level ${newLevel}!`);
            }
            
            updateUserStats();
            
            // Display results
            document.getElementById('finalScore').textContent = `${correctCount} / ${totalQuestions}`;
            document.getElementById('pointsEarned').textContent = `+${totalPoints} Points`;
            
            // Result emoji and message
            let resultEmoji, resultMessage;
            const percentage = (correctCount / totalQuestions) * 100;
            
            if (percentage >= 90) {
                resultEmoji = 'üèÜ';
                resultMessage = 'Outstanding! You\'re a true smartbuddy!';
            } else if (percentage >= 80) {
                resultEmoji = 'üåü';
                resultMessage = 'Excellent work! Keep it up!';
            } else if (percentage >= 70) {
                resultEmoji = 'üëè';
                resultMessage = 'Good job! You\'re getting better!';
            } else if (percentage >= 50) {
                resultEmoji = 'üí™';
                resultMessage = 'Nice try! Practice makes perfect!';
            } else {
                resultEmoji = 'ü§ó';
                resultMessage = 'Don\'t give up! Every expert was once a beginner!';
            }
            
            document.getElementById('resultEmoji').textContent = resultEmoji;
            document.getElementById('resultTitle').textContent = resultMessage;
            
            // Generate AI feedback
            generateAIFeedback(correctCount, totalQuestions, userAnswers);
        }

        // Generate AI-powered feedback (10 words max)
        function generateAIFeedback(correct, total, answers) {
            const percentage = (correct / total) * 100;
            
            let aiMessage = '';
            
            // Simple encouraging messages - 10 words maximum
            if (percentage >= 90) {
                aiMessage = `üåü Amazing work! You're becoming a super genius!`;
            } else if (percentage >= 80) {
                aiMessage = `üéØ Excellent job! You're getting really smart!`;
            } else if (percentage >= 70) {
                aiMessage = `üëè Great work! Keep practicing and improving!`;
            } else if (percentage >= 50) {
                aiMessage = `üí™ Good try! You're learning so much!`;
            } else {
                aiMessage = `ü§ó Keep going! Every smart kid learns step-by-step!`;
            }
            
            document.getElementById('aiMessage').textContent = aiMessage;
        }

        // Show achievement popup with auto-close (ONLY for game achievements)
        function showAchievement(emoji, title, text) {
            // Make sure we only show achievements for real accomplishments, not during startup
            const achievementPopup = document.getElementById('achievementPopup');
            if (!achievementPopup) return;
            
            document.getElementById('achievementEmoji').textContent = emoji;
            document.getElementById('achievementTitle').textContent = title;
            document.getElementById('achievementText').textContent = text;
            
            // Remove hidden class and show
            achievementPopup.classList.remove('hidden');
            achievementPopup.style.display = 'flex';
            
            // Auto-close after 5 seconds
            setTimeout(() => {
                closeAchievement();
            }, 5000);
        }

        function closeAchievement() {
            const popup = document.getElementById('achievementPopup');
            if (popup) {
                popup.classList.add('hidden');
                popup.style.display = 'none';
            }
        }

        // Add click-to-close functionality as backup
        document.addEventListener('click', function(event) {
            if (event.target.id === 'achievementPopup') {
                closeAchievement();
            }
        });

        // Load and display rewards
        async function loadRewards() {
            // Categorized rewards: digital vs physical (sorted by points - small to big)
            const sampleRewards = [
                // Digital Rewards (Sorted by points - ascending)
                { name: 'Digital Badge Pack', points: 100, emoji: 'üèÜ', description: 'Unlock 5 new achievement badges', type: 'digital', category: 'Digital' },
                { name: 'Avatar Stickers', points: 150, emoji: 'üòé', description: 'Cool stickers for your profile', type: 'digital', category: 'Digital' },
                { name: 'Learning Certificate', points: 200, emoji: 'üìú', description: 'Printable achievement certificate', type: 'digital', category: 'Digital' },
                { name: 'Game Unlock', points: 250, emoji: 'üéÆ', description: 'Access to 5 hidden bonus games', type: 'digital', category: 'Digital', hiddenGames: ['üéØ Target Master', 'üåä Ocean Adventure', 'üöÄ Space Explorer', 'ü¶Å Safari Quest', 'üé™ Circus Fun'] },
                { name: '7-day Premium Access', points: 300, emoji: '‚≠ê', description: 'No ads experience!', type: 'digital', category: 'Digital' },
                
                // Physical Rewards (Sorted by points - ascending)
                { name: 'Physical Sticker Pack', points: 500, emoji: 'üåü', description: 'Real stickers mailed to you', type: 'physical', category: 'Physical', shippingCost: 3 },
                { name: 'Coloring Book', points: 750, emoji: 'üé®', description: 'Educational coloring book', type: 'physical', category: 'Physical', shippingCost: 5 },
                { name: 'Puzzle Game', points: 1000, emoji: 'üß©', description: '24-piece educational puzzle', type: 'physical', category: 'Physical', shippingCost: 8 },
                { name: 'LEGO Set', points: 1500, emoji: 'üß±', description: 'Building blocks for creativity', type: 'physical', category: 'Physical', shippingCost: 12 },
                { name: 'Art Supplies', points: 1800, emoji: 'üñçÔ∏è', description: 'Complete drawing set', type: 'physical', category: 'Physical', shippingCost: 10 },
                { name: 'Science Kit', points: 2000, emoji: 'üî¨', description: 'Hands-on experiments kit', type: 'physical', category: 'Physical', shippingCost: 15 }
            ];
            
            window.sampleRewards = sampleRewards;
        }

        function showRewards() {
            showSection('rewardsSection');
            
            const rewardsGrid = document.getElementById('rewardsGrid');
            const rewards = window.sampleRewards || [];
            
            // Group rewards by category
            const digitalRewards = rewards.filter(r => r.type === 'digital');
            const physicalRewards = rewards.filter(r => r.type === 'physical');
            
            rewardsGrid.innerHTML = `
                <!-- Digital Rewards Section -->
                <div class="col-span-full mb-8">
                    <div class="bg-gradient-to-r from-blue-100 to-indigo-100 rounded-2xl p-6">
                        <h4 class="text-2xl font-bold text-blue-600 mb-4 flex items-center">
                            <span class="text-3xl mr-3">‚ö°</span>
                            Digital Rewards
                        </h4>
                        <p class="text-blue-700 mb-6">Get these rewards instantly! No shipping required.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${digitalRewards.map(reward => {
                                const canAfford = userStats.points >= reward.points;
                                return `
                                    <div class="bg-white rounded-2xl p-4 text-center ${canAfford ? '' : 'opacity-60'} border-2 border-blue-200">
                                        <div class="text-3xl mb-2">${reward.emoji}</div>
                                        <h5 class="text-md font-bold text-gray-800 mb-1">${reward.name}</h5>
                                        <p class="text-xs text-gray-600 mb-2">${reward.description}</p>
                                        <div class="text-lg font-bold text-blue-600 mb-2">${reward.points} points</div>
                                        <button onclick="redeemReward('${reward.name}', ${reward.points}, '${reward.type}')" 
                                                class="${canAfford ? 'bg-blue-500 hover:bg-blue-600' : 'bg-gray-300'} w-full py-2 px-3 rounded-lg text-white font-semibold text-sm" 
                                                ${canAfford ? '' : 'disabled'}>
                                            ${canAfford ? '‚ö° Get Now' : 'üîí Need More'}
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
                
                <!-- Physical Rewards Section -->
                <div class="col-span-full">
                    <div class="bg-gradient-to-r from-orange-100 to-pink-100 rounded-2xl p-6">
                        <h4 class="text-2xl font-bold text-orange-600 mb-4 flex items-center">
                            <span class="text-3xl mr-3">üì¶</span>
                            Physical Rewards
                        </h4>
                        <p class="text-orange-700 mb-6">Real rewards mailed to your home! Parent verification required.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${physicalRewards.map(reward => {
                                const canAfford = userStats.points >= reward.points;
                                return `
                                    <div class="bg-white rounded-2xl p-4 text-center ${canAfford ? '' : 'opacity-60'} border-2 border-orange-200">
                                        <div class="text-3xl mb-2">${reward.emoji}</div>
                                        <h5 class="text-md font-bold text-gray-800 mb-1">${reward.name}</h5>
                                        <p class="text-xs text-gray-600 mb-2">${reward.description}</p>
                                        <div class="text-lg font-bold text-orange-600 mb-1">${reward.points} points</div>
                                        <div class="text-xs text-gray-500 mb-2">+ $${reward.shippingCost} shipping</div>
                                        <button onclick="redeemReward('${reward.name}', ${reward.points}, '${reward.type}')" 
                                                class="${canAfford ? 'bg-orange-500 hover:bg-orange-600' : 'bg-gray-300'} w-full py-2 px-3 rounded-lg text-white font-semibold text-sm" 
                                                ${canAfford ? '' : 'disabled'}>
                                            ${canAfford ? 'üì¶ Order Now' : 'üîí Need More'}
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Smart reward redemption with digital vs physical flow
        function redeemReward(name, points, type, shippingCost = 0) {
            if (userStats.points < points) {
                showQuickFeedback('‚ùå Not enough points!', 'red');
                return;
            }
            
            if (type === 'digital') {
                // Digital rewards - instant delivery
                userStats.points -= points;
                updateUserStats();
                showAchievement('üéÅ', 'Digital Reward Unlocked!', `You've earned ${name}! Check your profile for your new rewards.`);
                showRewards(); // Refresh the rewards display
                console.log(`‚úÖ Digital reward redeemed: ${name}`);
            } else if (type === 'physical') {
                // Physical rewards - require parent verification with smart shipping
                console.log(`üì¶ Physical reward redemption started: ${name}`);
                window.pendingReward = { name, points, type, shippingCost };
                showShippingLocationPopup(name, shippingCost);
            }
        }

        // Show shipping location popup to determine shipping category
        function showShippingLocationPopup(rewardName, baseShippingCost) {
            const popup = document.createElement('div');
            popup.id = 'shippingLocationPopup';
            popup.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 1rem;';
            
            popup.innerHTML = `
                <div class="bg-white rounded-3xl p-8 text-center max-w-md relative overflow-hidden">
                    <button onclick="closeShippingLocationPopup()" class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-gray-600">√ó</button>
                    
                    <div class="text-6xl mb-4">üåç</div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Choose Your Location</h3>
                    <div class="bg-orange-50 rounded-xl p-4 mb-6">
                        <p class="text-orange-800 font-semibold mb-2">üéÅ ${rewardName}</p>
                        <p class="text-sm text-orange-700">Shipping costs vary by location and package size</p>
                    </div>
                    
                    <!-- Hong Kong Options -->
                    <div class="mb-6">
                        <h4 class="text-lg font-bold text-gray-800 mb-3">üá≠üá∞ Hong Kong</h4>
                        <div class="space-y-2 text-left">
                            <button onclick="selectShippingCategory('A', 'Hong Kong (Small Package)', 5)" 
                                    class="w-full bg-green-50 hover:bg-green-100 border-2 border-green-200 hover:border-green-400 p-3 rounded-xl transition-all duration-200 text-left">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <div class="font-semibold text-gray-800">üìÆ Category A - HK$5</div>
                                        <div class="text-sm text-gray-600">Small items (stickers, cards, certificates)</div>
                                    </div>
                                </div>
                            </button>
                            <button onclick="selectShippingCategory('B', 'Hong Kong (Medium Package)', 10)" 
                                    class="w-full bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 hover:border-blue-400 p-3 rounded-xl transition-all duration-200 text-left">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <div class="font-semibold text-gray-800">üì¶ Category B - HK$10</div>
                                        <div class="text-sm text-gray-600">Medium items (books, puzzles, art supplies)</div>
                                    </div>
                                </div>
                            </button>
                            <button onclick="selectShippingCategory('C', 'Hong Kong (Large Package)', 20)" 
                                    class="w-full bg-purple-50 hover:bg-purple-100 border-2 border-purple-200 hover:border-purple-400 p-3 rounded-xl transition-all duration-200 text-left">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <div class="font-semibold text-gray-800">üì¨ Category C - HK$20</div>
                                        <div class="text-sm text-gray-600">Large items (LEGO sets, science kits)</div>
                                    </div>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Overseas Options -->
                    <div class="mb-6">
                        <h4 class="text-lg font-bold text-gray-800 mb-3">üåè Overseas Shipping</h4>
                        <button onclick="selectShippingCategory('C', 'Overseas (All Sizes)', 20)" 
                                class="w-full bg-orange-50 hover:bg-orange-100 border-2 border-orange-200 hover:border-orange-400 p-3 rounded-xl transition-all duration-200 text-left">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-semibold text-gray-800">üåç Category C - HK$20</div>
                                    <div class="text-sm text-gray-600">International shipping (any size item)</div>
                                </div>
                            </div>
                        </button>
                    </div>
                    
                    <div class="mt-4 text-xs text-gray-500">
                        üí° Choose the category that best matches your item size and location
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
        }

        // Select shipping category and proceed to parent verification
        function selectShippingCategory(category, description, hkdCost) {
            // Store shipping info
            window.pendingReward.shippingCategory = category;
            window.pendingReward.shippingDescription = description;
            window.pendingReward.shippingHKDCost = hkdCost;
            
            // Close shipping popup
            closeShippingLocationPopup();
            
            // Show parent verification with shipping details
            setTimeout(() => {
                showParentVerificationPopup(window.pendingReward.name);
            }, 200);
        }

        // Close shipping location popup
        function closeShippingLocationPopup() {
            const popup = document.getElementById('shippingLocationPopup');
            if (popup) {
                popup.remove();
            }
        }

        // Show parent email verification popup for physical rewards
        function showParentVerificationPopup(rewardName) {
            const reward = window.pendingReward;
            const shippingInfo = reward.shippingDescription || 'Shipping';
            const shippingCost = reward.shippingHKDCost || 20;
            
            const popup = document.createElement('div');
            popup.id = 'parentVerificationPopup';
            popup.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 1rem;';
            
            popup.innerHTML = `
                <div class="bg-white rounded-3xl p-8 text-center max-w-md relative overflow-hidden">
                    <button onclick="closeParentVerification()" class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-gray-600">√ó</button>
                    
                    <!-- Decorative elements -->
                    <div class="absolute top-2 left-4 text-yellow-400 text-xl animate-bounce">üì¶</div>
                    <div class="absolute top-4 right-12 text-pink-400 text-lg animate-pulse">‚ú®</div>
                    
                    <div class="text-6xl mb-4">üìß</div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Parent Verification Required</h3>
                    <div class="bg-orange-50 rounded-xl p-4 mb-6">
                        <p class="text-orange-800 font-semibold mb-2">üéÅ ${rewardName}</p>
                        <p class="text-sm text-orange-700 mb-2">You've earned a real reward! We need a parent's email to ship it to you.</p>
                        <div class="bg-white rounded-lg p-3 mt-3">
                            <div class="text-sm font-semibold text-gray-700">üì¶ ${shippingInfo}</div>
                            <div class="text-lg font-bold text-green-600">HK$${shippingCost} shipping</div>
                        </div>
                    </div>
                    
                    <div class="text-left mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Parent's Email Address:</label>
                        <input type="email" id="parentEmail" placeholder="parent@email.com" 
                               class="w-full text-base p-3 border-2 border-gray-200 rounded-xl focus:border-blue-400 focus:outline-none"
                               maxlength="100">
                        <p class="text-xs text-gray-500 mt-2">üìß Your parent will receive an email to confirm shipping details and pay HK$${shippingCost} shipping</p>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="sendParentVerification()" id="sendVerificationBtn" 
                                class="w-full bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white py-3 px-6 rounded-xl font-bold transition-all duration-300">
                            üìß Send Verification Email
                        </button>
                        <button onclick="closeParentVerification()" 
                                class="w-full bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-xl font-semibold">
                            Maybe Later
                        </button>
                    </div>
                    
                    <div class="mt-4 text-xs text-gray-500">
                        üîí We respect your privacy. Your email is only used for reward delivery.
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Focus on email input
            setTimeout(() => {
                document.getElementById('parentEmail').focus();
            }, 300);
        }

        // Send parent verification email
        function sendParentVerification() {
            const emailInput = document.getElementById('parentEmail');
            const email = emailInput.value.trim();
            
            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!email || !emailRegex.test(email)) {
                emailInput.style.borderColor = '#ef4444';
                showQuickFeedback('‚ùå Please enter a valid email address', 'red');
                return;
            }
            
            // Show sending state
            const sendBtn = document.getElementById('sendVerificationBtn');
            sendBtn.innerHTML = 'üìß Sending...';
            sendBtn.disabled = true;
            
            // SMART POINT MANAGEMENT: Reserve points instead of deducting
            const reward = window.pendingReward;
            if (!userStats.reservedRewards) {
                userStats.reservedRewards = [];
            }
            
            // Create pending reward entry
            const pendingRewardId = 'PR_' + Date.now();
            const pendingReward = {
                id: pendingRewardId,
                name: reward.name,
                points: reward.points,
                type: reward.type,
                parentEmail: email,
                language: appSettings.language,
                dateRequested: new Date().toISOString(),
                expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 7 days
                status: 'pending_parent_confirmation'
            };
            
            userStats.reservedRewards.push(pendingReward);
            console.log(`üí∞ Points reserved (not deducted): ${reward.points} points for ${reward.name}`);
            
            // Simulate backend API call to send multi-language email
            setTimeout(() => {
                const emailTemplate = getEmailTemplate(appSettings.language, pendingReward);
                console.log('üìß Email Template:', emailTemplate);
                
                closeParentVerification();
                showParentEmailSentPopup(email, reward.name, pendingRewardId);
                console.log(`üìß Multi-language parent verification email sent to: ${email}`);
                console.log(`üéÅ Pending reward ID: ${pendingRewardId}`);
                
                // Set auto-expiry for demo purposes
                setTimeout(() => {
                    handleRewardExpiry(pendingRewardId);
                }, 30000); // 30 seconds for demo (7 days in production)
                
            }, 2000);
        }

        // Get email template based on language
        function getEmailTemplate(language, pendingReward) {
            const templates = {
                english: {
                    subject: `üéâ Your child earned a reward on SmartBuddy!`,
                    body: `
                        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #f9f9f9; padding: 20px;">
                            <div style="background: white; padding: 30px; border-radius: 15px; text-align: center;">
                                <h1 style="color: #FF6B9D; margin-bottom: 20px;">üéâ Congratulations!</h1>
                                <p style="font-size: 18px; color: #333; margin-bottom: 20px;">
                                    Your child just earned enough points for a <strong>${pendingReward.name}</strong>!
                                </p>
                                
                                <div style="background: #FFF3E0; padding: 20px; border-radius: 10px; margin: 20px 0;">
                                    <h3 style="color: #FF9A56; margin-bottom: 15px;">üì¶ Next Steps:</h3>
                                    <ol style="text-align: left; color: #666; line-height: 1.6;">
                                        <li><strong>Click the confirm button below</strong></li>
                                        <li><strong>Enter your shipping address</strong> (one-time only)</li>
                                        <li><strong>We'll ship your reward</strong> within 3-5 business days</li>
                                    </ol>
                                </div>
                                
                                <a href="${getParentConfirmationUrl(pendingReward.id, 'english')}" 
                                   style="display: inline-block; background: linear-gradient(45deg, #FF9A56, #FF6B9D); color: white; padding: 15px 30px; text-decoration: none; border-radius: 25px; font-weight: bold; font-size: 16px; margin: 20px 0;">
                                    ‚úÖ Confirm Shipping Address
                                </a>
                                
                                <div style="background: #E3F2FD; padding: 15px; border-radius: 10px; margin: 20px 0;">
                                    <p style="color: #1976D2; margin: 0; font-size: 14px;">
                                        ‚è∞ <strong>Important:</strong> You have 7 days to confirm. If not confirmed, points will be returned to your child's account.
                                    </p>
                                </div>
                                
                                <p style="font-size: 12px; color: #888; margin-top: 30px;">
                                    This email was sent because your child redeemed points on SmartBuddy.<br>
                                    Visit <a href="https://smartbuddy.com">SmartBuddy.com</a> for more information.
                                </p>
                            </div>
                        </div>
                    `
                },
                
                traditional: {
                    subject: `üéâ ÊÇ®ÁöÑÂ≠©Â≠êÂú®SmartBuddyÁç≤Âæó‰∫ÜÁçéÂãµÔºÅ`,
                    body: `
                        <div style="font-family: Arial, 'Microsoft JhengHei', sans-serif; max-width: 600px; margin: 0 auto; background: #f9f9f9; padding: 20px;">
                            <div style="background: white; padding: 30px; border-radius: 15px; text-align: center;">
                                <h1 style="color: #FF6B9D; margin-bottom: 20px;">üéâ ÊÅ≠ÂñúÔºÅ</h1>
                                <p style="font-size: 18px; color: #333; margin-bottom: 20px;">
                                    ÊÇ®ÁöÑÂ≠©Â≠êÂâõÂâõË≥∫Âèñ‰∫ÜË∂≥Â§†ÁöÑÁ©çÂàÜ‰æÜÂÖåÊèõ<strong>${pendingReward.name}</strong>ÔºÅ
                                </p>
                                
                                <div style="background: #FFF3E0; padding: 20px; border-radius: 10px; margin: 20px 0;">
                                    <h3 style="color: #FF9A56; margin-bottom: 15px;">üì¶ Êé•‰∏ã‰æÜÁöÑÊ≠•È©üÔºö</h3>
                                    <ol style="text-align: left; color: #666; line-height: 1.6;">
                                        <li><strong>ÈªûÊìä‰∏ãÊñπÁöÑÁ¢∫Ë™çÊåâÈàï</strong></li>
                                        <li><strong>Ëº∏ÂÖ•ÊÇ®ÁöÑÈÉµÂØÑÂú∞ÂùÄ</strong>ÔºàÂÉÖÈúÄ‰∏ÄÊ¨°Ôºâ</li>
                                        <li><strong>ÊàëÂÄëÂ∞áÈÉµÂØÑÊÇ®ÁöÑÁçéÂãµ</strong>Ôºå3-5ÂÄãÂ∑•‰ΩúÊó•ÂÖßÈÄÅÈÅî</li>
                                    </ol>
                                </div>
                                
                                <a href="${getParentConfirmationUrl(pendingReward.id, 'traditional')}" 
                                   style="display: inline-block; background: linear-gradient(45deg, #FF9A56, #FF6B9D); color: white; padding: 15px 30px; text-decoration: none; border-radius: 25px; font-weight: bold; font-size: 16px; margin: 20px 0;">
                                    ‚úÖ Á¢∫Ë™çÈÉµÂØÑÂú∞ÂùÄ
                                </a>
                                
                                <div style="background: #E3F2FD; padding: 15px; border-radius: 10px; margin: 20px 0;">
                                    <p style="color: #1976D2; margin: 0; font-size: 14px;">
                                        ‚è∞ <strong>ÈáçË¶ÅÊèêÈÜíÔºö</strong> ÊÇ®Êúâ7Â§©ÊôÇÈñìÁ¢∫Ë™ç„ÄÇÂ¶ÇÊú™Á¢∫Ë™çÔºåÁ©çÂàÜÂ∞áÈÄÄÈÇÑÂà∞ÊÇ®Â≠©Â≠êÁöÑÂ∏≥Êà∂„ÄÇ
                                    </p>
                                </div>
                                
                                <p style="font-size: 12px; color: #888; margin-top: 30px;">
                                    Ê≠§ÈÉµ‰ª∂ÊòØÂõ†ÁÇ∫ÊÇ®ÁöÑÂ≠©Â≠êÂú®SmartBuddy‰∏äÂÖåÊèõ‰∫ÜÁ©çÂàÜËÄåÁôºÈÄÅÁöÑ„ÄÇ<br>
                                    Ë®™Âïè <a href="https://smartbuddy.com">SmartBuddy.com</a> ‰∫ÜËß£Êõ¥Â§ö‰ø°ÊÅØ„ÄÇ
                                </p>
                            </div>
                        </div>
                    `
                },
                
                simplified: {
                    subject: `üéâ ÊÇ®ÁöÑÂ≠©Â≠êÂú®SmartBuddyËé∑Âæó‰∫ÜÂ•ñÂä±ÔºÅ`,
                    body: `
                        <div style="font-family: Arial, 'Microsoft YaHei', sans-serif; max-width: 600px; margin: 0 auto; background: #f9f9f9; padding: 20px;">
                            <div style="background: white; padding: 30px; border-radius: 15px; text-align: center;">
                                <h1 style="color: #FF6B9D; margin-bottom: 20px;">üéâ ÊÅ≠ÂñúÔºÅ</h1>
                                <p style="font-size: 18px; color: #333; margin-bottom: 20px;">
                                    ÊÇ®ÁöÑÂ≠©Â≠êÂàöÂàöËµöÂèñ‰∫ÜË∂≥Â§üÁöÑÁßØÂàÜÊù•ÂÖëÊç¢<strong>${pendingReward.name}</strong>ÔºÅ
                                </p>
                                
                                <div style="background: #FFF3E0; padding: 20px; border-radius: 10px; margin: 20px 0;">
                                    <h3 style="color: #FF9A56; margin-bottom: 15px;">üì¶ Êé•‰∏ãÊù•ÁöÑÊ≠•È™§Ôºö</h3>
                                    <ol style="text-align: left; color: #666; line-height: 1.6;">
                                        <li><strong>ÁÇπÂáª‰∏ãÊñπÁöÑÁ°ÆËÆ§ÊåâÈíÆ</strong></li>
                                        <li><strong>ËæìÂÖ•ÊÇ®ÁöÑÈÇÆÂØÑÂú∞ÂùÄ</strong>Ôºà‰ªÖÈúÄ‰∏ÄÊ¨°Ôºâ</li>
                                        <li><strong>Êàë‰ª¨Â∞ÜÈÇÆÂØÑÊÇ®ÁöÑÂ•ñÂä±</strong>Ôºå3-5‰∏™Â∑•‰ΩúÊó•ÂÜÖÈÄÅËææ</li>
                                    </ol>
                                </div>
                                
                                <a href="${getParentConfirmationUrl(pendingReward.id, 'simplified')}" 
                                   style="display: inline-block; background: linear-gradient(45deg, #FF9A56, #FF6B9D); color: white; padding: 15px 30px; text-decoration: none; border-radius: 25px; font-weight: bold; font-size: 16px; margin: 20px 0;">
                                    ‚úÖ Á°ÆËÆ§ÈÇÆÂØÑÂú∞ÂùÄ
                                </a>
                                
                                <div style="background: #E3F2FD; padding: 15px; border-radius: 10px; margin: 20px 0;">
                                    <p style="color: #1976D2; margin: 0; font-size: 14px;">
                                        ‚è∞ <strong>ÈáçË¶ÅÊèêÈÜíÔºö</strong> ÊÇ®Êúâ7Â§©Êó∂Èó¥Á°ÆËÆ§„ÄÇÂ¶ÇÊú™Á°ÆËÆ§ÔºåÁßØÂàÜÂ∞ÜÈÄÄËøòÂà∞ÊÇ®Â≠©Â≠êÁöÑË¥¶Êà∑„ÄÇ
                                    </p>
                                </div>
                                
                                <p style="font-size: 12px; color: #888; margin-top: 30px;">
                                    Ê≠§ÈÇÆ‰ª∂ÊòØÂõ†‰∏∫ÊÇ®ÁöÑÂ≠©Â≠êÂú®SmartBuddy‰∏äÂÖëÊç¢‰∫ÜÁßØÂàÜËÄåÂèëÈÄÅÁöÑ„ÄÇ<br>
                                    ËÆøÈóÆ <a href="https://smartbuddy.com">SmartBuddy.com</a> ‰∫ÜËß£Êõ¥Â§ö‰ø°ÊÅØ„ÄÇ
                                </p>
                            </div>
                        </div>
                    `
                }
            };
            
            return templates[language] || templates.english;
        }

        // Generate parent confirmation URL
        function getParentConfirmationUrl(rewardId, language) {
            const baseUrl = 'https://smartbuddy.com/parent-confirm';
            return `${baseUrl}?reward=${rewardId}&lang=${language}&token=${generateSecureToken()}`;
        }

        // Generate secure token for parent confirmation
        function generateSecureToken() {
            return 'TOKEN_' + Math.random().toString(36).substr(2, 16) + Date.now().toString(36);
        }

        // Handle reward expiry and return points
        function handleRewardExpiry(rewardId) {
            if (!userStats.reservedRewards) return;
            
            const rewardIndex = userStats.reservedRewards.findIndex(r => r.id === rewardId);
            if (rewardIndex === -1) return;
            
            const expiredReward = userStats.reservedRewards[rewardIndex];
            if (expiredReward.status !== 'pending_parent_confirmation') return;
            
            // Return points to user
            userStats.points += expiredReward.points;
            updateUserStats();
            
            // Remove from reserved rewards
            userStats.reservedRewards.splice(rewardIndex, 1);
            
            // Show notification to user
            showAchievement('üîÑ', 'Points Returned!', `Your ${expiredReward.points} points for ${expiredReward.name} have been returned. Parent didn't confirm shipping in time.`);
            
            console.log(`üí∞ POINTS RETURNED: ${expiredReward.points} points returned for expired reward: ${expiredReward.name}`);
        }

        // Show confirmation that parent email was sent
        function showParentEmailSentPopup(parentEmail, rewardName, pendingRewardId) {
            // Also create admin dashboard entry
            if (!window.adminDashboard) {
                window.adminDashboard = {
                    pendingRewards: [],
                    completedRewards: [],
                    totalRevenue: 0,
                    userStats: { totalUsers: 1, activeUsers: 1, premiumUsers: 0 }
                };
            }
            
            window.adminDashboard.pendingRewards.push({
                id: pendingRewardId,
                rewardName: rewardName,
                parentEmail: parentEmail,
                language: appSettings.language,
                dateRequested: new Date().toISOString(),
                status: 'pending_confirmation',
                childId: 'DEMO_USER_001'
            });
            const popup = document.createElement('div');
            popup.id = 'emailSentPopup';
            popup.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 1rem;';
            
            popup.innerHTML = `
                <div class="bg-white rounded-3xl p-8 text-center max-w-lg relative overflow-hidden">
                    <button onclick="closeEmailSentPopup()" class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-gray-600">√ó</button>
                    
                    <!-- Animated decorative elements -->
                    <div class="absolute top-2 left-4 text-green-400 text-2xl animate-bounce">‚úÖ</div>
                    <div class="absolute top-4 right-12 text-blue-400 text-xl animate-pulse">üìß</div>
                    <div class="absolute bottom-4 left-6 text-yellow-400 text-lg animate-bounce">üéâ</div>
                    
                    <div class="text-6xl mb-4 animate-pulse">üì¨</div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Email Sent Successfully!</h3>
                    
                    <div class="bg-gradient-to-br from-green-50 to-blue-50 rounded-2xl p-6 mb-6 text-left">
                        <h4 class="font-bold text-green-800 mb-3 flex items-center">
                            <span class="text-2xl mr-2">üìß</span>
                            What happens next?
                        </h4>
                        <div class="space-y-3 text-sm text-gray-700">
                            <div class="flex items-start space-x-3">
                                <span class="text-blue-500 font-bold">1.</span>
                                <div>
                                    <strong>Parent receives email:</strong><br>
                                    <code class="text-xs bg-gray-100 px-2 py-1 rounded">${parentEmail}</code>
                                </div>
                            </div>
                            <div class="flex items-start space-x-3">
                                <span class="text-blue-500 font-bold">2.</span>
                                <div><strong>They confirm</strong> and enter shipping address</div>
                            </div>
                            <div class="flex items-start space-x-3">
                                <span class="text-blue-500 font-bold">3.</span>
                                <div><strong>We ship your ${rewardName}</strong> within 3-5 days!</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 rounded-xl p-4 mb-6">
                        <h5 class="font-semibold text-yellow-800 mb-2">üìã Important Notes:</h5>
                        <ul class="text-sm text-yellow-700 text-left space-y-1">
                            <li>‚Ä¢ Email may take 2-3 minutes to arrive</li>
                            <li>‚Ä¢ Check spam/junk folder if not received</li>
                            <li>‚Ä¢ Parent has 7 days to confirm shipping</li>
                            <li>‚Ä¢ Your points are reserved until confirmed</li>
                        </ul>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="closeEmailSentPopup()" 
                                class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white py-3 px-6 rounded-xl font-bold">
                            üéâ Awesome! Continue Learning
                        </button>
                        <button onclick="viewPendingRewards()" 
                                class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-xl font-semibold">
                            üì¶ View Pending Rewards
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
        }

        // Close parent verification popup
        function closeParentVerification() {
            const popup = document.getElementById('parentVerificationPopup');
            if (popup) {
                popup.remove();
            }
        }

        // Close email sent popup
        function closeEmailSentPopup() {
            const popup = document.getElementById('emailSentPopup');
            if (popup) {
                popup.remove();
            }
        }

        // View pending rewards (placeholder function)
        function viewPendingRewards() {
            closeEmailSentPopup();
            showQuickFeedback('üì¶ Pending rewards feature coming soon!', 'blue');
            console.log('üì¶ Showing pending rewards...');
            // In production, this would show a list of rewards awaiting parent confirmation
        }

        function showProgress() {
            showSection('progressSection');
            
            // Update all progress elements with current data
            const accuracy = userStats.totalQuestionsAnswered > 0 ? 
                Math.round((userStats.correctAnswers / userStats.totalQuestionsAnswered) * 100) : 0;
            
            // Update main stats cards
            document.getElementById('progressLevel').textContent = `Level ${userStats.level}`;
            document.getElementById('progressPoints').textContent = `${userStats.points} Points`;
            document.getElementById('progressStreak').textContent = `${userStats.streak} Day${userStats.streak !== 1 ? 's' : ''}`;
            
            // Update quiz progress section
            document.getElementById('progressQuestionsAnswered').textContent = userStats.totalQuestionsAnswered;
            document.getElementById('progressCorrectAnswers').textContent = userStats.correctAnswers;
            document.getElementById('progressAccuracy').textContent = `${accuracy}%`;
            
            // Update level progress section
            document.getElementById('progressCurrentLevel').textContent = userStats.level;
            
            // Calculate progress to next level
            const pointsInCurrentLevel = userStats.points % 100;
            const nextLevelPoints = 100;
            const progressPercent = (pointsInCurrentLevel / nextLevelPoints) * 100;
            const pointsNeeded = nextLevelPoints - pointsInCurrentLevel;
            
            document.getElementById('levelProgressBar').style.width = `${progressPercent}%`;
            document.getElementById('pointsToNextLevel').textContent = `Need ${pointsNeeded} more points for Level ${userStats.level + 1}`;
        }

        // Utility function to shuffle array
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Auto-start main app (skip test screen)
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ Page loaded successfully');
            console.log('üöÄ Starting main app directly...');
            
            // Check if we're on welcome/test screen
            const welcomeScreen = document.querySelector('#connectionStatus');
            if (welcomeScreen) {
                console.log('üì± Going directly to main app immediately');
                showFullApp(); // Remove delay - go immediately
            } else {
                console.log('‚ö†Ô∏è Already in main app mode');
            }
        });

        // ===== STREAK SYSTEM FUNCTIONS =====
        
        // Show streak popup on app start
        function showStreakPopup() {
            // Update streak based on last login
            updateDailyStreak();
            
            const currentStreak = userStats.streak;
            const nextPrizes = [
                { days: 3, name: 'Fun Stickers', emoji: 'üåü' },
                { days: 7, name: 'Coloring Book', emoji: 'üé®' },
                { days: 14, name: 'Puzzle Game', emoji: 'üß©' },
                { days: 21, name: 'LEGO Set', emoji: 'üß±' },
                { days: 30, name: 'Science Kit', emoji: 'üî¨' }
            ];
            
            // Find next prize
            const nextPrize = nextPrizes.find(prize => currentStreak < prize.days) || nextPrizes[nextPrizes.length - 1];
            const progressPercent = Math.min((currentStreak / nextPrize.days) * 100, 100);
            
            // Update streak display
            document.getElementById('currentStreak').textContent = `${currentStreak} Day${currentStreak !== 1 ? 's' : ''}`;
            document.getElementById('nextPrize').textContent = `${nextPrize.emoji} ${nextPrize.name}`;
            document.getElementById('streakProgressBar').style.width = `${progressPercent}%`;
            document.getElementById('daysProgress').textContent = `Day ${currentStreak}`;
            document.getElementById('daysTarget').textContent = `Day ${nextPrize.days} Goal`;
            
            // Update streak message
            let streakMessage = '';
            if (currentStreak === 0) {
                streakMessage = 'Start your learning journey today!';
                document.getElementById('streakMainEmoji').textContent = 'üéØ';
                document.getElementById('streakTitle').textContent = 'Ready to Learn?';
            } else if (currentStreak < 3) {
                streakMessage = 'Great start! Keep the momentum going!';
                document.getElementById('streakMainEmoji').textContent = 'üî•';
                document.getElementById('streakTitle').textContent = 'Building Your Streak!';
            } else if (currentStreak < 7) {
                streakMessage = 'Amazing! You\'re getting close to your first prize!';
                document.getElementById('streakMainEmoji').textContent = 'üî•';
                document.getElementById('streakTitle').textContent = 'On Fire!';
            } else if (currentStreak < 14) {
                streakMessage = 'Fantastic! You\'re developing a great learning habit!';
                document.getElementById('streakMainEmoji').textContent = 'üî•';
                document.getElementById('streakTitle').textContent = 'Learning Master!';
            } else {
                streakMessage = 'Outstanding! You\'re a true learning champion!';
                document.getElementById('streakMainEmoji').textContent = 'üëë';
                document.getElementById('streakTitle').textContent = 'Learning Champion!';
            }
            
            document.getElementById('streakMessage').textContent = streakMessage;
            
            // Generate calendar
            generateStreakCalendar();
            
            // Show popup with BULLETPROOF display
            const popup = document.getElementById('streakPopup');
            popup.classList.remove('hidden');
            popup.style.display = 'block';
            popup.style.visibility = 'visible';
            popup.style.opacity = '1';
            
            console.log('üî• Streak popup shown with bulletproof display');
            
            // BULLETPROOF EVENT HANDLING - Multiple Methods
            setTimeout(() => {
                console.log('üîß Setting up bulletproof event listeners...');
                
                // Method 1: Event Listeners on specific buttons
                const learnButton = document.getElementById('streakLearnButton');
                const prizesButton = document.getElementById('streakPrizesButton');
                const closeButton1 = document.getElementById('closeButton1');
                const closeButton2 = document.getElementById('closeButton2');
                
                // Remove any existing listeners first
                if (learnButton) {
                    learnButton.removeEventListener('click', closeStreak);
                    learnButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('üöÄ Learn button clicked - closing popup');
                        closeStreak();
                    });
                    console.log('‚úÖ Learn button listener attached');
                }
                
                if (prizesButton) {
                    prizesButton.removeEventListener('click', showStreakRewards);
                    prizesButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('üéÅ Prizes button clicked - showing rewards');
                        showStreakRewards();
                    });
                    console.log('‚úÖ Prizes button listener attached');
                }
                
                if (closeButton1) {
                    closeButton1.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('‚ùå Close button 1 clicked');
                        closeStreak();
                    });
                    console.log('‚úÖ Close button 1 listener attached');
                }
                
                if (closeButton2) {
                    closeButton2.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('‚ùå Close button 2 clicked');
                        closeStreak();
                    });
                    console.log('‚úÖ Close button 2 listener attached');
                }
                
                // Method 2: Global click handler for emergency close
                window.streakPopupClickHandler = function(e) {
                    const popup = document.getElementById('streakPopup');
                    if (e.target === popup) {
                        console.log('üëÜ Background clicked - closing popup');
                        closeStreak();
                    }
                };
                
                popup.addEventListener('click', window.streakPopupClickHandler);
                console.log('‚úÖ Background click listener attached');
                
                // Method 3: Keyboard handlers
                window.streakPopupKeyHandler = function(e) {
                    if (e.key === 'Escape') {
                        console.log('‚å®Ô∏è Escape key pressed - closing popup');
                        closeStreak();
                    }
                };
                
                document.addEventListener('keydown', window.streakPopupKeyHandler);
                console.log('‚úÖ Keyboard escape listener attached');
                
                console.log('üéØ All bulletproof event listeners ready!');
                
            }, 200);
        }
        
        // Generate visual streak calendar
        function generateStreakCalendar() {
            const today = new Date();
            const currentStreak = userStats.streak;
            const calendar = document.getElementById('streakCalendar');
            
            const dayNames = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            const dayEmojis = ['üå∏', 'ü¶ã', 'üåü', 'üéà', 'ü¶Ñ', 'üç≠', 'üåà'];
            
            let calendarHtml = '';
            
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(today);
                dayDate.setDate(today.getDate() - (6 - i));
                
                const isActive = i < (currentStreak < 7 ? currentStreak : 7);
                const isToday = i === 6;
                
                calendarHtml += `
                    <div class="text-center">
                        <div class="text-xs text-gray-600 mb-1">${dayNames[i]}</div>
                        <div class="w-8 h-8 rounded-full ${isActive ? 'bg-orange-200 border-2 border-orange-400' : 'bg-gray-100 border-2 border-gray-200'} 
                             flex items-center justify-center text-sm ${isToday ? 'animate-pulse' : ''}">
                            ${isActive ? dayEmojis[i] : '‚óã'}
                        </div>
                    </div>
                `;
            }
            
            calendar.innerHTML = calendarHtml;
        }
        
        // Update daily streak logic (sandbox compatible - no localStorage)
        function updateDailyStreak() {
            // For demo purposes, simulate streak progression
            // In production, this would check against server-side user data
            const today = new Date().toDateString();
            
            // Keep current streak for demo (in production: check against last login)
            if (userStats.lastLoginDate !== today) {
                // Simulate new day login
                userStats.lastLoginDate = today;
                // For demo, just keep the current streak
            }
            
            updateUserStats();
        }
        
        // BULLETPROOF Close streak popup function
        function closeStreak() {
            console.log('üî• BULLETPROOF: Closing streak popup...');
            
            try {
                const popup = document.getElementById('streakPopup');
                if (popup) {
                    // Method 1: CSS classes
                    popup.classList.add('hidden');
                    
                    // Method 2: Inline styles (FORCE HIDE)
                    popup.style.display = 'none';
                    popup.style.visibility = 'hidden';
                    popup.style.opacity = '0';
                    popup.style.pointerEvents = 'none';
                    
                    // Method 3: Remove from DOM temporarily
                    const parent = popup.parentNode;
                    if (parent) {
                        popup.remove();
                        setTimeout(() => {
                            // Add it back but keep it hidden
                            parent.appendChild(popup);
                        }, 100);
                    }
                    
                    console.log('‚úÖ BULLETPROOF: Streak popup closed with multiple methods');
                } else {
                    console.log('‚ö†Ô∏è BULLETPROOF: Popup element not found');
                }
                
                // Clean up event listeners
                if (window.streakPopupClickHandler) {
                    document.removeEventListener('click', window.streakPopupClickHandler);
                }
                if (window.streakPopupKeyHandler) {
                    document.removeEventListener('keydown', window.streakPopupKeyHandler);
                }
                
                console.log('‚úÖ BULLETPROOF: Event listeners cleaned up');
                
            } catch (error) {
                console.error('‚ùå BULLETPROOF: Error closing popup:', error);
                
                // EMERGENCY FALLBACK: Hide by setting body content
                try {
                    const allPopups = document.querySelectorAll('[id*="Popup"]');
                    allPopups.forEach(p => {
                        p.style.display = 'none';
                        p.classList.add('hidden');
                    });
                    console.log('üö® BULLETPROOF: Emergency fallback executed');
                } catch (emergencyError) {
                    console.error('üí• BULLETPROOF: Emergency fallback failed:', emergencyError);
                }
            }
        }
        
        // Show streak rewards
        function showStreakRewards() {
            console.log('üéÅ Showing streak rewards...');
            closeStreak();
            setTimeout(() => {
                showRewards();
            }, 100); // Small delay to ensure popup closes first
        }

        // EMERGENCY NUCLEAR OPTION - Force close all popups
        function forceCloseAllPopups() {
            console.log('üí• NUCLEAR OPTION: Force closing all popups');
            
            // Hide all elements with 'popup' in ID or class
            const allElements = document.querySelectorAll('*');
            allElements.forEach(el => {
                if (el.id && el.id.toLowerCase().includes('popup')) {
                    el.style.display = 'none !important';
                    el.style.visibility = 'hidden !important';
                    el.style.opacity = '0 !important';
                    el.classList.add('hidden');
                    el.remove();
                }
            });
            
            // Add a temporary override button to body
            const overrideBtn = document.createElement('button');
            overrideBtn.innerHTML = 'üö® POPUP CLEARED';
            overrideBtn.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #00ff00; color: black; padding: 10px; border: none; border-radius: 5px; z-index: 99999; font-weight: bold;';
            document.body.appendChild(overrideBtn);
            
            setTimeout(() => {
                overrideBtn.remove();
            }, 3000);
            
            console.log('‚úÖ NUCLEAR OPTION: All popups should be gone');
        }

        // Add a secret key combination to trigger nuclear option
        let keySequence = [];
        document.addEventListener('keydown', function(e) {
            keySequence.push(e.key);
            if (keySequence.length > 5) keySequence.shift();
            
            // Press: CTRL + ALT + X to force close
            if (e.ctrlKey && e.altKey && e.key === 'x') {
                forceCloseAllPopups();
            }
        });
        
        // Enhanced popup close functionality
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeAchievement();
                closeStreak();
            }
        });

        // Click outside to close streak popup (background only)
        document.addEventListener('click', function(event) {
            const streakPopup = document.getElementById('streakPopup');
            if (event.target === streakPopup) {
                closeStreak();
            }
        });

        // ===== SETTINGS FUNCTIONS =====
        
        // Global settings state
        let appSettings = {
            language: 'english',
            musicEnabled: true,
            vibrationEnabled: true,
            darkModeEnabled: false
        };

        // Avatar Home System
        let avatarProfile = {
            // Avatar appearance
            gender: 'boy', // 'boy' or 'girl'
            skinTone: 'light', // 'light', 'medium', 'dark'
            hairStyle: 'short', // 'short', 'long', 'curly', 'pigtails'
            hairColor: 'brown', // 'brown', 'black', 'blonde', 'red'
            outfit: 'casual', // 'casual', 'school', 'sports', 'formal'
            
            // Home customization
            wallpaper: 'rainbow', // 'rainbow', 'stars', 'ocean', 'forest', 'space'
            furniture: {
                bed: 'basic', // 'basic', 'princess', 'race-car', 'bunk'
                desk: 'wooden', // 'wooden', 'modern', 'glass', 'colorful'
                chair: 'simple', // 'simple', 'gaming', 'bean-bag', 'throne'
                decorations: ['plant'] // array of decorations owned
            },
            
            // Inventory of unlocked customizations
            unlockedItems: {
                outfits: ['casual'],
                wallpapers: ['rainbow'],
                furniture: ['basic-bed', 'wooden-desk', 'simple-chair'],
                decorations: ['plant']
            }
        };

        // Show settings page
        function showSettings() {
            showSection('settingsSection');
            updateSettingsDisplay();
        }

        // Update settings display to reflect current state
        function updateSettingsDisplay() {
            // Update language selection
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.remove('bg-blue-100', 'border-blue-400');
                btn.classList.add('bg-white', 'border-blue-200');
            });
            
            const selectedLangId = {
                'english': 'langEn',
                'traditional': 'langZhTW', 
                'simplified': 'langZhCN'
            }[appSettings.language];
            
            if (selectedLangId) {
                const selectedBtn = document.getElementById(selectedLangId);
                if (selectedBtn) {
                    selectedBtn.classList.remove('bg-white', 'border-blue-200');
                    selectedBtn.classList.add('bg-blue-100', 'border-blue-400');
                }
            }

            // Update toggle states
            updateToggle('musicToggle', appSettings.musicEnabled);
            updateToggle('vibrationToggle', appSettings.vibrationEnabled);
            updateToggle('darkModeToggle', appSettings.darkModeEnabled);
        }

        // Set language function
        function setLanguage(language) {
            appSettings.language = language;
            updateSettingsDisplay();
            
            // Show confirmation
            const languageNames = {
                'english': 'English',
                'traditional': 'ÁπÅÈ´î‰∏≠Êñá',
                'simplified': 'ÁÆÄ‰Ωì‰∏≠Êñá'
            };
            
            showQuickFeedback(`Language set to ${languageNames[language]}! üåç`, 'green');
            
            // In a real app, this would trigger UI translation
            console.log(`Language changed to: ${language}`);
        }

        // Toggle music function
        function toggleMusic() {
            appSettings.musicEnabled = !appSettings.musicEnabled;
            updateToggle('musicToggle', appSettings.musicEnabled);
            
            if (appSettings.musicEnabled) {
                showQuickFeedback('Music enabled! üéµ', 'green');
                // In a real app, start background music
                console.log('üéµ Background music enabled');
            } else {
                showQuickFeedback('Music disabled üîá', 'red');
                // In a real app, stop background music
                console.log('üîá Background music disabled');
            }
        }

        // Toggle vibration function
        function toggleVibration() {
            appSettings.vibrationEnabled = !appSettings.vibrationEnabled;
            updateToggle('vibrationToggle', appSettings.vibrationEnabled);
            
            if (appSettings.vibrationEnabled) {
                showQuickFeedback('Vibration enabled! üì≥', 'green');
                // Try to vibrate if supported
                if (navigator.vibrate) {
                    navigator.vibrate(200);
                }
                console.log('üì≥ Vibration enabled');
            } else {
                showQuickFeedback('Vibration disabled üìµ', 'red');
                console.log('üìµ Vibration disabled');
            }
        }

        // Update toggle visual state
        function updateToggle(toggleId, isEnabled) {
            const toggle = document.getElementById(toggleId);
            const dot = toggle.querySelector('.toggle-dot');
            
            if (isEnabled) {
                toggle.classList.remove('bg-gray-400');
                toggle.classList.add('bg-green-500');
                dot.classList.add('translate-x-7');
                dot.classList.remove('translate-x-1');
            } else {
                toggle.classList.remove('bg-green-500');
                toggle.classList.add('bg-gray-400');
                dot.classList.remove('translate-x-7');
                dot.classList.add('translate-x-1');
            }
        }

        // Subscribe to premium function with plan selection
        function subscribePremium(plan = 'monthly') {
            const planDetails = {
                monthly: {
                    name: 'Monthly Plan',
                    price: 'HK$78/month',
                    stripeId: STRIPE_PRICES.premiumMonthly,
                    benefits: 'Cancel anytime ‚Ä¢ Perfect for trying out Premium'
                },
                annual: {
                    name: 'Annual Plan',
                    price: 'HK$780/year',
                    stripeId: STRIPE_PRICES.premiumAnnual,
                    benefits: 'Save HK$156 per year ‚Ä¢ Best value ‚Ä¢ 2 months FREE!'
                }
            };
            
            const selectedPlan = planDetails[plan];
            
            // Show premium subscription popup
            const popup = document.createElement('div');
            popup.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 1rem;';
            
            popup.innerHTML = `
                <div class="bg-white rounded-3xl p-8 text-center max-w-md relative">
                    <button onclick="this.parentElement.parentElement.remove()" class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-gray-600">√ó</button>
                    
                    <div class="text-6xl mb-4">üëë</div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">Start Free Trial</h3>
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-6 border-2 border-green-200">
                        <h4 class="text-xl font-bold text-green-700 mb-2">${selectedPlan.name}</h4>
                        <div class="text-2xl font-bold text-green-600 mb-1">${selectedPlan.price}</div>
                        <div class="text-sm text-green-700">${selectedPlan.benefits}</div>
                    </div>
                    
                    <div class="bg-blue-50 rounded-xl p-4 mb-6">
                        <h5 class="font-bold text-blue-800 mb-3">‚ú® 7-Day FREE Trial Includes:</h5>
                        <div class="text-left space-y-2 text-sm text-blue-700">
                            <div class="flex items-center space-x-2">
                                <span class="text-green-500">‚úÖ</span>
                                <span>Unlimited quizzes & questions</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-green-500">‚úÖ</span>
                                <span>All 10 premium mini-games</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-green-500">‚úÖ</span>
                                <span>Unlimited gift redemption</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-green-500">‚úÖ</span>
                                <span>Premium avatar customization</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-green-500">‚úÖ</span>
                                <span>No ads & priority support</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <button onclick="startFreeTrial('${plan}')" class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white py-3 px-6 rounded-xl font-bold">
                            üöÄ Start 7-Day FREE Trial
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 px-6 rounded-xl font-semibold">
                            Maybe Later
                        </button>
                    </div>
                    
                    <p class="text-xs text-gray-500 mt-4">üîí No charges during trial ‚Ä¢ Cancel anytime before trial ends</p>
                </div>
            `;
            
            document.body.appendChild(popup);
        }

        // Start free trial function with plan support
        function startFreeTrial(plan = 'monthly') {
            const planDetails = {
                monthly: {
                    name: 'Monthly Premium',
                    priceId: STRIPE_PRICES.premiumMonthly,
                    amount: 'HK$78/month'
                },
                annual: {
                    name: 'Annual Premium',
                    priceId: STRIPE_PRICES.premiumAnnual,
                    amount: 'HK$780/year'
                }
            };
            
            const selectedPlan = planDetails[plan];
            
            // Close any open popups
            document.querySelectorAll('[style*="position: fixed"]').forEach(popup => {
                if (popup.style.position === 'fixed' && popup.style.zIndex === '9999') {
                    popup.remove();
                }
            });
            
            // In a real app, this would integrate with Stripe for subscription creation
            console.log(`üöÄ Starting ${selectedPlan.name} trial - Price ID: ${selectedPlan.priceId}`);
            
            // Show success message with plan details
            showAchievement('üëë', 'Welcome to Premium!', `Your 7-day FREE trial for ${selectedPlan.name} (${selectedPlan.amount}) has started! Enjoy unlimited learning!`);
            
            // Set user to premium for demo
            userStats.isPremium = true;
            userStats.premiumExpiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000); // 7 days from now
            updateUserStats();
            
            console.log(`‚úÖ Premium trial activated: ${selectedPlan.name}`);
        }

        // Contact and support functions
        function openHelp() {
            const popup = document.createElement('div');
            popup.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 1rem;';
            
            popup.innerHTML = `
                <div class="bg-white rounded-3xl p-8 text-center max-w-lg relative">
                    <button onclick="this.parentElement.parentElement.remove()" class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-gray-600">√ó</button>
                    
                    <div class="text-6xl mb-4">‚ùì</div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Help Center</h3>
                    
                    <div class="grid grid-cols-1 gap-4 mb-6">
                        <div class="bg-gray-50 rounded-xl p-4 text-left">
                            <h4 class="font-bold text-gray-800 mb-2">üéì How to earn points?</h4>
                            <p class="text-sm text-gray-600">Complete quizzes and play mini-games to earn points and level up!</p>
                        </div>
                        <div class="bg-gray-50 rounded-xl p-4 text-left">
                            <h4 class="font-bold text-gray-800 mb-2">üéÅ How to redeem rewards?</h4>
                            <p class="text-sm text-gray-600">Visit the Rewards Store and exchange your points for amazing prizes!</p>
                        </div>
                        <div class="bg-gray-50 rounded-xl p-4 text-left">
                            <h4 class="font-bold text-gray-800 mb-2">üî• What are streaks?</h4>
                            <p class="text-sm text-gray-600">Learn every day to build your streak and unlock special rewards!</p>
                        </div>
                    </div>
                    
                    <button onclick="this.parentElement.parentElement.remove()" class="secondary-button text-white py-2 px-6 rounded-xl font-semibold">
                        Got it! üëç
                    </button>
                </div>
            `;
            
            document.body.appendChild(popup);
        }

        function sendFeedback() {
            const popup = document.createElement('div');
            popup.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 1rem;';
            
            popup.innerHTML = `
                <div class="bg-white rounded-3xl p-8 text-center max-w-md relative">
                    <button onclick="this.parentElement.parentElement.remove()" class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-gray-600">√ó</button>
                    
                    <div class="text-6xl mb-4">üí¨</div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Send Feedback</h3>
                    <p class="text-gray-600 mb-6">Help us improve SmartBuddy!</p>
                    
                    <textarea placeholder="Tell us what you think..." class="w-full h-32 text-base p-3 border-2 border-gray-200 rounded-xl resize-none mb-4 focus:border-blue-400 focus:outline-none"></textarea>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="submitFeedback()" class="fun-button text-white py-2 px-4 rounded-xl font-semibold">
                            üìù Send
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-xl font-semibold">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
        }

        function submitFeedback() {
            // Close feedback popup
            document.querySelectorAll('[style*="position: fixed"]').forEach(popup => {
                if (popup.style.position === 'fixed' && popup.style.zIndex === '9999') {
                    popup.remove();
                }
            });
            
            showQuickFeedback('Feedback sent! Thank you! üíô', 'green');
            console.log('üìù Feedback submitted');
        }

        function contactSupport() {
            const popup = document.createElement('div');
            popup.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 1rem;';
            
            popup.innerHTML = `
                <div class="bg-white rounded-3xl p-8 text-center max-w-md relative">
                    <button onclick="this.parentElement.parentElement.remove()" class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-gray-600">√ó</button>
                    
                    <div class="text-6xl mb-4">üÜò</div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Live Support</h3>
                    <p class="text-gray-600 mb-6">Get help from our friendly team!</p>
                    
                    <div class="space-y-4">
                        <button onclick="startLiveChat()" class="w-full fun-button text-white py-3 px-6 rounded-xl font-semibold">
                            üí¨ Start Live Chat
                        </button>
                        <button onclick="sendEmail()" class="w-full secondary-button text-white py-3 px-6 rounded-xl font-semibold">
                            üìß Send Email
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-xl font-semibold">
                            Close
                        </button>
                    </div>
                    
                    <p class="text-xs text-gray-500 mt-4">Average response time: 2 minutes</p>
                </div>
            `;
            
            document.body.appendChild(popup);
        }

        function startLiveChat() {
            // Close support popup
            document.querySelectorAll('[style*="position: fixed"]').forEach(popup => {
                if (popup.style.position === 'fixed' && popup.style.zIndex === '9999') {
                    popup.remove();
                }
            });
            
            showQuickFeedback('Connecting to support... üí¨', 'green');
            console.log('üí¨ Live chat initiated');
            
            // In a real app, this would open chat widget
        }

        function sendEmail() {
            // Close support popup
            document.querySelectorAll('[style*="position: fixed"]').forEach(popup => {
                if (popup.style.position === 'fixed' && popup.style.zIndex === '9999') {
                    popup.remove();
                }
            });
            
            // Open email client
            window.open('mailto:support@smartbuddy.com?subject=Support Request&body=Hi SmartBuddy team,%0D%0A%0D%0APlease describe your issue here...', '_blank');
            showQuickFeedback('Email opened! üìß', 'green');
        }

        // Toggle dark mode function
        function toggleDarkMode() {
            appSettings.darkModeEnabled = !appSettings.darkModeEnabled;
            updateToggle('darkModeToggle', appSettings.darkModeEnabled);
            
            // Apply or remove dark mode class
            if (appSettings.darkModeEnabled) {
                document.documentElement.classList.add('dark');
                showQuickFeedback('Dark mode enabled! üåô', 'green');
                console.log('üåô Dark mode enabled');
            } else {
                document.documentElement.classList.remove('dark');
                showQuickFeedback('Light mode enabled! ‚òÄÔ∏è', 'green');
                console.log('‚òÄÔ∏è Light mode enabled');
            }
        }

        // Auto-detect dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // ===== AVATAR HOME SYSTEM =====
        
        // Show Avatar Home
        function showAvatarHome() {
            console.log('üè† My Home button clicked - showing Avatar Home...');
            
            // For demo purposes, always show the home (skip pet selection for now)
            avatarProfile.petSelected = true;
            avatarProfile.pet = 'dog'; // Default pet
            
            console.log('üì± Switching to avatar home section...');
            showSection('avatarHomeSection');
            
            console.log('üé® Updating avatar display...');
            updateAvatarDisplay();
            
            console.log('üë§ Showing avatar customization tab...');
            showCustomizeTab('avatar'); // Default to avatar customization
            
            console.log('‚úÖ Avatar Home loaded successfully');
            
            // Show feedback to user
            showQuickFeedback('üè† Welcome to your Smart Home!', 'green');
        }
        
        // Show pet selection for first time users
        function showPetSelectionPopup() {
            const popup = document.createElement('div');
            popup.id = 'petSelectionPopup';
            popup.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 1rem;';
            
            popup.innerHTML = `
                <div class="bg-gradient-to-br from-pink-100 to-purple-100 rounded-3xl p-8 text-center max-w-md relative overflow-hidden">
                    <!-- Decorative elements -->
                    <div class="absolute top-2 left-4 text-yellow-400 text-2xl animate-bounce">‚≠ê</div>
                    <div class="absolute top-4 right-6 text-pink-400 text-xl animate-pulse">üíï</div>
                    <div class="absolute bottom-4 left-6 text-blue-400 text-lg animate-bounce">‚ú®</div>
                    
                    <div class="text-6xl mb-4">üè†</div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-4">Welcome to Your Smart Home!</h3>
                    <p class="text-gray-600 mb-6">Choose your adorable companion to start your learning journey!</p>
                    
                    <div class="grid grid-cols-2 gap-6 mb-8">
                        <button onclick="selectPet('dog')" class="pet-option bg-white hover:bg-yellow-50 border-4 border-yellow-300 hover:border-yellow-400 p-6 rounded-2xl text-center transition-all duration-300 hover:transform hover:scale-105">
                            <div class="text-6xl mb-3 animate-bounce">üêï</div>
                            <h4 class="text-xl font-bold text-yellow-600 mb-2">Buddy the Dog</h4>
                            <p class="text-sm text-gray-600">Loyal, playful, and loves learning new tricks!</p>
                        </button>
                        
                        <button onclick="selectPet('cat')" class="pet-option bg-white hover:bg-purple-50 border-4 border-purple-300 hover:border-purple-400 p-6 rounded-2xl text-center transition-all duration-300 hover:transform hover:scale-105">
                            <div class="text-6xl mb-3 animate-bounce">üê±</div>
                            <h4 class="text-xl font-bold text-purple-600 mb-2">Whiskers the Cat</h4>
                            <p class="text-sm text-gray-600">Curious, smart, and loves solving puzzles!</p>
                        </button>
                    </div>
                    
                    <p class="text-sm text-gray-500">Don't worry - you can change your pet later in the customization menu!</p>
                </div>
            `;
            
            document.body.appendChild(popup);
        }
        
        // Select pet and setup home
        function selectPet(petType) {
            avatarProfile.petSelected = true;
            avatarProfile.pet = petType;
            
            // Close popup
            const popup = document.getElementById('petSelectionPopup');
            if (popup) popup.remove();
            
            // Show celebration
            showAchievement('üéâ', 'Welcome Home!', `You chose ${petType === 'dog' ? 'Buddy the Dog' : 'Whiskers the Cat'}! Your home is ready!`);
            
            // Setup initial home with cute furniture
            avatarProfile.furniture = {
                bed: 'cozy',
                desk: 'study', 
                chair: 'comfy',
                decorations: ['pet-bed', 'toy', 'plant']
            };
            
            // Show the avatar home
            setTimeout(() => {
                showSection('avatarHomeSection');
                updateAvatarDisplay();
                showCustomizeTab('avatar');
            }, 2000);
        }

        // Update avatar and room display
        function updateAvatarDisplay() {
            // Update avatar character based on profile
            const avatarChar = document.getElementById('avatarCharacter');
            let avatarEmoji = 'üßí';
            
            if (avatarProfile.gender === 'boy') {
                if (avatarProfile.skinTone === 'light') avatarEmoji = 'üë¶üèª';
                else if (avatarProfile.skinTone === 'medium') avatarEmoji = 'üë¶üèΩ';
                else if (avatarProfile.skinTone === 'dark') avatarEmoji = 'üë¶üèø';
                else avatarEmoji = 'üë¶';
            } else {
                if (avatarProfile.skinTone === 'light') avatarEmoji = 'üëßüèª';
                else if (avatarProfile.skinTone === 'medium') avatarEmoji = 'üëßüèΩ';
                else if (avatarProfile.skinTone === 'dark') avatarEmoji = 'üëßüèø';
                else avatarEmoji = 'üëß';
            }
            
            if (avatarChar) avatarChar.textContent = avatarEmoji;
            
            // Update room wallpaper
            const wallpaperEl = document.getElementById('roomWallpaper');
            const wallpapers = {
                'rainbow': 'from-yellow-200 to-orange-200',
                'stars': 'from-indigo-200 to-purple-200',
                'ocean': 'from-blue-200 to-cyan-200',
                'forest': 'from-green-200 to-emerald-200',
                'space': 'from-gray-700 to-black'
            };
            
            if (wallpaperEl) {
                wallpaperEl.className = `absolute inset-0 bg-gradient-to-br ${wallpapers[avatarProfile.wallpaper]} opacity-60`;
            }
            
            // Update furniture
            const furnitureEmojis = {
                bed: { basic: 'üõèÔ∏è', princess: 'üëëüõèÔ∏è', 'race-car': 'üèéÔ∏è', bunk: 'üè†' },
                desk: { wooden: 'üìö', modern: 'üíª', glass: 'ü™ü', colorful: 'üåà' },
                chair: { simple: 'ü™ë', gaming: 'üéÆ', 'bean-bag': 'üü§', throne: 'üëë' }
            };
            
            const bedEl = document.getElementById('roomBed');
            const deskEl = document.getElementById('roomDesk');
            const decorationEl = document.getElementById('roomDecoration');
            
            if (bedEl) bedEl.textContent = furnitureEmojis.bed[avatarProfile.furniture.bed] || 'üõèÔ∏è';
            if (deskEl) deskEl.textContent = furnitureEmojis.desk[avatarProfile.furniture.desk] || 'üìö';
            if (decorationEl) decorationEl.textContent = avatarProfile.furniture.decorations[0] === 'plant' ? 'üå±' : 'üé®';
        }

        // Show customization tabs
        function showCustomizeTab(tabName) {
            // Update tab appearance
            document.querySelectorAll('.customize-tab').forEach(tab => {
                tab.classList.remove('bg-purple-500', 'text-white');
                tab.classList.add('bg-gray-300', 'text-gray-700');
            });
            
            const activeTab = document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            if (activeTab) {
                activeTab.classList.remove('bg-gray-300', 'text-gray-700');
                activeTab.classList.add('bg-purple-500', 'text-white');
            }
            
            // Show tab content
            const content = document.getElementById('customizeContent');
            
            switch(tabName) {
                case 'avatar':
                    showAvatarCustomization(content);
                    break;
                case 'room':
                    showRoomCustomization(content);
                    break;
                case 'furniture':
                    showFurnitureCustomization(content);
                    break;
                case 'inventory':
                    showInventoryTab(content);
                    break;
            }
        }

        // Avatar Customization Tab
        function showAvatarCustomization(content) {
            content.innerHTML = `
                <div class="space-y-6">
                    <h4 class="text-xl font-bold text-gray-800 mb-4">üë§ Customize Your Avatar</h4>
                    
                    <!-- Gender Selection -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Gender:</label>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="updateAvatar('gender', 'boy')" 
                                    class="avatar-option ${avatarProfile.gender === 'boy' ? 'bg-blue-100 border-blue-400' : 'bg-white border-gray-200'} border-2 p-4 rounded-xl text-center">
                                <div class="text-4xl mb-2">üë¶</div>
                                <div class="font-semibold">Boy</div>
                            </button>
                            <button onclick="updateAvatar('gender', 'girl')" 
                                    class="avatar-option ${avatarProfile.gender === 'girl' ? 'bg-pink-100 border-pink-400' : 'bg-white border-gray-200'} border-2 p-4 rounded-xl text-center">
                                <div class="text-4xl mb-2">üëß</div>
                                <div class="font-semibold">Girl</div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Skin Tone Selection -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Skin Tone:</label>
                        <div class="grid grid-cols-3 gap-4">
                            <button onclick="updateAvatar('skinTone', 'light')" 
                                    class="avatar-option ${avatarProfile.skinTone === 'light' ? 'bg-yellow-100 border-yellow-400' : 'bg-white border-gray-200'} border-2 p-4 rounded-xl text-center">
                                <div class="text-4xl mb-2">üü°</div>
                                <div class="font-semibold text-sm">Light</div>
                            </button>
                            <button onclick="updateAvatar('skinTone', 'medium')" 
                                    class="avatar-option ${avatarProfile.skinTone === 'medium' ? 'bg-orange-100 border-orange-400' : 'bg-white border-gray-200'} border-2 p-4 rounded-xl text-center">
                                <div class="text-4xl mb-2">üü†</div>
                                <div class="font-semibold text-sm">Medium</div>
                            </button>
                            <button onclick="updateAvatar('skinTone', 'dark')" 
                                    class="avatar-option ${avatarProfile.skinTone === 'dark' ? 'bg-amber-100 border-amber-400' : 'bg-white border-gray-200'} border-2 p-4 rounded-xl text-center">
                                <div class="text-4xl mb-2">üü§</div>
                                <div class="font-semibold text-sm">Dark</div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Outfit Selection -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Outfit:</label>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="updateAvatar('outfit', 'casual')" 
                                    class="avatar-option ${avatarProfile.outfit === 'casual' ? 'bg-green-100 border-green-400' : 'bg-white border-gray-200'} border-2 p-4 rounded-xl text-center">
                                <div class="text-4xl mb-2">üëï</div>
                                <div class="font-semibold text-sm">Casual</div>
                            </button>
                            <button onclick="updateAvatar('outfit', 'school')" 
                                    class="avatar-option ${avatarProfile.outfit === 'school' ? 'bg-blue-100 border-blue-400' : 'bg-white border-gray-200'} border-2 p-4 rounded-xl text-center ${avatarProfile.unlockedItems.outfits.includes('school') ? '' : 'opacity-50 cursor-not-allowed'}">
                                <div class="text-4xl mb-2">üéí</div>
                                <div class="font-semibold text-sm">School</div>
                                ${avatarProfile.unlockedItems.outfits.includes('school') ? '' : '<div class="text-xs text-red-500">üîí Locked</div>'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Room Customization Tab
        function showRoomCustomization(content) {
            content.innerHTML = `
                <div class="space-y-6">
                    <h4 class="text-xl font-bold text-gray-800 mb-4">üè† Customize Your Room</h4>
                    
                    <!-- Wallpaper Selection -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Wallpaper:</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <button onclick="updateRoom('wallpaper', 'rainbow')" 
                                    class="room-option ${avatarProfile.wallpaper === 'rainbow' ? 'ring-4 ring-blue-400' : ''} bg-gradient-to-br from-yellow-200 to-orange-200 p-6 rounded-xl text-center">
                                <div class="text-2xl mb-2">üåà</div>
                                <div class="font-semibold text-sm">Rainbow</div>
                            </button>
                            <button onclick="updateRoom('wallpaper', 'stars')" 
                                    class="room-option ${avatarProfile.wallpaper === 'stars' ? 'ring-4 ring-blue-400' : ''} ${avatarProfile.unlockedItems.wallpapers.includes('stars') ? 'bg-gradient-to-br from-indigo-200 to-purple-200' : 'bg-gray-200 opacity-50 cursor-not-allowed'} p-6 rounded-xl text-center">
                                <div class="text-2xl mb-2">‚≠ê</div>
                                <div class="font-semibold text-sm">Stars</div>
                                ${avatarProfile.unlockedItems.wallpapers.includes('stars') ? '' : '<div class="text-xs text-red-500">üîí Locked</div>'}
                            </button>
                            <button onclick="updateRoom('wallpaper', 'ocean')" 
                                    class="room-option ${avatarProfile.wallpaper === 'ocean' ? 'ring-4 ring-blue-400' : ''} ${avatarProfile.unlockedItems.wallpapers.includes('ocean') ? 'bg-gradient-to-br from-blue-200 to-cyan-200' : 'bg-gray-200 opacity-50 cursor-not-allowed'} p-6 rounded-xl text-center">
                                <div class="text-2xl mb-2">üåä</div>
                                <div class="font-semibold text-sm">Ocean</div>
                                ${avatarProfile.unlockedItems.wallpapers.includes('ocean') ? '' : '<div class="text-xs text-red-500">üîí Locked</div>'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Furniture Customization Tab  
        function showFurnitureCustomization(content) {
            content.innerHTML = `
                <div class="space-y-6">
                    <h4 class="text-xl font-bold text-gray-800 mb-4">ü™ë Furniture & Decorations</h4>
                    
                    <!-- Bed Selection -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Bed:</label>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="updateFurniture('bed', 'basic')" 
                                    class="furniture-option ${avatarProfile.furniture.bed === 'basic' ? 'bg-blue-100 border-blue-400' : 'bg-white border-gray-200'} border-2 p-4 rounded-xl text-center">
                                <div class="text-4xl mb-2">üõèÔ∏è</div>
                                <div class="font-semibold text-sm">Basic Bed</div>
                            </button>
                            <button onclick="updateFurniture('bed', 'princess')" 
                                    class="furniture-option ${avatarProfile.furniture.bed === 'princess' ? 'bg-pink-100 border-pink-400' : 'bg-white border-gray-200'} border-2 p-4 rounded-xl text-center ${avatarProfile.unlockedItems.furniture.includes('princess-bed') ? '' : 'opacity-50 cursor-not-allowed'}">
                                <div class="text-4xl mb-2">üëë</div>
                                <div class="font-semibold text-sm">Princess Bed</div>
                                ${avatarProfile.unlockedItems.furniture.includes('princess-bed') ? '' : '<div class="text-xs text-red-500">üîí Locked</div>'}
                            </button>
                        </div>
                    </div>
                    
                    <!-- Decorations -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Decorations:</label>
                        <div class="grid grid-cols-3 gap-4">
                            <button onclick="addDecoration('plant')" 
                                    class="decoration-option ${avatarProfile.furniture.decorations.includes('plant') ? 'bg-green-100 border-green-400' : 'bg-white border-gray-200'} border-2 p-4 rounded-xl text-center">
                                <div class="text-4xl mb-2">üå±</div>
                                <div class="font-semibold text-sm">Plant</div>
                            </button>
                            <button onclick="addDecoration('art')" 
                                    class="decoration-option ${avatarProfile.furniture.decorations.includes('art') ? 'bg-purple-100 border-purple-400' : 'bg-white border-gray-200'} border-2 p-4 rounded-xl text-center ${avatarProfile.unlockedItems.decorations.includes('art') ? '' : 'opacity-50 cursor-not-allowed'}">
                                <div class="text-4xl mb-2">üé®</div>
                                <div class="font-semibold text-sm">Art</div>
                                ${avatarProfile.unlockedItems.decorations.includes('art') ? '' : '<div class="text-xs text-red-500">üîí Locked</div>'}
                            </button>
                            <button onclick="addDecoration('trophy')" 
                                    class="decoration-option ${avatarProfile.furniture.decorations.includes('trophy') ? 'bg-yellow-100 border-yellow-400' : 'bg-white border-gray-200'} border-2 p-4 rounded-xl text-center ${avatarProfile.unlockedItems.decorations.includes('trophy') ? '' : 'opacity-50 cursor-not-allowed'}">
                                <div class="text-4xl mb-2">üèÜ</div>
                                <div class="font-semibold text-sm">Trophy</div>
                                ${avatarProfile.unlockedItems.decorations.includes('trophy') ? '' : '<div class="text-xs text-red-500">üîí Locked</div>'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Inventory Tab
        function showInventoryTab(content) {
            content.innerHTML = `
                <div class="space-y-6">
                    <h4 class="text-xl font-bold text-gray-800 mb-4">üéÅ My Inventory</h4>
                    
                    <div class="bg-blue-50 rounded-xl p-6">
                        <h5 class="font-bold text-blue-800 mb-4">Digital Items Earned:</h5>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            ${userStats.points >= 100 ? `
                                <div class="bg-white rounded-lg p-4 text-center">
                                    <div class="text-3xl mb-2">üèÜ</div>
                                    <div class="font-semibold text-sm">Digital Badges</div>
                                    <div class="text-xs text-green-600">‚úÖ Unlocked</div>
                                </div>
                            ` : `
                                <div class="bg-gray-100 rounded-lg p-4 text-center opacity-50">
                                    <div class="text-3xl mb-2">üèÜ</div>
                                    <div class="font-semibold text-sm">Digital Badges</div>
                                    <div class="text-xs text-gray-500">üîí Need 100 points</div>
                                </div>
                            `}
                            
                            ${userStats.points >= 150 ? `
                                <div class="bg-white rounded-lg p-4 text-center">
                                    <div class="text-3xl mb-2">üòé</div>
                                    <div class="font-semibold text-sm">Avatar Stickers</div>
                                    <div class="text-xs text-green-600">‚úÖ Unlocked</div>
                                </div>
                            ` : `
                                <div class="bg-gray-100 rounded-lg p-4 text-center opacity-50">
                                    <div class="text-3xl mb-2">üòé</div>
                                    <div class="font-semibold text-sm">Avatar Stickers</div>
                                    <div class="text-xs text-gray-500">üîí Need 150 points</div>
                                </div>
                            `}
                            
                            ${userStats.points >= 200 ? `
                                <div class="bg-white rounded-lg p-4 text-center">
                                    <div class="text-3xl mb-2">üåü</div>
                                    <div class="font-semibold text-sm">Star Wallpaper</div>
                                    <div class="text-xs text-green-600">‚úÖ Available</div>
                                </div>
                            ` : `
                                <div class="bg-gray-100 rounded-lg p-4 text-center opacity-50">
                                    <div class="text-3xl mb-2">‚≠ê</div>
                                    <div class="font-semibold text-sm">Star Wallpaper</div>
                                    <div class="text-xs text-gray-500">üîí Need 200 points</div>
                                </div>
                            `}
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <p class="text-gray-600 mb-4">Earn more points to unlock new items for your avatar and room!</p>
                        <button onclick="showRewards()" class="bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-white py-3 px-6 rounded-xl font-semibold">
                            üéÅ Visit Rewards Store
                        </button>
                    </div>
                </div>
            `;
        }

        // Update avatar function
        function updateAvatar(property, value) {
            avatarProfile[property] = value;
            updateAvatarDisplay();
            showQuickFeedback(`‚ú® Avatar updated!`, 'green');
            console.log(`üë§ Avatar ${property} changed to: ${value}`);
        }

        // Update room function
        function updateRoom(property, value) {
            if (property === 'wallpaper' && !avatarProfile.unlockedItems.wallpapers.includes(value)) {
                showQuickFeedback('üîí This wallpaper is locked! Earn points to unlock it.', 'red');
                return;
            }
            
            avatarProfile[property] = value;
            updateAvatarDisplay();
            showQuickFeedback(`üè† Room updated!`, 'green');
            console.log(`üè† Room ${property} changed to: ${value}`);
        }

        // Update furniture function
        function updateFurniture(type, value) {
            const furnitureKey = `${value}-${type}`;
            if (!avatarProfile.unlockedItems.furniture.includes(furnitureKey) && value !== 'basic') {
                showQuickFeedback('üîí This furniture is locked! Earn points to unlock it.', 'red');
                return;
            }
            
            avatarProfile.furniture[type] = value;
            updateAvatarDisplay();
            showQuickFeedback(`ü™ë Furniture updated!`, 'green');
            console.log(`ü™ë ${type} changed to: ${value}`);
        }

        // Add decoration function
        function addDecoration(decoration) {
            if (!avatarProfile.unlockedItems.decorations.includes(decoration) && decoration !== 'plant') {
                showQuickFeedback('üîí This decoration is locked! Earn points to unlock it.', 'red');
                return;
            }
            
            if (avatarProfile.furniture.decorations.includes(decoration)) {
                // Remove if already placed
                avatarProfile.furniture.decorations = avatarProfile.furniture.decorations.filter(d => d !== decoration);
                showQuickFeedback(`üóëÔ∏è Decoration removed!`, 'blue');
            } else {
                // Add decoration (limit to 3)
                if (avatarProfile.furniture.decorations.length < 3) {
                    avatarProfile.furniture.decorations.push(decoration);
                    showQuickFeedback(`‚ú® Decoration added!`, 'green');
                } else {
                    showQuickFeedback('üö´ Maximum 3 decorations allowed!', 'red');
                    return;
                }
            }
            
            updateAvatarDisplay();
            showCustomizeTab('furniture'); // Refresh the tab
            console.log(`üé® Decoration ${decoration} toggled`);
        }
    </script>
</body>
</html>