<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartBuddy Êô∫Â≠¶ÂÆù - AI-Powered Smart Learning Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        .kid-friendly-bg {
            background: linear-gradient(135deg, 
                #FFF3E0 0%,   /* Warm cream */
                #FFE0B2 25%,  /* Light orange */
                #E1F5FE 50%,  /* Soft blue */
                #F3E5F5 75%,  /* Light purple */
                #E8F5E8 100%  /* Gentle green */
            );
            animation: gentle-float 6s ease-in-out infinite;
        }
        
        @keyframes gentle-float {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .cartoon-card {
            background: linear-gradient(145deg, 
                rgba(255, 255, 255, 0.9) 0%,
                rgba(255, 248, 240, 0.95) 100%
            );
            backdrop-filter: blur(10px);
            box-shadow: 
                0 20px 40px rgba(255, 165, 0, 0.15),
                0 8px 25px rgba(147, 51, 234, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
        
        .fun-button {
            background: linear-gradient(45deg, #FF9A56, #FF6B9D);
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3);
            transition: all 0.3s ease;
            border: none;
        }
        
        .fun-button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.4);
        }
        
        .secondary-button {
            background: linear-gradient(45deg, #4ECDC4, #45B7D1);
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }
        
        .secondary-button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(78, 205, 196, 0.4);
        }
        
        .robot-emoji {
            filter: drop-shadow(0 4px 8px rgba(255, 165, 0, 0.3));
            animation: bounce-robot 2s ease-in-out infinite;
        }
        
        @keyframes bounce-robot {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .star-decoration {
            animation: twinkle 3s ease-in-out infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        
        .floating-shapes {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }
        
        .shape {
            position: absolute;
            opacity: 0.1;
            animation: float 10s infinite ease-in-out;
        }
        
        .shape:nth-child(1) { left: 10%; animation-delay: 0s; }
        .shape:nth-child(2) { left: 20%; animation-delay: 2s; }
        .shape:nth-child(3) { left: 70%; animation-delay: 4s; }
        .shape:nth-child(4) { left: 80%; animation-delay: 6s; }
        
        @keyframes float {
            0%, 100% { transform: translateY(100vh) rotate(0deg); }
            50% { transform: translateY(-100vh) rotate(180deg); }
        }
    </style>
</head>
<body class="font-sans kid-friendly-bg min-h-screen relative">
    
    <!-- Floating Background Shapes -->
    <div class="floating-shapes">
        <div class="shape text-6xl">üöÄ</div>
        <div class="shape text-5xl">‚≠ê</div>
        <div class="shape text-4xl">üéØ</div>
        <div class="shape text-5xl">üé®</div>
    </div>
    
    <!-- Welcome Screen -->
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="cartoon-card rounded-3xl p-8 w-full max-w-md text-center relative overflow-hidden">
            <!-- Decorative stars -->
            <div class="absolute top-4 left-4 star-decoration text-yellow-400 text-2xl">‚≠ê</div>
            <div class="absolute top-6 right-6 star-decoration text-pink-400 text-xl">‚ú®</div>
            <div class="absolute bottom-6 left-6 star-decoration text-blue-400 text-xl">üí´</div>
            
            <div class="robot-emoji text-6xl mb-4">ü§ñ</div>
            <h1 class="text-3xl font-bold text-orange-600 mb-2">ü§ñ SmartBuddy</h1>
            <h2 class="text-xl font-semibold text-blue-500 mb-4">Êô∫Â≠¶ÂÆù</h2>
            <p class="text-gray-700 mb-2 font-medium">AI-Powered Smart Learning Platform</p>
            <p class="text-gray-600 mb-6 text-sm">AIÊô∫ËÉΩÂ≠¶‰π†Âπ≥Âè∞<br>Testing Airtable Connection...</p>
            
            <div id="connectionStatus" class="p-4 rounded-lg mb-6 bg-blue-50">
                <div class="text-lg font-semibold text-blue-800">üîÑ Testing Connection...</div>
                <div class="text-sm text-blue-600 mt-2">Please wait while we connect to your Airtable database</div>
            </div>
            
            <div class="space-y-4">
                <button onclick="testConnection()" class="w-full fun-button text-white py-3 px-6 rounded-xl font-semibold">
                    üîÑ Test Again
                </button>
                <button onclick="showFullApp()" class="w-full secondary-button text-white py-3 px-6 rounded-xl font-semibold">
                    üì± View Full App Demo
                </button>
            </div>
            
            <div class="mt-6 text-center">
                <p class="text-sm text-gray-500">
                    ü§ñ Next-Generation Learning Technology<br>
                    Powered by AI & Gamification
                </p>
            </div>
        </div>
    </div>

    <script>
        // Your Airtable credentials
        const AIRTABLE_CONFIG = {
            baseId: 'appzbq4Zom94iCItg',
            apiKey: 'patuNpUG5LMv5mdbb.b5de7b9dd3a7c8207ad612df50485760e4f07061e15649ae57802fbffe9653b3'
        };

        // Test Airtable connection
        async function testConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            
            try {
                statusDiv.innerHTML = `
                    <div class="text-lg font-semibold text-blue-800">üîÑ Testing Connection...</div>
                    <div class="text-sm text-blue-600 mt-2">Connecting to Base ID: ${AIRTABLE_CONFIG.baseId.substring(0, 10)}...</div>
                `;

                // Test Questions table
                const questionsUrl = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/Questions`;
                console.log('Testing URL:', questionsUrl);
                
                const response = await fetch(questionsUrl, {
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (response.ok) {
                    const data = await response.json();
                    const recordCount = data.records ? data.records.length : 0;
                    
                    console.log('Data received:', data);
                    console.log('Record count:', recordCount);

                    if (recordCount > 0) {
                        // SUCCESS - Found data
                        statusDiv.innerHTML = `
                            <div class="text-lg font-semibold text-green-800">‚úÖ CONNECTION SUCCESS!</div>
                            <div class="text-sm text-green-600 mt-2">
                                üìä Found ${recordCount} questions in your database<br>
                                üéâ Your Airtable is working perfectly!
                            </div>
                        `;
                        statusDiv.className = 'p-4 rounded-lg mb-6 bg-green-50';
                        
                        // Show success alert
                        setTimeout(() => {
                            alert(`üéâ FANTASTIC!\n\nYour Airtable connection is working!\n\nüìä Data found:\n‚Ä¢ ${recordCount} questions in your database\n‚Ä¢ Base ID: ${AIRTABLE_CONFIG.baseId}\n‚Ä¢ Connection: Successful\n\n‚úÖ Next steps:\n1. Add more questions to Airtable\n2. Create Gifts table\n3. Deploy to live domain\n4. Set up Stripe payments`);
                        }, 1000);
                    } else {
                        // SUCCESS but no data
                        statusDiv.innerHTML = `
                            <div class="text-lg font-semibold text-yellow-800">‚ö†Ô∏è CONNECTED BUT EMPTY</div>
                            <div class="text-sm text-yellow-600 mt-2">
                                ‚úÖ Connection works, but no questions found<br>
                                üìù Please add data to your Questions table
                            </div>
                        `;
                        statusDiv.className = 'p-4 rounded-lg mb-6 bg-yellow-50';
                        
                        setTimeout(() => {
                            alert(`‚ö†Ô∏è CONNECTION WORKS BUT NO DATA\n\nYour Airtable connection is successful!\n\nBut your Questions table is empty (${recordCount} records)\n\nüìã To fix this:\n1. Go to your Airtable base\n2. Import the CSV file I provided earlier\n3. Make sure table is named 'Questions'\n4. Test again`);
                        }, 1000);
                    }
                } else {
                    // Connection failed
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    
                    statusDiv.innerHTML = `
                        <div class="text-lg font-semibold text-red-800">‚ùå CONNECTION FAILED</div>
                        <div class="text-sm text-red-600 mt-2">
                            Error ${response.status}: ${response.statusText}<br>
                            Check your credentials and table setup
                        </div>
                    `;
                    statusDiv.className = 'p-4 rounded-lg mb-6 bg-red-50';
                    
                    setTimeout(() => {
                        alert(`‚ùå CONNECTION FAILED\n\nError: ${response.status} - ${response.statusText}\n\nüîç Check:\n1. Base ID: ${AIRTABLE_CONFIG.baseId}\n2. API token permissions\n3. Table named 'Questions' exists\n4. Token has 'read' permission\n\nTry regenerating your API token if needed.`);
                    }, 1000);
                }

            } catch (error) {
                console.error('Network error:', error);
                
                statusDiv.innerHTML = `
                    <div class="text-lg font-semibold text-red-800">‚ùå NETWORK ERROR</div>
                    <div class="text-sm text-red-600 mt-2">
                        ${error.message}<br>
                        Check your internet connection
                    </div>
                `;
                statusDiv.className = 'p-4 rounded-lg mb-6 bg-red-50';
                
                setTimeout(() => {
                    alert(`‚ùå NETWORK ERROR\n\nError: ${error.message}\n\nüîç Check:\n1. Internet connection\n2. Browser permissions\n3. Firewall settings\n4. Try refreshing the page`);
                }, 1000);
            }
        }

        // Show full app demo
        function showFullApp() {
            // Hide welcome screen and show main app
            document.body.innerHTML = `
                ${document.head.outerHTML}
                <body class="font-sans kid-friendly-bg min-h-screen relative">
                    <!-- Floating Background Shapes -->
                    <div class="floating-shapes">
                        <div class="shape text-6xl">üöÄ</div>
                        <div class="shape text-5xl">‚≠ê</div>
                        <div class="shape text-4xl">üéØ</div>
                        <div class="shape text-5xl">üé®</div>
                    </div>
                    
                    <!-- Header -->
                    <header class="bg-white/90 backdrop-blur-sm shadow-lg sticky top-0 z-50">
                        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="robot-emoji text-3xl">ü§ñ</div>
                                <div>
                                    <h1 class="text-xl font-bold text-orange-600">SmartBuddy</h1>
                                    <p class="text-sm text-blue-500">Êô∫Â≠¶ÂÆù</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-purple-600" id="userPoints">0</div>
                                    <div class="text-xs text-gray-600">Points</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-600" id="userLevel">1</div>
                                    <div class="text-xs text-gray-600">Level</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl" id="streakFire">üî•</div>
                                    <div class="text-xs text-gray-600" id="streakCount">0 day streak</div>
                                </div>
                            </div>
                        </div>
                    </header>

                    <!-- Main Content -->
                    <main class="max-w-6xl mx-auto px-4 py-8">
                        <!-- Welcome Section -->
                        <section id="welcomeSection" class="text-center mb-8">
                            <div class="cartoon-card rounded-3xl p-8 mb-8">
                                <h2 class="text-3xl font-bold text-gray-800 mb-4">
                                    Welcome to SmartBuddy! ü§ñ
                                </h2>
                                <p class="text-gray-600 mb-6">
                                    Ready to learn and earn points? Choose your learning adventure!
                                </p>
                                
                                <!-- Grade Selection -->
                                <div class="mb-6">
                                    <label class="block text-lg font-semibold mb-3">Choose Your Grade:</label>
                                    <select id="gradeSelect" class="text-base px-4 py-3 rounded-xl border-2 border-purple-200 focus:border-purple-400 bg-white">
                                        <option value="Kindergarten">üé® Kindergarten</option>
                                        <option value="Grade1">üìö Grade 1</option>
                                        <option value="Grade2">üî¢ Grade 2</option>
                                        <option value="Grade3">üß™ Grade 3</option>
                                        <option value="Grade4">üåü Grade 4</option>
                                        <option value="Grade5">üöÄ Grade 5</option>
                                        <option value="Grade6">üèÜ Grade 6</option>
                                    </select>
                                </div>

                                <!-- Subject Selection -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                    <button onclick="startQuiz('Math')" class="fun-button text-white py-4 px-6 rounded-xl font-semibold">
                                        üî¢ Math Quiz
                                    </button>
                                    <button onclick="startQuiz('English')" class="secondary-button text-white py-4 px-6 rounded-xl font-semibold">
                                        üìö English Quiz
                                    </button>
                                    <button onclick="startQuiz('Science')" class="bg-gradient-to-r from-green-400 to-emerald-500 hover:from-green-500 hover:to-emerald-600 text-white py-4 px-6 rounded-xl font-semibold transition-all duration-300 hover:transform hover:scale-105">
                                        üß™ Science Quiz
                                    </button>
                                </div>

                                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                                    <button onclick="showRewards()" class="bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-white py-3 px-6 rounded-xl font-semibold">
                                        üéÅ View Rewards
                                    </button>
                                    <button onclick="showProgress()" class="bg-gradient-to-r from-indigo-400 to-purple-500 hover:from-indigo-500 hover:to-purple-600 text-white py-3 px-6 rounded-xl font-semibold">
                                        üìä My Progress
                                    </button>
                                </div>
                            </div>
                        </section>

                        <!-- Quiz Section -->
                        <section id="quizSection" class="hidden">
                            <div class="cartoon-card rounded-3xl p-8">
                                <!-- Quiz Header -->
                                <div class="flex justify-between items-center mb-6">
                                    <div class="flex items-center space-x-3">
                                        <span id="subjectEmoji" class="text-3xl">üî¢</span>
                                        <div>
                                            <h3 id="quizTitle" class="text-2xl font-bold text-gray-800">Math Quiz</h3>
                                            <p id="quizGrade" class="text-gray-600">Grade 1</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm text-gray-600">Question</div>
                                        <div class="text-xl font-bold" id="questionProgress">1 / 5</div>
                                    </div>
                                </div>

                                <!-- Progress Bar -->
                                <div class="w-full bg-gray-200 rounded-full h-3 mb-6">
                                    <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all duration-500" style="width: 20%"></div>
                                </div>

                                <!-- Question Display -->
                                <div class="mb-8">
                                    <h4 id="questionText" class="text-xl font-semibold text-gray-800 mb-6">
                                        Loading question...
                                    </h4>
                                    
                                    <!-- Answer Options -->
                                    <div id="answerOptions" class="space-y-3">
                                        <!-- Options will be inserted here -->
                                    </div>
                                </div>

                                <!-- Quiz Controls -->
                                <div class="flex justify-between">
                                    <button onclick="showWelcome()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg">
                                        üè† Back to Home
                                    </button>
                                    <button id="nextButton" onclick="nextQuestion()" class="fun-button text-white py-2 px-6 rounded-lg opacity-50 cursor-not-allowed" disabled>
                                        Next Question ‚û°Ô∏è
                                    </button>
                                </div>
                            </div>
                        </section>

                        <!-- Results Section -->
                        <section id="resultsSection" class="hidden">
                            <div class="cartoon-card rounded-3xl p-8 text-center">
                                <div class="text-6xl mb-4" id="resultEmoji">üéâ</div>
                                <h3 class="text-3xl font-bold text-gray-800 mb-4" id="resultTitle">Quiz Complete!</h3>
                                <div class="bg-gradient-to-r from-yellow-100 to-orange-100 rounded-2xl p-6 mb-6">
                                    <div class="text-4xl font-bold text-orange-600 mb-2" id="finalScore">0 / 5</div>
                                    <div class="text-lg text-gray-700 mb-3" id="pointsEarned">+0 Points</div>
                                    <div class="text-sm text-gray-600" id="resultMessage">Great job!</div>
                                </div>
                                
                                <!-- AI Feedback -->
                                <div id="aiFeedback" class="bg-blue-50 rounded-xl p-4 mb-6">
                                    <div class="flex items-center justify-center mb-2">
                                        <span class="text-2xl mr-2">ü§ñ</span>
                                        <span class="font-semibold text-blue-800">SmartBuddy AI Says:</span>
                                    </div>
                                    <p id="aiMessage" class="text-blue-700">Analyzing your performance...</p>
                                </div>

                                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                                    <button onclick="startQuiz(currentSubject)" class="fun-button text-white py-3 px-6 rounded-xl font-semibold">
                                        üîÑ Try Again
                                    </button>
                                    <button onclick="showWelcome()" class="secondary-button text-white py-3 px-6 rounded-xl font-semibold">
                                        üè† Back to Home
                                    </button>
                                    <button onclick="showRewards()" class="bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-white py-3 px-6 rounded-xl font-semibold">
                                        üéÅ Spend Points
                                    </button>
                                </div>
                            </div>
                        </section>

                        <!-- Rewards Section -->
                        <section id="rewardsSection" class="hidden">
                            <div class="cartoon-card rounded-3xl p-8">
                                <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center">üéÅ Rewards Store</h3>
                                <div id="rewardsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    <!-- Rewards will be loaded here -->
                                </div>
                                <div class="text-center mt-8">
                                    <button onclick="showWelcome()" class="secondary-button text-white py-3 px-6 rounded-xl font-semibold">
                                        üè† Back to Home
                                    </button>
                                </div>
                            </div>
                        </section>
                    </main>

                    <!-- Achievement Popup -->
                    <div id="achievementPopup" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-3xl p-8 text-center max-w-md mx-4">
                            <div class="text-6xl mb-4" id="achievementEmoji">üèÜ</div>
                            <h4 class="text-2xl font-bold text-gray-800 mb-2" id="achievementTitle">Achievement Unlocked!</h4>
                            <p class="text-gray-600 mb-6" id="achievementText">You've earned a new badge!</p>
                            <button onclick="closeAchievement()" class="fun-button text-white py-2 px-6 rounded-xl font-semibold">
                                Awesome! üéâ
                            </button>
                        </div>
                    </div>
                </body>
            `;
            
            // Initialize the app
            initializeApp();
        }

        // Global quiz variables
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let currentSubject = '';
        let currentGrade = '';
        let userStats = {
            points: parseInt(localStorage.getItem('smartbuddy-points') || '0'),
            level: parseInt(localStorage.getItem('smartbuddy-level') || '1'),
            streak: parseInt(localStorage.getItem('smartbuddy-streak') || '0'),
            totalQuestionsAnswered: parseInt(localStorage.getItem('smartbuddy-total-questions') || '0'),
            correctAnswers: parseInt(localStorage.getItem('smartbuddy-correct') || '0')
        };

        // Initialize the main app
        function initializeApp() {
            updateUserStats();
            loadRewards();
        }

        // Update user stats display
        function updateUserStats() {
            const pointsEl = document.getElementById('userPoints');
            const levelEl = document.getElementById('userLevel');
            const streakEl = document.getElementById('streakCount');
            
            if (pointsEl) pointsEl.textContent = userStats.points;
            if (levelEl) levelEl.textContent = userStats.level;
            if (streakEl) streakEl.textContent = `${userStats.streak} day streak`;
            
            // Save to localStorage
            localStorage.setItem('smartbuddy-points', userStats.points.toString());
            localStorage.setItem('smartbuddy-level', userStats.level.toString());
            localStorage.setItem('smartbuddy-streak', userStats.streak.toString());
            localStorage.setItem('smartbuddy-total-questions', userStats.totalQuestionsAnswered.toString());
            localStorage.setItem('smartbuddy-correct', userStats.correctAnswers.toString());
        }

        // Show different sections
        function showSection(sectionId) {
            const sections = ['welcomeSection', 'quizSection', 'resultsSection', 'rewardsSection'];
            sections.forEach(section => {
                const el = document.getElementById(section);
                if (el) {
                    if (section === sectionId) {
                        el.classList.remove('hidden');
                    } else {
                        el.classList.add('hidden');
                    }
                }
            });
        }

        function showWelcome() {
            showSection('welcomeSection');
        }

        // Start quiz function
        async function startQuiz(subject) {
            currentSubject = subject;
            currentGrade = document.getElementById('gradeSelect').value;
            
            showSection('quizSection');
            
            // Update quiz header
            const subjectEmojis = {
                'Math': 'üî¢',
                'English': 'üìö', 
                'Science': 'üß™'
            };
            
            document.getElementById('subjectEmoji').textContent = subjectEmojis[subject];
            document.getElementById('quizTitle').textContent = `${subject} Quiz`;
            document.getElementById('quizGrade').textContent = currentGrade;
            
            // Load questions from Airtable
            await loadQuestions(subject, currentGrade);
        }

        // Load questions from Airtable
        async function loadQuestions(subject, grade) {
            try {
                const filterFormula = `AND({Subject} = '${subject}', {Grade} = '${grade}', {Status} = 'Approved')`;
                const url = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/Questions?filterByFormula=${encodeURIComponent(filterFormula)}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentQuestions = data.records.map(record => record.fields);
                    
                    // Shuffle questions for variety
                    currentQuestions = shuffleArray(currentQuestions).slice(0, 5);
                    
                    if (currentQuestions.length === 0) {
                        alert('No questions found for this subject and grade. Please try a different combination.');
                        showWelcome();
                        return;
                    }
                    
                    // Reset quiz state
                    currentQuestionIndex = 0;
                    userAnswers = [];
                    
                    // Start quiz
                    displayQuestion();
                } else {
                    throw new Error('Failed to load questions');
                }
            } catch (error) {
                console.error('Error loading questions:', error);
                alert('Failed to load questions. Please check your connection and try again.');
                showWelcome();
            }
        }

        // Display current question
        function displayQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                showResults();
                return;
            }
            
            const question = currentQuestions[currentQuestionIndex];
            const totalQuestions = currentQuestions.length;
            
            // Update progress
            document.getElementById('questionProgress').textContent = `${currentQuestionIndex + 1} / ${totalQuestions}`;
            document.getElementById('progressBar').style.width = `${((currentQuestionIndex + 1) / totalQuestions) * 100}%`;
            
            // Display question text
            document.getElementById('questionText').textContent = question['Question Text'];
            
            // Generate answer options
            const options = ['A', 'B', 'C', 'D'].filter(opt => question[`Option ${opt}`]);
            const answerOptionsHtml = options.map(option => {
                const optionText = question[`Option ${option}`];
                return `
                    <button onclick="selectAnswer('${option}')" 
                            class="answer-option w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-purple-400 hover:bg-purple-50 transition-all duration-200 text-base">
                        <span class="font-semibold text-purple-600">${option})</span> ${optionText}
                    </button>
                `;
            }).join('');
            
            document.getElementById('answerOptions').innerHTML = answerOptionsHtml;
            
            // Reset next button
            const nextButton = document.getElementById('nextButton');
            nextButton.disabled = true;
            nextButton.classList.add('opacity-50', 'cursor-not-allowed');
        }

        // Handle answer selection
        function selectAnswer(selectedOption) {
            // Remove previous selections
            document.querySelectorAll('.answer-option').forEach(btn => {
                btn.classList.remove('bg-green-100', 'border-green-400', 'bg-red-100', 'border-red-400', 'bg-purple-100', 'border-purple-400');
            });
            
            // Highlight selected answer
            event.target.classList.add('bg-purple-100', 'border-purple-400');
            
            // Store answer
            const question = currentQuestions[currentQuestionIndex];
            const isCorrect = selectedOption === question['Correct Answer'];
            
            userAnswers.push({
                questionIndex: currentQuestionIndex,
                selectedAnswer: selectedOption,
                correctAnswer: question['Correct Answer'],
                isCorrect: isCorrect,
                points: isCorrect ? (question['Points Value'] || 10) : 0,
                difficulty: question['Difficulty'] || 'suitable'
            });
            
            // Show correct/incorrect feedback
            setTimeout(() => {
                showAnswerFeedback(isCorrect, question['Correct Answer']);
            }, 500);
        }

        // Show answer feedback
        function showAnswerFeedback(isCorrect, correctAnswer) {
            const options = document.querySelectorAll('.answer-option');
            
            options.forEach(option => {
                const optionLetter = option.textContent.trim().split(')')[0];
                
                if (optionLetter === correctAnswer) {
                    option.classList.add('bg-green-100', 'border-green-400');
                    option.innerHTML += ' ‚úÖ';
                } else if (option.classList.contains('bg-purple-100') && !isCorrect) {
                    option.classList.remove('bg-purple-100', 'border-purple-400');
                    option.classList.add('bg-red-100', 'border-red-400');
                    option.innerHTML += ' ‚ùå';
                }
                
                option.disabled = true;
            });
            
            // Enable next button
            const nextButton = document.getElementById('nextButton');
            nextButton.disabled = false;
            nextButton.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        // Move to next question
        function nextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }

        // Show quiz results
        function showResults() {
            showSection('resultsSection');
            
            const totalQuestions = currentQuestions.length;
            const correctCount = userAnswers.filter(answer => answer.isCorrect).length;
            const totalPoints = userAnswers.reduce((sum, answer) => sum + answer.points, 0);
            
            // Update user stats
            userStats.points += totalPoints;
            userStats.totalQuestionsAnswered += totalQuestions;
            userStats.correctAnswers += correctCount;
            
            // Level up logic
            const newLevel = Math.floor(userStats.points / 100) + 1;
            if (newLevel > userStats.level) {
                userStats.level = newLevel;
                showAchievement('üéâ', 'Level Up!', `You've reached Level ${newLevel}!`);
            }
            
            updateUserStats();
            
            // Display results
            document.getElementById('finalScore').textContent = `${correctCount} / ${totalQuestions}`;
            document.getElementById('pointsEarned').textContent = `+${totalPoints} Points`;
            
            // Result emoji and message
            let resultEmoji, resultMessage;
            const percentage = (correctCount / totalQuestions) * 100;
            
            if (percentage >= 90) {
                resultEmoji = 'üèÜ';
                resultMessage = 'Outstanding! You\'re a true smartbuddy!';
            } else if (percentage >= 80) {
                resultEmoji = 'üåü';
                resultMessage = 'Excellent work! Keep it up!';
            } else if (percentage >= 70) {
                resultEmoji = 'üëè';
                resultMessage = 'Good job! You\'re getting better!';
            } else if (percentage >= 50) {
                resultEmoji = 'üí™';
                resultMessage = 'Nice try! Practice makes perfect!';
            } else {
                resultEmoji = 'ü§ó';
                resultMessage = 'Don\'t give up! Every expert was once a beginner!';
            }
            
            document.getElementById('resultEmoji').textContent = resultEmoji;
            document.getElementById('resultMessage').textContent = resultMessage;
            
            // Generate AI feedback
            generateAIFeedback(correctCount, totalQuestions, userAnswers);
        }

        // Generate AI-powered feedback
        function generateAIFeedback(correct, total, answers) {
            const percentage = (correct / total) * 100;
            const difficultQuestions = answers.filter(a => !a.isCorrect && a.difficulty === 'challenging');
            const easyQuestions = answers.filter(a => a.isCorrect && a.difficulty === 'working-hard');
            
            let aiMessage = '';
            
            // Personalized analysis
            if (percentage >= 80) {
                aiMessage = `üéØ Fantastic performance! You're showing mastery in ${currentSubject}. `;
                if (easyQuestions.length > 0) {
                    aiMessage += `I noticed you excel at challenging questions - you're ready for more advanced material!`;
                } else {
                    aiMessage += `Your consistent accuracy shows strong understanding of the fundamentals.`;
                }
            } else if (percentage >= 60) {
                aiMessage = `üìà Good progress! You're building solid skills in ${currentSubject}. `;
                if (difficultQuestions.length > 0) {
                    aiMessage += `I see you had trouble with some harder questions. Let's practice those concepts more!`;
                } else {
                    aiMessage += `Focus on reviewing the basics and you'll see improvement quickly.`;
                }
            } else {
                aiMessage = `üå± Every expert was once a beginner! I can see you're learning. `;
                const commonMistakes = answers.filter(a => !a.isCorrect).map(a => currentQuestions[a.questionIndex]['Subject']);
                aiMessage += `Let's spend more time practicing ${currentSubject} fundamentals. You've got this!`;
            }
            
            // Add personalized recommendations
            aiMessage += `\\n\\nüí° My recommendation: `;
            if (percentage >= 90) {
                aiMessage += `Try a more advanced grade level or challenge yourself with mixed subjects!`;
            } else if (percentage >= 70) {
                aiMessage += `Practice 2-3 more quizzes in ${currentSubject} to reinforce your learning.`;
            } else {
                aiMessage += `Start with easier questions and gradually work up to build confidence.`;
            }
            
            document.getElementById('aiMessage').textContent = aiMessage;
        }

        // Show achievement popup
        function showAchievement(emoji, title, text) {
            document.getElementById('achievementEmoji').textContent = emoji;
            document.getElementById('achievementTitle').textContent = title;
            document.getElementById('achievementText').textContent = text;
            document.getElementById('achievementPopup').classList.remove('hidden');
        }

        function closeAchievement() {
            document.getElementById('achievementPopup').classList.add('hidden');
        }

        // Load and display rewards
        async function loadRewards() {
            // For now, show sample rewards. Later connect to Airtable Gifts table
            const sampleRewards = [
                { name: 'Sticker Pack', points: 250, emoji: 'üåü', description: 'Fun educational stickers' },
                { name: 'Coloring Book', points: 500, emoji: 'üé®', description: 'Creative learning activities' },
                { name: 'Puzzle Game', points: 750, emoji: 'üß©', description: '24-piece educational puzzle' },
                { name: 'LEGO Set', points: 1000, emoji: 'üß±', description: 'Building blocks for creativity' },
                { name: 'Science Kit', points: 1500, emoji: 'üî¨', description: 'Hands-on experiments' },
                { name: 'Art Supplies', points: 1200, emoji: 'üñçÔ∏è', description: 'Complete drawing set' }
            ];
            
            window.sampleRewards = sampleRewards;
        }

        function showRewards() {
            showSection('rewardsSection');
            
            const rewardsGrid = document.getElementById('rewardsGrid');
            const rewards = window.sampleRewards || [];
            
            rewardsGrid.innerHTML = rewards.map(reward => {
                const canAfford = userStats.points >= reward.points;
                return `
                    <div class="cartoon-card rounded-2xl p-6 text-center ${canAfford ? '' : 'opacity-60'}">
                        <div class="text-4xl mb-3">${reward.emoji}</div>
                        <h4 class="text-lg font-bold text-gray-800 mb-2">${reward.name}</h4>
                        <p class="text-sm text-gray-600 mb-3">${reward.description}</p>
                        <div class="text-2xl font-bold text-purple-600 mb-3">${reward.points} points</div>
                        <button onclick="redeemReward('${reward.name}', ${reward.points})" 
                                class="${canAfford ? 'fun-button' : 'bg-gray-300'} w-full py-2 px-4 rounded-lg text-white font-semibold" 
                                ${canAfford ? '' : 'disabled'}>
                            ${canAfford ? 'üéÅ Redeem' : 'üîí Need More Points'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        function redeemReward(name, points) {
            if (userStats.points >= points) {
                userStats.points -= points;
                updateUserStats();
                showAchievement('üéÅ', 'Reward Redeemed!', `You've earned a ${name}! It will be delivered soon.`);
                showRewards(); // Refresh the rewards display
            }
        }

        function showProgress() {
            const accuracy = userStats.totalQuestionsAnswered > 0 ? 
                Math.round((userStats.correctAnswers / userStats.totalQuestionsAnswered) * 100) : 0;
            
            alert(`üìä Your Progress:\\n\\nüéØ Accuracy: ${accuracy}%\\nüìö Questions Answered: ${userStats.totalQuestionsAnswered}\\n‚úÖ Correct Answers: ${userStats.correctAnswers}\\n‚≠ê Total Points: ${userStats.points}\\nüèÜ Current Level: ${userStats.level}\\nüî• Streak: ${userStats.streak} days`);
        }

        // Utility function to shuffle array
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Auto-test on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, testing Airtable connection...');
            setTimeout(testConnection, 2000);
        });
    </script>
</body>
</html>